<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ì—„ê°€ë„¤ POS</title>

  <style>
    :root{
      --bg:#0f1219;
      --panel:#121827;
      --card1:#1e2639;
      --card2:#242f4a;
      --line:rgba(255,255,255,.12);
      --text:#f7f9ff;
      --muted:rgba(247,249,255,.65);
      --accent:#ff9f00;
      --danger:#ff4d4f;
      --good:#2fd27e;
      --btn:#f4f5f7;
      --btnText:#111;
      --shadow:0 14px 44px rgba(0,0,0,.35);
      --r:20px;

      /* âœ… í•€+ì»¬ëŸ¬ í†µì¼ (í•€ ìƒí’ˆ í…Œë‘ë¦¬/ê·¸ë¦¼ì) */
      --pinBorder: rgba(255,159,0,.75);
      --pinGlow: rgba(255,159,0,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",system-ui,Segoe UI,Roboto,sans-serif;
    }
    button,input{font:inherit}
    button{border:none; background:none}

    .app{height:100%; display:grid; grid-template-columns:3fr 1fr; gap:14px; padding:14px}

    /* LEFT */
    .left{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column;
      min-width:0;
    }

    .topbar{
      display:flex; gap:10px; padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.02)
    }
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      padding:9px 14px; border-radius:999px; border:1px solid var(--line);
      background:#1d2332; color:var(--text);
      font-weight:1100; cursor:pointer;
      touch-action:manipulation;
    }
    .tab.active{background:rgba(255,159,0,.18); border-color:rgba(255,159,0,.55)}

    .searchwrap{padding:10px 12px; border-bottom:1px solid var(--line); background:rgba(255,255,255,.015)}
    .searchrow{display:flex; gap:10px; align-items:center}
    .search{
      flex:1; display:flex; align-items:center; gap:10px;
      background:rgba(255,255,255,.04); border:1px solid var(--line);
      border-radius:14px; padding:10px 12px;
      min-width:0;
    }
    .search .icon{opacity:.7}
    .search input{
      width:100%; border:none; outline:none; background:transparent;
      color:var(--text); font-weight:1000; font-size:15px;
      min-width:0;
    }

    .cho{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap}
    .cho button{
      padding:8px 10px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.03); color:var(--text);
      font-weight:1100; cursor:pointer; min-width:40px;
      touch-action:manipulation;
    }
    /* âœ… X ëŒ€ì‹  ë¹—ìë£¨(ğŸ§¹) + ë‹¤ë¥¸ ì»¬ëŸ¬ */
    .cho button.clear{
      background: rgba(255, 77, 79, .95) !important;
      border-color: rgba(255, 77, 79, 1) !important;
      color:#fff !important;
      font-weight:1400 !important;
      box-shadow:0 6px 18px rgba(255,77,79,.25) !important;
      min-width:44px;
    }
    .cho button.clear:active{transform:scale(.98)}

    /* âœ… ì „ì²´ê³µí†µê³ ì •: ìƒë‹¨ 1ì¤„(ê°€ë¡œ ìŠ¤í¬ë¡¤) */
    .pinbar{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.01);
    }
    .pinbarHead{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:8px;
      font-weight:1100;
      color:var(--muted);
    }
    .pinStrip{
      display:flex; gap:10px;
      overflow:auto;
      padding-bottom:6px;
      scroll-snap-type:x mandatory;
    }
    .pinChip{
      flex:0 0 auto;
      min-width:170px;
      scroll-snap-align:start;
      border-radius:16px;
      border:1px solid var(--pinBorder);
      background:linear-gradient(180deg, rgba(255,159,0,.12), rgba(255,255,255,.02));
      box-shadow:0 0 0 3px rgba(255,159,0,.10);
      padding:10px 12px;
      cursor:pointer;
      user-select:none;
      touch-action:manipulation;
      position:relative;
    }
    .pinChip .pname{font-size:16px; font-weight:1200; letter-spacing:-.2px}
    .pinChip .pprice{margin-top:6px; font-size:13px; font-weight:1100; opacity:.95}
    .pinChip .pinIcon{
      position:absolute; right:10px; top:10px;
      opacity:.95;
    }

    /* âœ… ìƒí’ˆëª©ë¡(ì‹¤ë¬´ì ìµœì í•´: ì¹´ë“œ ë†’ì´ ~92px) */
    .products{
      padding:12px;
      overflow:auto;
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:12px;
      min-width:0;
    }
    @media (min-width:1400px){ .products{grid-template-columns:repeat(5, minmax(0,1fr))} }

    .card{
      background:linear-gradient(180deg, var(--card2), var(--card1));
      border:1px solid rgba(255,255,255,.16);
      border-radius:18px;
      padding:14px 16px;
      min-height:92px;
      cursor:pointer;
      user-select:none;
      position:relative;
      touch-action:manipulation;
      overflow:hidden;
    }
    .card.flash{box-shadow:0 0 0 3px rgba(255,159,0,.45)}
    .card.pinned{
      border-color: var(--pinBorder);
      box-shadow:0 0 0 3px var(--pinGlow);
    }
    .name{font-size:20px; font-weight:1200; letter-spacing:-.2px; line-height:1.2}
    .price{margin-top:6px; font-size:16px; opacity:.95; font-weight:1100; line-height:1.15}
    .meta{
      position:absolute; right:10px; top:10px;
      display:flex; gap:8px; align-items:center; opacity:.95;
      transform:scale(.94); transform-origin:top right;
    }
    .badge{
      font-size:12px; padding:4px 8px; border-radius:999px;
      border:1px solid var(--line); background:rgba(255,255,255,.03);
      font-weight:1100;
    }
    .pin{
      width:28px; height:28px; display:grid; place-items:center;
      border-radius:10px; border:1px solid var(--line);
      background:rgba(0,0,0,.15);
    }
    .pin.on{border-color:var(--pinBorder); background:rgba(255,159,0,.18)}
    /* âœ… ë©”íƒ€ í´ë¦­ ê°€ë¡œì±„ì§€ ì•Šê²Œ */
    .meta, .meta *{pointer-events:none}

    .hint{
      padding:8px 12px 12px;
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      border-top:1px solid var(--line);
      background:rgba(255,255,255,.01);
    }

    /* RIGHT */
    .right{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column;
      min-width:0;
    }

    /* âœ… ì¥ë°”êµ¬ë‹ˆëŠ” ë³´ê¸° ì¢‹ê²Œ + ìŠ¤í¬ë¡¤ */
    .cart{
      padding:12px;
      overflow:auto;
      flex:1;
      min-height:240px;
    }
    .carthead{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:10px;
      font-weight:1200;
    }
    .carthead .muted{opacity:.7; font-weight:1000}

    .item{
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      margin-bottom:8px;
    }
    .item .title{font-weight:1200; font-size:14px}
    .item .sub{margin-top:4px; font-size:12px; opacity:.8; font-weight:900}

    .controls{display:flex; gap:8px; align-items:center}
    .ctrl{
      width:38px; height:36px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      font-weight:1300;
      cursor:pointer;
      touch-action:manipulation;
      white-space:nowrap;
      line-height:1;
    }
    /* âœ… ì‚­ì œ ë²„íŠ¼ ì¤„ë°”ê¿ˆ ë°©ì§€ + ëˆˆì— ë„ê²Œ */
    .ctrl.del{
      min-width:56px;
      padding:10px 14px;
      background:rgba(255,77,79,.22);
      border-color:rgba(255,77,79,.45);
      color:#ffecec;
      white-space:nowrap;
      line-height:1;
      word-break:keep-all;
    }
    .count{width:26px; text-align:center; font-weight:1300}

    .summary{
      padding:12px;
      border-top:1px solid var(--line);
      background:rgba(255,255,255,.015);
    }

    /* âœ… ì´í•©ê³„(ê°œìˆ˜) ê¸ˆì•¡ í•œì¤„ */
    .sumline{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
    }
    .sumText{
      font-size:14px; font-weight:1100; opacity:.75;
    }
    .sumValue{
      font-size:22px; font-weight:1400;
      letter-spacing:-.2px;
      white-space:nowrap;
    }

    /* âœ… ë°›ì€ëˆ/ê±°ìŠ¤ë¦„ëˆ í•œì¤„(ì¹¸ ì¶•ì†Œ) */
    .payline{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .payBox{
      display:flex;
      align-items:baseline;
      gap:8px;
      min-width:0;
      flex:1;
    }
    .payLabel{
      font-size:12px; opacity:.7; font-weight:1100; white-space:nowrap;
    }
    .payVal{
      font-size:18px; font-weight:1300; white-space:nowrap;
    }
    .divider{width:2px; height:20px; background:rgba(255,255,255,.14); border-radius:99px}

    /* âœ… ê±°ìŠ¤ë¦„ëˆ ë²„íŠ¼ (3ê°œì”© 2ì¤„) */
    .money{
      padding:12px;
      border-top:1px solid var(--line);
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
      background:rgba(255,255,255,.01);
    }
    .money button{
      padding:12px;
      border-radius:14px;
      font-size:16px;
      font-weight:1300;
      cursor:pointer;
      background:var(--btn);
      color:var(--btnText);
      touch-action:manipulation;
    }
    .money button.reset{
      background:rgba(255,77,79,.22);
      color:#ffe2e2;
    }

    .pay{
      margin:12px; margin-top:0;
      border-radius:16px;
      padding:16px;
      background:var(--accent);
      font-size:18px;
      font-weight:1400;
      cursor:pointer;
      touch-action:manipulation;
    }
    .pay.locked{opacity:.55; pointer-events:none}

    /* íŒì—… */
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:9999}
    .overlay.show{display:flex}
    .modal{
      width:min(520px,92vw);
      background:#161c28;
      border:1px solid rgba(255,255,255,.14);
      border-radius:20px; padding:18px;
      box-shadow:var(--shadow)
    }
    .modal h3{margin:0 0 8px; font-size:18px; font-weight:1300}
    .modal p{margin:0; opacity:.9; font-weight:1000}
    .modal .btns{display:flex; gap:10px; justify-content:flex-end; margin-top:14px}
    .modal button{padding:10px 14px; border-radius:14px; font-weight:1300; cursor:pointer}
    .modal .ok{background:var(--good); color:#082010}
    .modal .cancel{background:rgba(255,255,255,.08); color:var(--text)}

    /* í† ìŠ¤íŠ¸(ë””ë²„ê·¸/í™•ì¸ìš©) */
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.18);
      padding:10px 12px; border-radius:14px;
      font-weight:1100; z-index:10000;
      display:none; max-width:92vw;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .toast.show{display:block}
  </style>
</head>

<body>
<div class="app">

  <section class="left">
    <div class="topbar">
      <div class="tabs" id="tabs"></div>
    </div>

    <div class="searchwrap">
      <div class="searchrow">
        <div class="search">
          <span class="icon">ğŸ”</span>
          <input id="q" placeholder="ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±ã„±)" autocomplete="off" />
        </div>
      </div>
      <div class="cho" id="cho"></div>
    </div>

    <!-- âœ… ì „ì²´ ê³µí†µ ê³ ì •(ìƒë‹¨ 1ì¤„) -->
    <div class="pinbar" id="pinbar" style="display:none">
      <div class="pinbarHead">
        <div>ê³ ì •(ì „ì²´) â€” ìƒë‹¨ 1ì¤„</div>
        <div style="opacity:.8">ê¸¸ê²Œëˆ„ë¥´ê¸°/ìš°í´ë¦­ìœ¼ë¡œ ê³ ì •</div>
      </div>
      <div class="pinStrip" id="pinStrip"></div>
    </div>

    <div class="products" id="products"></div>
    <div class="hint">
      â€» ìƒí’ˆ ê³ ì •(ì „ì²´ ê³µí†µ): ê¸¸ê²Œ ëˆ„ë¥´ê¸°(ëª¨ë°”ì¼) / ìš°í´ë¦­(PC).<br/>
      â€» ê²€ìƒ‰ì€ ì¹´í…Œê³ ë¦¬ ë¬´ê´€ + ì´ˆì„±(ã„±ã„´ã„·)ë„ ë©ë‹ˆë‹¤.
    </div>
  </section>

  <section class="right">
    <div class="cart" id="cart"></div>

    <div class="summary">
      <div class="sumline">
        <div class="sumText" id="sumText">ì´í•©ê³„(0ê°œ)</div>
        <div class="sumValue" id="sumValue">0ì›</div>
      </div>

      <div class="payline">
        <div class="payBox">
          <div class="payLabel">ë°›ì€ëˆ</div>
          <div class="payVal" id="received">0ì›</div>
        </div>
        <div class="divider"></div>
        <div class="payBox" style="justify-content:flex-end">
          <div class="payLabel">ê±°ìŠ¤ë¦„ëˆ</div>
          <div class="payVal" id="change">0ì›</div>
        </div>
      </div>
    </div>

    <div class="money">
      <button data-add="500">500</button>
      <button data-add="1000">1ì²œ</button>
      <button data-add="5000">5ì²œ</button>
      <button data-add="10000">1ë§Œ</button>
      <button data-add="50000">5ë§Œ</button>
      <button class="reset" id="reset">ì´ˆê¸°í™”</button>
    </div>

    <button class="pay" id="pay">ê²°ì œì™„ë£Œ</button>
  </section>
</div>

<div class="overlay" id="overlay">
  <div class="modal">
    <h3>ê²°ì œ ì™„ë£Œ</h3>
    <p id="modalText">ì •ë§ ê²°ì œì™„ë£Œ ì²˜ë¦¬í• ê¹Œìš”?</p>
    <div class="btns">
      <button class="cancel" id="cancelBtn">ì·¨ì†Œ</button>
      <button class="ok" id="okBtn">í™•ì¸</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- âœ… êµ¬ê¸€ì‹œíŠ¸ â†’ items.jsë¡œ ì—°ê²°í•  ê±°ë©´ ì´ íŒŒì¼ì„ ìœ ì§€ -->
<script src="./items.js?v=1"></script>

<script>
/* JS ì—ëŸ¬ ì¦‰ì‹œ ì•Œë¦¼ */
window.addEventListener("error", (e)=>{ alert("JSì˜¤ë¥˜: " + (e?.message || e)); });

/* ===== 0) ì¹´í…Œê³ ë¦¬ ===== */
const CATS = ["ê³¼ì¼","ì•¼ì±„","ë´‰ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];

/* ===== 1) ìƒí’ˆ ë°ì´í„° ë¡œë“œ =====
   - items.jsì—ì„œ window.ITEMS = [{id,cat,name,price,active}, ...]ë¥¼ ë„£ì–´ë‘ë©´ ìë™ ë°˜ì˜
   - ì—†ìœ¼ë©´ ì•„ë˜ ìƒ˜í”Œë¡œ ë™ì‘(í…ŒìŠ¤íŠ¸ìš©)
*/
const FALLBACK_ITEMS = [
  {id:"banana", cat:"ê³¼ì¼", name:"ë°”ë‚˜ë‚˜", price:2500, active:1},
  {id:"tomato", cat:"ê³¼ì¼", name:"í† ë§ˆí† ", price:10000, active:1},
  {id:"potato", cat:"ì•¼ì±„", name:"ê°ì", price:3000, active:1},
  {id:"onion", cat:"ì•¼ì±„", name:"ì–‘íŒŒ", price:2500, active:1},
  {id:"spinach", cat:"ë´‰ì±„ì†Œ", name:"ì‹œê¸ˆì¹˜/1ë´‰ì§€", price:2000, active:1},
  {id:"mackerel", cat:"ìƒì„ ", name:"ê³ ë“±ì–´/1ë§ˆë¦¬", price:3500, active:1},
  {id:"egg", cat:"ê¸°íƒ€", name:"ê³„ë€", price:6000, active:1},
];

function normalizeItems(raw){
  const out = [];
  const seen = new Set();
  for(const it of (raw||[])){
    if(!it) continue;
    const id = String(it.id || "").trim();
    if(!id) continue;
    if(seen.has(id)) continue; // âœ… id ì¤‘ë³µ ë°©ì§€
    seen.add(id);
    out.push({
      id,
      cat: String(it.cat||"ê¸°íƒ€").trim(),
      name: String(it.name||"").trim(),
      price: Number(it.price||0),
      active: Number(it.active ?? 1)
    });
  }
  return out;
}

let PRODUCTS = normalizeItems(window.ITEMS && Array.isArray(window.ITEMS) ? window.ITEMS : FALLBACK_ITEMS)
  .filter(p => p.active === 1 && p.name && p.price >= 0);

/* ì¹´í…Œê³ ë¦¬ ìœ íš¨ì„± ë³´ì • */
PRODUCTS = PRODUCTS.map(p=>{
  if(!CATS.includes(p.cat)) p.cat="ê¸°íƒ€";
  return p;
});

const productMap = Object.fromEntries(PRODUCTS.map(p=>[p.id,p]));

/* ===== 2) ë¡œì»¬ ì €ì¥ =====
   - ê³ ì •í•€(ì „ì²´ ê³µí†µ): globalPinned
   - ì‚¬ìš©íšŸìˆ˜: used
   - ë§ˆì§€ë§‰ ì¹´í…Œê³ ë¦¬: lastCat
*/
const LS_KEY="umgane_pos_state_v123";
const state = (()=>{ try{
  const s=JSON.parse(localStorage.getItem(LS_KEY)||"{}");
  return {
    globalPinned: Array.isArray(s.globalPinned) ? s.globalPinned : [],
    used: s.used || {},
    lastCat: s.lastCat || "ê³¼ì¼",
  };
}catch(_){
  return { globalPinned:[], used:{}, lastCat:"ê³¼ì¼" };
}})();
const saveState=()=>localStorage.setItem(LS_KEY, JSON.stringify(state));

/* ===== 3) ëŸ°íƒ€ì„ ìƒíƒœ ===== */
const cart = {};
let activeCat = state.lastCat;
let q = "";
let received = 0;
let payLocked = false;

/* âœ… ì—°íƒ€ ë°©ì§€ */
let tapLock=false;
function lockTap(ms=120){
  tapLock=true;
  setTimeout(()=>tapLock=false, ms);
}

/* ===== 4) DOM ===== */
const tabsEl = document.getElementById("tabs");
const productsEl = document.getElementById("products");
const cartEl = document.getElementById("cart");
const toastEl = document.getElementById("toast");
const pinbarEl = document.getElementById("pinbar");
const pinStripEl = document.getElementById("pinStrip");

function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(toastEl._t);
  toastEl._t=setTimeout(()=>toastEl.classList.remove("show"), 900);
}

/* ===== 5) ì´ˆì„± ê²€ìƒ‰ ===== */
const CHO=["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
function getChosung(str){
  let out="";
  for(const ch of str){
    const code=ch.charCodeAt(0);
    if(code>=0xAC00 && code<=0xD7A3){
      out+=CHO[Math.floor((code-0xAC00)/588)]||"";
    }else out+=ch;
  }
  return out;
}
function matchQuery(p, query){
  const t=(query||"").trim();
  if(!t) return true;
  const name=p.name.replace(/\s/g,"");
  const tl=t.toLowerCase().replace(/\s/g,"");
  if(name.toLowerCase().includes(tl)) return true;
  if(getChosung(name).includes(tl)) return true;
  return false;
}

/* ===== 6) ê³ ì •í•€(ì „ì²´ ê³µí†µ) ===== */
const PIN_MAX = 8; // âœ… ìƒë‹¨ 1ì¤„ ì œí•œ (ìµœëŒ€ 8ê°œ)

function getGlobalPinned(){
  // ì¡´ì¬í•˜ëŠ” ìƒí’ˆë§Œ ë‚¨ê¸°ê¸°
  state.globalPinned = (state.globalPinned||[]).filter(id => !!productMap[id]);
  // ê¸¸ì´ ì œí•œ
  state.globalPinned = state.globalPinned.slice(0, PIN_MAX);
  return state.globalPinned;
}
function isPinned(id){
  return getGlobalPinned().includes(id);
}
function togglePin(id){
  id = String(id);
  const arr = getGlobalPinned().slice();
  const idx = arr.indexOf(id);
  if(idx>=0) arr.splice(idx,1);
  else {
    arr.unshift(id);           // âœ… ìƒˆë¡œ ê³ ì •í•˜ë©´ ë§¨ ì•
    if(arr.length > PIN_MAX) arr.length = PIN_MAX;
  }
  state.globalPinned = arr;
  saveState();
  renderPinbar();
  renderProducts();
}

/* ê¸¸ê²Œ ëˆ„ë¥´ê¸°(ëª¨ë°”ì¼) / ìš°í´ë¦­(PC) */
function attachPinHandlers(el, id){
  let pressTimer=null;
  el.addEventListener("touchstart", ()=>{
    pressTimer=setTimeout(()=>{
      el.dataset.suppress="1";
      togglePin(id);
      setTimeout(()=>{delete el.dataset.suppress;}, 350);
    }, 450);
  }, {passive:true});
  el.addEventListener("touchend", ()=>{ if(pressTimer) clearTimeout(pressTimer); pressTimer=null; });
  el.addEventListener("contextmenu",(e)=>{ e.preventDefault(); togglePin(id); });
}

/* ===== 7) ìƒí’ˆ ë¦¬ìŠ¤íŠ¸/ì •ë ¬ =====
   âœ… ì‹¤ë¬´ì ìµœì : ê³ ì •í•€ì€ ìƒë‹¨ 1ì¤„(í•€ë°”)ì—ì„œ í•­ìƒ ë…¸ì¶œ
   âœ… ì•„ë˜ ê·¸ë¦¬ë“œì—ì„œëŠ”:
      - ê²€ìƒ‰ ì¤‘ì´ë©´(ì¹´í…Œê³ ë¦¬ ë¬´ê´€) ê²€ìƒ‰ê²°ê³¼ë¥¼ used ë‚´ë¦¼ì°¨ìˆœ
      - ê²€ìƒ‰ ì•„ë‹ˆë©´ í˜„ì¬ ì¹´í…Œê³ ë¦¬ ìƒí’ˆì„ used ë‚´ë¦¼ì°¨ìˆœ
   âœ… ì´ë¦„ìˆœì€ ë§ˆì§€ë§‰ tie-breakë§Œ
*/
function sortedByUsed(list){
  return list.slice().sort((a,b)=>{
    const au = state.used[a.id]||0;
    const bu = state.used[b.id]||0;
    if(au!==bu) return bu-au;
    return a.name.localeCompare(b.name,"ko");
  });
}

function currentProducts(){
  const query = q.trim();
  if(query){
    return sortedByUsed(PRODUCTS.filter(p=>matchQuery(p,query)));
  }
  return sortedByUsed(PRODUCTS.filter(p=>p.cat===activeCat));
}

/* ===== 8) ë Œë” ===== */
function renderTabs(){
  tabsEl.innerHTML="";
  CATS.forEach(cat=>{
    const b=document.createElement("button");
    b.className="tab"+(cat===activeCat?" active":"");
    b.textContent=cat;
    b.onclick=()=>{ activeCat=cat; state.lastCat=cat; saveState(); renderProducts(); };
    tabsEl.appendChild(b);
  });
}

function renderPinbar(){
  const pins = getGlobalPinned();
  if(!pins.length){
    pinbarEl.style.display="none";
    pinStripEl.innerHTML="";
    return;
  }
  pinbarEl.style.display="block";
  pinStripEl.innerHTML="";
  pins.forEach(id=>{
    const p = productMap[id];
    const d = document.createElement("div");
    d.className="pinChip";
    d.dataset.id=id;
    d.innerHTML=`
      <div class="pinIcon">ğŸ“Œ</div>
      <div class="pname">${p.name}</div>
      <div class="pprice">${p.price.toLocaleString()}ì›</div>
    `;
    attachPinHandlers(d, id);
    d.addEventListener("pointerdown",(e)=>{
      if(tapLock) return;
      if(d.dataset.suppress==="1") return;
      lockTap(120);
      addToCart(id,1);
      flash(d);
    });
    pinStripEl.appendChild(d);
  });
}

function renderProducts(){
  productsEl.innerHTML="";
  const list = currentProducts();

  list.forEach(p=>{
    const d=document.createElement("div");
    const pinned = isPinned(p.id);
    d.className="card" + (pinned ? " pinned" : "");
    d.dataset.id=p.id;

    const used=state.used[p.id]||0;

    d.innerHTML=`
      <div class="meta">
        <span class="badge">ì‚¬ìš© ${used}</span>
        <span class="pin ${pinned?"on":""}">ğŸ“Œ</span>
      </div>
      <div class="name">${p.name}</div>
      <div class="price">${p.price.toLocaleString()}ì›</div>
    `;

    attachPinHandlers(d, p.id);
    productsEl.appendChild(d);
  });
}

function updateUsedBadge(id){
  const card = productsEl.querySelector(`.card[data-id="${CSS.escape(id)}"]`);
  if(!card) return;
  const badge = card.querySelector(".badge");
  if(badge) badge.textContent = "ì‚¬ìš© " + (state.used[id]||0);
}

function flash(el){
  el.classList.add("flash");
  setTimeout(()=>el.classList.remove("flash"), 140);
}

/* ë‹´ê¸°: pointerdown */
productsEl.addEventListener("pointerdown",(e)=>{
  if(tapLock) return;
  const card = e.target.closest(".card");
  if(!card) return;
  if(card.dataset.suppress==="1") return;

  const id = card.dataset.id;
  const p = productMap[id];
  if(!p){ alert("ìƒí’ˆID ì˜¤ë¥˜: "+id); return; }

  lockTap(120);
  addToCart(id,1);
  flash(card);
});

/* ===== 9) ì¥ë°”êµ¬ë‹ˆ ===== */
function addToCart(id,n){
  cart[id]=(cart[id]||0)+n;
  if(cart[id]<=0) delete cart[id];

  if(n>0){
    state.used[id]=(state.used[id]||0)+1;
    saveState();
    updateUsedBadge(id);
  }
  renderCart();
}

function sumCart(){
  let sum=0, qty=0;
  for(const id in cart){
    const p=productMap[id];
    sum += p.price*cart[id];
    qty += cart[id];
  }
  return {sum,qty};
}

function renderCart(){
  const {sum,qty}=sumCart();

  // âœ… ì´í•©ê³„(ê°œìˆ˜) ê¸ˆì•¡ í‘œê¸°
  document.getElementById("sumText").textContent = `ì´í•©ê³„(${qty}ê°œ)`;
  document.getElementById("sumValue").textContent = `${sum.toLocaleString()}ì›`;

  // âœ… ë°›ì€ëˆ/ê±°ìŠ¤ë¦„ëˆ(í•œì¤„)
  document.getElementById("received").textContent = `${received.toLocaleString()}ì›`;
  document.getElementById("change").textContent = `${Math.max(0,received-sum).toLocaleString()}ì›`;

  cartEl.innerHTML=`
    <div class="carthead">
      <div>ì¥ë°”êµ¬ë‹ˆ <span class="muted">(ìˆ˜ëŸ‰ ì¡°ì ˆ + ì‚­ì œ)</span></div>
      <div class="muted">í•­ëª© ${Object.keys(cart).length}</div>
    </div>
  `;

  Object.keys(cart).forEach(id=>{
    const p=productMap[id], qn=cart[id];
    const item=document.createElement("div");
    item.className="item";
    item.innerHTML=`
      <div>
        <div class="title">${p.name} <span style="opacity:.7">x${qn}</span></div>
        <div class="sub">${p.price.toLocaleString()}ì› Â· í•© ${(p.price*qn).toLocaleString()}ì›</div>
      </div>
      <div class="controls">
        <button class="ctrl" data-act="minus">-</button>
        <div class="count">${qn}</div>
        <button class="ctrl" data-act="plus">+</button>
        <button class="ctrl del" data-act="del">âœ•</button>
      </div>
    `;
    item.querySelector('[data-act="minus"]').onclick=()=>addToCart(id,-1);
    item.querySelector('[data-act="plus"]').onclick =()=>addToCart(id, 1);
    item.querySelector('[data-act="del"]').onclick  =()=>{ delete cart[id]; renderCart(); };
    cartEl.appendChild(item);
  });
}

/* ===== 10) ë°›ì€ëˆ ë²„íŠ¼ ===== */
document.querySelectorAll('.money button[data-add]').forEach(b=>{
  b.onclick=()=>{ received += Number(b.dataset.add); renderCart(); };
});
document.getElementById("reset").onclick=()=>{ received=0; renderCart(); };

/* âœ… ìƒˆë¡œê³ ì¹¨/F5/ì¬ì ‘ì† ì‹œ: ì¥ë°”êµ¬ë‹ˆ+ë°›ì€ëˆë§Œ ë¦¬ì…‹ (ê³ ì •í•€/ì‚¬ìš©íšŸìˆ˜ ìœ ì§€) */
function resetCartAndReceivedOnly(){
  for (const id in cart) delete cart[id];
  received = 0;
}
window.addEventListener("pageshow", () => {
  resetCartAndReceivedOnly();
  renderCart();
});

/* ===== 11) ê²°ì œ íŒì—… + ì†Œë¦¬ + 1ì´ˆ ì ê¸ˆ ===== */
const overlay=document.getElementById("overlay");
const payBtn=document.getElementById("pay");
const okBtn=document.getElementById("okBtn");
const cancelBtn=document.getElementById("cancelBtn");
const modalText=document.getElementById("modalText");

function beep(){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type="sine"; o.frequency.value=880; g.gain.value=0.06;
    o.connect(g); g.connect(ctx.destination);
    o.start(); setTimeout(()=>{o.stop(); ctx.close();},120);
  }catch(_){}
}

payBtn.onclick=()=>{
  if(payLocked) return;
  const {sum,qty}=sumCart();
  modalText.textContent = qty===0 ? "ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤." : `ì´í•©ê³„(${qty}ê°œ) ${sum.toLocaleString()}ì› Â· ê²°ì œì™„ë£Œ ì²˜ë¦¬í• ê¹Œìš”?`;
  overlay.classList.add("show"); beep();
};
cancelBtn.onclick=()=>overlay.classList.remove("show");
okBtn.onclick=()=>{
  overlay.classList.remove("show"); beep();
  payLocked=true; payBtn.classList.add("locked");
  setTimeout(()=>{
    resetCartAndReceivedOnly();
    renderCart();
    payLocked=false; payBtn.classList.remove("locked");
  },1000);
};

/* ===== 12) ê²€ìƒ‰/ì´ˆì„± ë²„íŠ¼ ===== */
const qEl=document.getElementById("q");
qEl.addEventListener("input",()=>{ q=qEl.value; renderProducts(); });

const choEl=document.getElementById("cho");
const choKeys=["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
choEl.innerHTML="";
choKeys.forEach(k=>{
  const b=document.createElement("button");
  b.textContent=k;
  b.onclick=()=>{ qEl.value=qEl.value+k; q=qEl.value; renderProducts(); qEl.focus(); };
  choEl.appendChild(b);
});
const clear=document.createElement("button");
clear.className="clear";
clear.textContent="ğŸ§¹";
clear.title="ê²€ìƒ‰ ì§€ìš°ê¸°";
clear.onclick=()=>{ qEl.value=""; q=""; renderProducts(); qEl.focus(); };
choEl.appendChild(clear);

/* ===== 13) ì´ˆê¸° ë Œë” ===== */
renderTabs();
renderPinbar();
renderProducts();
renderCart();
</script>

</body>
</html>
