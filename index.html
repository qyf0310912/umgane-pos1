<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ì—„ê°€ë„¤ POS</title>
  <style>
    :root{
      --bg:#0b0c10;
      --panel:#111319;
      --panel2:#0f1116;
      --line:rgba(255,255,255,.10);
      --text:#f5f7ff;
      --muted:rgba(245,247,255,.62);
      --accent:#ff9f00;
      --accent2:#ffd37a;
      --danger:#ff3b30;
      --danger2:#ff6b61;
      --shadow:0 12px 40px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box;}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 10% 0%, rgba(255,159,0,.10), transparent 55%), var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial;}
    button,input{font-family:inherit;}
    .wrap{height:100%; padding:14px;}
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 1fr 420px;
      gap:14px;
    }
    @media (max-width: 980px){
      .app{grid-template-columns:1fr; grid-template-rows:auto 1fr;}
    }

    .left,.right{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .left{display:flex; flex-direction:column; min-height:0;}
    .right{display:flex; flex-direction:column; min-height:0;}

    /* ===== íƒ­ ===== */
    .tabs{
      display:flex; gap:10px;
      padding:14px 14px 10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .tab{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20);
      color:var(--text);
      padding:9px 14px;
      border-radius:999px;
      font-weight:800;
      letter-spacing:-.2px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      border-color:rgba(255,159,0,.55);
      box-shadow:0 0 0 3px rgba(255,159,0,.12) inset;
      color:#ffe7bd;
    }

    /* ===== ê²€ìƒ‰ ===== */
    .searchRow{
      padding:0 14px 10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    .searchBox{
      position:relative;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px 12px 10px 40px;
    }
    .searchBox:before{
      content:"ğŸ”";
      position:absolute; left:12px; top:9px;
      opacity:.65;
    }
    #q{
      width:100%;
      background:transparent;
      border:0; outline:none;
      color:var(--text);
      font-weight:700;
      letter-spacing:-.2px;
    }
    .sortBtn{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:800;
      cursor:pointer;
      white-space:nowrap;
    }

    /* ===== ì´ˆì„± ë²„íŠ¼ ===== */
    .choRow{
      padding:0 14px 10px;
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center;
    }
    .choRow button{
      width:40px; height:34px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      opacity:.95;
    }
    .choRow button.xKey{
      color:#fff;
      border-color:rgba(255,59,48,.45);
      background:rgba(255,59,48,.18);
    }
    .choRow button.clear{
      width:44px;
      border-color:rgba(255,59,48,.45);
      background:rgba(255,59,48,.18);
      color:#fff;
      font-size:18px;
    }

    .hint{
      padding:0 14px 12px;
      font-size:12.5px;
      color:var(--muted);
      line-height:1.45;
    }

    /* ===== ê³ ì •(í•€) ìƒë‹¨ 1ì¤„ ===== */
    .pinWrap{
      padding:0 14px 10px;
    }
    .pinTitle{
      display:flex; justify-content:space-between; align-items:flex-end;
      padding:0 2px 8px;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }
    .pinStrip{
      display:flex;
      gap:10px;
      overflow-x:auto;
      padding:10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      scrollbar-width:thin;
    }
    .pinCard{
      flex:0 0 auto;
      width:118px;               /* ì»´íŒ©íŠ¸: í•œ ì¤„ì— ë§ì´ ë³´ì´ê²Œ */
      height:56px;               /* ë‹¤ë¥¸ ì¹´ë“œì˜ â€œë°˜ ì •ë„â€ ëŠë‚Œ */
      border-radius:14px;
      border:2px solid rgba(255,159,0,.55); /* âœ… í•€+ì»¬ëŸ¬ í†µì¼(í…Œë‘ë¦¬) */
      background:linear-gradient(180deg, rgba(255,159,0,.10), rgba(0,0,0,.10));
      padding:10px 10px 8px;
      cursor:pointer;
      position:relative;
    }
    .pinCard .n{
      font-size:14px;
      font-weight:1000;
      letter-spacing:-.4px;
      line-height:1.05;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .pinCard .p{
      font-size:12px;
      opacity:.62;
      font-weight:700;
      margin-top:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pinCard .pinIcon{
      position:absolute;
      right:8px; top:8px;
      font-size:14px;
      opacity:.9;
    }

    /* ===== ìƒí’ˆ ì¹´ë“œ ===== */
    .products{
      padding:0 14px 14px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
      overflow:auto;
      min-height:0;
    }
    @media (max-width: 980px){
      .products{grid-template-columns: repeat(2, minmax(0,1fr));}
    }
    .card{
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(87,126,255,.10), rgba(0,0,0,.08));
      border-radius:18px;
      padding:16px;
      cursor:pointer;
      position:relative;
      user-select:none;
      min-height:86px;
    }
    .card.pinned{
      border:2px solid rgba(255,159,0,.55);            /* âœ… í•€+ì»¬ëŸ¬ í†µì¼ */
      box-shadow:0 0 0 3px rgba(255,159,0,.10) inset;
    }
    .card .name{
      font-size:22px;
      font-weight:1000;
      letter-spacing:-.5px;
      line-height:1.05;
    }
    .card .price{
      margin-top:8px;
      font-size:14px;
      opacity:.62;
      font-weight:800;
    }
    .badge{
      position:absolute;
      right:12px; top:12px;
      font-size:11px;
      opacity:.70;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      padding:4px 8px;
      border-radius:999px;
      font-weight:900;
    }
    .pinBtn{
      position:absolute;
      right:12px; bottom:12px;
      width:34px; height:28px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);
      color:#fff;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size:14px;
      opacity:.95;
    }
    .card.pinned .pinBtn{
      border-color:rgba(255,159,0,.55);
      background:rgba(255,159,0,.14);
    }

    /* ===== ì˜¤ë¥¸ìª½: ì¥ë°”êµ¬ë‹ˆ ===== */
    .rightTop{
      padding:14px 14px 10px;
      display:flex; justify-content:space-between; align-items:center;
      font-weight:1000;
      letter-spacing:-.4px;
    }
    .rightTop .sub{
      font-weight:900;
      opacity:.70;
      font-size:12px;
    }

    .cart{
      margin:0 14px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      padding:10px;
      min-height:0;
      flex:1;
      overflow:auto; /* âœ… ê¸¸ì–´ì§€ë©´ ìŠ¤í¬ë¡¤ */
    }
    .cartHead{
      display:flex; justify-content:space-between; align-items:center;
      padding:8px 8px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      margin-bottom:10px;
    }
    .cartHead .title{
      font-weight:1000;
      letter-spacing:-.4px;
    }
    .cartHead .meta{
      font-size:12px;
      font-weight:900;
      opacity:.70;
    }

    .item{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:10px 8px;
      border-bottom:1px dashed rgba(255,255,255,.10);
      align-items:center;
    }
    .item:last-child{border-bottom:0;}

    /* âœ… ìƒí’ˆëª…ì´ ë” í¬ê³ , ê°€ê²©ì€ ë” ì–‡ê³  íë¦¬ê²Œ */
    .item .t{
      font-size:17px;
      font-weight:1000;
      letter-spacing:-.3px;
      line-height:1.1;
    }
    .item .t .q{
      font-size:13px;
      font-weight:900;
      opacity:.70;
      margin-left:6px;
    }
    .item .sub{
      margin-top:6px;
      font-size:12px;
      opacity:.55;
      font-weight:750;
    }

    .ctrls{
      display:flex; gap:8px; align-items:center;
    }
    .ctrls button{
      width:36px; height:32px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:#fff;
      font-weight:1000;
      cursor:pointer;
    }
    .ctrls .del{
      width:40px;
      border-color:rgba(255,59,48,.35);
      background:rgba(255,59,48,.18);
      color:#fff;
      font-size:18px;           /* âœ… ì‚­ì œë²„íŠ¼ ì´ìƒí•˜ë˜ ê±° ì •ë¦¬ */
      line-height:1;
    }

    .summary{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.015);
    }

    /* âœ… ì´í•©ê³„(9ê°œ) 47,500ì› : í†µì¼ + ì™¼ìª½ì •ë ¬ */
    .sumline{
      display:flex;
      justify-content:flex-start;
      align-items:baseline;
      gap:10px;
    }
    .sumText{
      font-size:14px;
      font-weight:1000;
      opacity:.75;
      white-space:nowrap;
    }
    .sumValue{
      font-size:24px;
      font-weight:1100;
      letter-spacing:-.3px;
      white-space:nowrap;
    }

    /* âœ… ë°›ì€ëˆ/ê±°ìŠ¤ë¦„ëˆ í•œì¤„ + ì „ë¶€ ì™¼ìª½ì •ë ¬ + â€œ/â€ */
    .payline{
      display:flex;
      justify-content:flex-start;
      align-items:center;
      gap:14px;
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .payText{
      font-size:14px;
      font-weight:950;
      opacity:.85;
      white-space:nowrap;
    }
    .payText b{font-weight:1100; opacity:1;}
    .slash{
      opacity:.35;
      font-weight:1100;
    }

    .money{
      padding:0 14px 14px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .money button{
      border-radius:14px;
      padding:12px 10px;
      border:1px solid rgba(255,255,255,.12);
      background:#f3f4f6;
      color:#111;
      font-weight:1100;
      cursor:pointer;
    }
    .money button.reset{
      border-color:rgba(255,59,48,.35);
      background:rgba(255,59,48,.18);
      color:#fff;
    }

    .payBtn{
      margin:0 14px 14px;
      border-radius:16px;
      border:0;
      background:var(--accent);
      color:#111;
      padding:16px 14px;
      font-weight:1100;
      font-size:18px;
      cursor:pointer;
      box-shadow:0 10px 30px rgba(255,159,0,.18);
    }
    .payBtn.locked{opacity:.55; cursor:not-allowed;}

    /* ===== ê²°ì œ íŒì—… ===== */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999;
    }
    .overlay.show{display:flex;}
    .modal{
      width:min(520px, 96vw);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.14);
      border-radius:22px;
      box-shadow:0 20px 70px rgba(0,0,0,.5);
      padding:18px;
    }
    .modal h3{margin:0 0 10px; font-size:18px; letter-spacing:-.4px;}
    .modal p{margin:0 0 14px; opacity:.85; line-height:1.45;}
    .modal .row{display:flex; gap:10px; justify-content:flex-end;}
    .modal button{
      border-radius:14px;
      padding:12px 14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);
      color:#fff;
      font-weight:1000;
      cursor:pointer;
    }
    .modal button.ok{
      background:var(--accent);
      color:#111;
      border:0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="app">
      <!-- LEFT -->
      <section class="left">
        <div class="tabs" id="tabs"></div>

        <div class="searchRow">
          <div class="searchBox">
            <input id="q" placeholder="ì „ì²´ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±ã„´ã„·)" autocomplete="off" />
          </div>
          <button class="sortBtn" id="sortBtn">ì •ë ¬: ê³ ì • + ë§ì´ ì°íŒ ìˆœ</button>
        </div>

        <div class="choRow" id="cho"></div>

        <div class="pinWrap">
          <div class="pinTitle">
            <div>ê³ ì •(ì „ì²´ ê³µí†µ) Â· ìƒë‹¨ 1ì¤„</div>
            <div style="opacity:.8">ê¸¸ê²Œ ëˆ„ë¥´ê¸°(ëª¨ë°”ì¼) / ìš°í´ë¦­(PC)ë¡œ ê³ ì •</div>
          </div>
          <div class="pinStrip" id="pinStrip"></div>
        </div>

        <div class="hint">
          â€» ê²€ìƒ‰ì€ ì¹´í…Œê³ ë¦¬ ë¬´ê´€ + ì´ˆì„±(ã„±ã„´ã„·)ë„ ë©ë‹ˆë‹¤.<br/>
          â€» F5/ìƒˆë¡œê³ ì¹¨ ì‹œ: ì¥ë°”êµ¬ë‹ˆ+ë°›ì€ëˆë§Œ ë¦¬ì…‹(ê³ ì •/ì‚¬ìš©íšŸìˆ˜ ìœ ì§€)
        </div>

        <div class="products" id="products"></div>
      </section>

      <!-- RIGHT -->
      <section class="right">
        <div class="rightTop">
          <div>ì¥ë°”êµ¬ë‹ˆ</div>
          <div class="sub" id="cartMeta">í•­ëª© 0</div>
        </div>

        <div class="cart" id="cart"></div>

        <div class="summary">
          <div class="sumline">
            <div class="sumText" id="sumText">ì´í•©ê³„(0ê°œ)</div>
            <div class="sumValue" id="sumValue">0ì›</div>
          </div>

          <div class="payline">
            <div class="payText">ë°›ì€ëˆ <b id="received">0ì›</b></div>
            <div class="slash">/</div>
            <div class="payText">ê±°ìŠ¤ë¦„ëˆ <b id="change">0ì›</b></div>
          </div>
        </div>

        <div class="money">
          <button data-add="500">500</button>
          <button data-add="1000">1ì²œ</button>
          <button data-add="5000">5ì²œ</button>
          <button data-add="10000">1ë§Œ</button>
          <button data-add="50000">5ë§Œ</button>
          <button class="reset" id="reset">ğŸ§¹ ì´ˆê¸°í™”</button>
        </div>

        <button class="payBtn" id="pay">ê²°ì œì™„ë£Œ</button>
      </section>
    </div>
  </div>

  <!-- ê²°ì œ íŒì—… -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <h3>ê²°ì œì™„ë£Œ í™•ì¸</h3>
      <p id="modalText">ê²°ì œë¥¼ ì™„ë£Œí• ê¹Œìš”?</p>
      <div class="row">
        <button id="cancelBtn">ì·¨ì†Œ</button>
        <button class="ok" id="okBtn">í™•ì¸</button>
      </div>
    </div>
  </div>

  <script>
    /* ===============================
       0) ìƒ˜í”Œ ìƒí’ˆ (ì—‘ì…€/ì‹œíŠ¸ ì—°ê²° ì „ ì„ì‹œ)
       =============================== */
    const ITEMS = [
      {id:"tomato", name:"í† ë§ˆí† ", price:10000, cat:"ì•¼ì±„"},
      {id:"banana", name:"ë°”ë‚˜ë‚˜", price:2500, cat:"ê³¼ì¼"},
      {id:"potato", name:"ê°ì", price:3000, cat:"ì•¼ì±„"},
      {id:"onion", name:"ì–‘íŒŒ", price:2500, cat:"ì•¼ì±„"},
      {id:"mackerel", name:"ê³ ë“±ì–´/1ë§ˆë¦¬", price:3500, cat:"ìƒì„ "},
      {id:"gim", name:"ê¹€", price:2000, cat:"ê¸°íƒ€"},
      {id:"scallion", name:"ë¶€ì¶”", price:2000, cat:"ë´‰ì±„ì†Œ"},
      {id:"lettuce", name:"ìƒì¶”", price:1500, cat:"ë´‰ì±„ì†Œ"},
    ];

    const CATS = ["ê³¼ì¼","ì•¼ì±„","ë´‰ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];
    let activeCat = CATS[0];

    /* ===============================
       1) ìƒíƒœ ì €ì¥ (ê³ ì •/ì‚¬ìš©íšŸìˆ˜/ì¥ë°”êµ¬ë‹ˆ/ë°›ì€ëˆ)
       =============================== */
    const LS_PIN = "umgane_pins_v1";
    const LS_USE = "umgane_use_v1";
    const LS_CART = "umgane_cart_v1";
    const LS_REC  = "umgane_received_v1";

    const pins = new Set(JSON.parse(localStorage.getItem(LS_PIN) || "[]"));
    const used = JSON.parse(localStorage.getItem(LS_USE) || "{}");
    let cart = JSON.parse(localStorage.getItem(LS_CART) || "{}");
    let received = Number(localStorage.getItem(LS_REC) || "0");

    const productMap = Object.fromEntries(ITEMS.map(p=>[p.id,p]));

    function saveState(){
      localStorage.setItem(LS_PIN, JSON.stringify([...pins]));
      localStorage.setItem(LS_USE, JSON.stringify(used));
      localStorage.setItem(LS_CART, JSON.stringify(cart));
      localStorage.setItem(LS_REC, String(received));
    }

    /* ===============================
       2) ìœ í‹¸ (ì´ˆì„±ê²€ìƒ‰)
       =============================== */
    const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
    function getChoChar(ch){
      const code = ch.charCodeAt(0);
      if(code < 0xAC00 || code > 0xD7A3) return ch;
      const uni = code - 0xAC00;
      const cho = Math.floor(uni / 588);
      return CHO[cho] || ch;
    }
    function toCho(str){
      return [...str].map(getChoChar).join("");
    }

    function fmt(n){ return n.toLocaleString()+"ì›"; }

    /* ===============================
       3) ë Œë”: íƒ­ / í•€ / ìƒí’ˆ
       =============================== */
    const tabsEl = document.getElementById("tabs");
    const pinStripEl = document.getElementById("pinStrip");
    const productsEl = document.getElementById("products");
    const qEl = document.getElementById("q");

    function renderTabs(){
      tabsEl.innerHTML = "";
      CATS.forEach(cat=>{
        const b = document.createElement("button");
        b.className = "tab" + (cat===activeCat ? " active":"");
        b.textContent = cat;
        b.onclick = ()=>{ activeCat = cat; renderProducts(); };
        tabsEl.appendChild(b);
      });
    }

    function score(p){
      const pinBoost = pins.has(p.id) ? 1e9 : 0;
      const use = used[p.id] || 0;
      return pinBoost + use;
    }

    function getQuery(){
      const q = (qEl.value||"").trim();
      return q;
    }

    function matchProduct(p, q){
      if(!q) return true;
      const name = p.name;
      const nameCho = toCho(name);
      const qCho = toCho(q);
      // ì¼ë°˜ í¬í•¨ or ì´ˆì„± í¬í•¨
      return name.includes(q) || nameCho.includes(q) || nameCho.includes(qCho);
    }

    function renderPinbar(){
      const pinnedItems = ITEMS
        .filter(p=>pins.has(p.id))
        .sort((a,b)=>score(b)-score(a));

      pinStripEl.innerHTML = "";

      if(pinnedItems.length===0){
        const d = document.createElement("div");
        d.style.opacity = ".55";
        d.style.fontWeight="900";
        d.style.padding="8px";
        d.textContent = "ê³ ì •ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. (ì¹´ë“œ ìš°í•˜ë‹¨ ğŸ“Œ)";
        pinStripEl.appendChild(d);
        return;
      }

      pinnedItems.forEach(p=>{
        const c = document.createElement("div");
        c.className = "pinCard";
        c.innerHTML = `
          <div class="pinIcon">ğŸ“Œ</div>
          <div class="n">${p.name}</div>
          <div class="p">${p.price.toLocaleString()}ì›</div>
        `;
        c.onclick = ()=> addToCart(p.id, 1, true);
        c.oncontextmenu = (e)=>{ e.preventDefault(); togglePin(p.id); };
        // ëª¨ë°”ì¼ ê¸¸ê²Œëˆ„ë¥´ê¸° ëŒ€ì²´(ê°„ë‹¨): ë”ë¸”í´ë¦­ë„ í—ˆìš©
        c.ondblclick = ()=> togglePin(p.id);
        pinStripEl.appendChild(c);
      });
    }

    function togglePin(id){
      if(pins.has(id)) pins.delete(id);
      else pins.add(id);
      saveState();
      renderPinbar();
      renderProducts();
    }

    function renderProducts(){
      const q = getQuery();

      // í˜„ì¬ ì¹´í…Œê³ ë¦¬ í•„í„° + ê²€ìƒ‰(ì¹´í…Œê³ ë¦¬ ë¬´ê´€ ê²€ìƒ‰ ìš”êµ¬ì˜€ì§€ë§Œ,
      // â€œì¹´í…Œê³ ë¦¬ ë¬´ê´€â€ì€ ê²€ìƒ‰ì‹œ ëª¨ë“  ìƒí’ˆì—ì„œ ì°¾ê³ , ë³´ì—¬ì¤„ ë• í˜„ì¬ ì¹´í…Œê³ ë¦¬ì—ì„œë„ ë°”ë¡œ ë³´ì´ê²Œ í•¨)
      const base = ITEMS.filter(p=> p.cat===activeCat);

      // ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ "ì¹´í…Œê³ ë¦¬ ë¬´ê´€"ìœ¼ë¡œ ë³´ì—¬ì£¼ê¸°
      const list = q ? ITEMS.slice() : base;

      const filtered = list.filter(p=> matchProduct(p, q));

      // ì •ë ¬: ê³ ì • ë¨¼ì € + ë§ì´ ì°íŒ ìˆœ
      filtered.sort((a,b)=>score(b)-score(a));

      productsEl.innerHTML = "";

      filtered.forEach(p=>{
        const div = document.createElement("div");
        div.className = "card" + (pins.has(p.id) ? " pinned":"");
        const useCnt = used[p.id] || 0;
        div.innerHTML = `
          <div class="badge">ì‚¬ìš© ${useCnt}</div>
          <div class="name">${p.name}</div>
          <div class="price">${p.price.toLocaleString()}ì›</div>
          <button class="pinBtn" title="ê³ ì •(ì „ì²´ ê³µí†µ)">ğŸ“Œ</button>
        `;
        div.onclick = (e)=>{
          // pin ë²„íŠ¼ í´ë¦­ì´ë©´ í† ê¸€ë§Œ
          const isPin = e.target && e.target.classList.contains("pinBtn");
          if(isPin){ togglePin(p.id); return; }

          addToCart(p.id, 1, true);
        };

        // ìš°í´ë¦­ ê³ ì •
        div.oncontextmenu = (e)=>{ e.preventDefault(); togglePin(p.id); };

        productsEl.appendChild(div);
      });

      if(filtered.length===0){
        const empty = document.createElement("div");
        empty.style.opacity=".65";
        empty.style.fontWeight="900";
        empty.style.padding="18px";
        empty.textContent = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
        productsEl.appendChild(empty);
      }
    }

    /* ===============================
       4) ì¥ë°”êµ¬ë‹ˆ / í•©ê³„ / ë°›ì€ëˆ
       =============================== */
    const cartEl = document.getElementById("cart");
    const sumTextEl = document.getElementById("sumText");
    const sumValueEl = document.getElementById("sumValue");
    const receivedEl = document.getElementById("received");
    const changeEl = document.getElementById("change");
    const cartMetaEl = document.getElementById("cartMeta");

    function addToCart(id, delta, countUse=false){
      const cur = cart[id] || 0;
      const next = Math.max(0, cur + delta);
      if(next===0) delete cart[id];
      else cart[id]=next;

      if(countUse){
        used[id] = (used[id]||0) + 1;
      }
      saveState();
      renderCart();
      renderProducts(); // ì‚¬ìš©íšŸìˆ˜ ë°°ì§€ ê°±ì‹ 
    }

    function sumCart(){
      let sum=0, qty=0;
      for(const id in cart){
        const p = productMap[id];
        if(!p) continue;
        sum += p.price * cart[id];
        qty += cart[id];
      }
      return {sum, qty};
    }

    function renderCart(){
      const {sum, qty} = sumCart();

      // âœ… ì´í•©ê³„(9ê°œ) + ê¸ˆì•¡ í†µì¼
      sumTextEl.textContent = `ì´í•©ê³„(${qty}ê°œ)`;
      sumValueEl.textContent = `${sum.toLocaleString()}ì›`;

      // âœ… ë°›ì€ëˆ/ê±°ìŠ¤ë¦„ëˆ í•œì¤„(ë°›ì€ëˆ 2ì¤„ ì œê±°)
      receivedEl.textContent = `${received.toLocaleString()}ì›`;
      changeEl.textContent = `${Math.max(0, received - sum).toLocaleString()}ì›`;

      // í—¤ë” í•­ëª©ìˆ˜
      cartMetaEl.textContent = `í•­ëª© ${Object.keys(cart).length}`;

      cartEl.innerHTML = `
        <div class="cartHead">
          <div class="title">ì¥ë°”êµ¬ë‹ˆ</div>
          <div class="meta">í•­ëª© ${Object.keys(cart).length}</div>
        </div>
      `;

      const keys = Object.keys(cart);
      if(keys.length===0){
        const d = document.createElement("div");
        d.style.opacity=".55";
        d.style.fontWeight="900";
        d.style.padding="12px 10px";
        d.textContent = "ë¹„ì–´ìˆìŒ";
        cartEl.appendChild(d);
        return;
      }

      keys.forEach(id=>{
        const p = productMap[id];
        const qn = cart[id];

        const item = document.createElement("div");
        item.className = "item";
        item.innerHTML = `
          <div>
            <div class="t">${p.name}<span class="q">x${qn}</span></div>
            <div class="sub">ë‹¨ê°€ ${p.price.toLocaleString()}ì› Â· í•© ${(p.price*qn).toLocaleString()}ì›</div>
          </div>
          <div class="ctrls">
            <button data-act="minus">â€“</button>
            <button data-act="plus">+</button>
            <button class="del" data-act="del">Ã—</button>
          </div>
        `;

        item.querySelector('[data-act="minus"]').onclick = ()=>addToCart(id, -1);
        item.querySelector('[data-act="plus"]').onclick  = ()=>addToCart(id,  1);
        item.querySelector('[data-act="del"]').onclick   = ()=>{
          delete cart[id];
          saveState();
          renderCart();
        };

        cartEl.appendChild(item);
      });
    }

    /* ===============================
       5) ë°›ì€ëˆ ë²„íŠ¼ / ì´ˆê¸°í™”(ğŸ§¹)
       =============================== */
    document.querySelectorAll(".money button[data-add]").forEach(b=>{
      b.onclick = ()=>{
        received += Number(b.dataset.add);
        saveState();
        renderCart();
      };
    });

    // âœ… ì´ˆê¸°í™” = ë°›ì€ëˆë§Œ ë¦¬ì…‹ (ì¥ë°”êµ¬ë‹ˆ ìœ ì§€)
    document.getElementById("reset").onclick = ()=>{
      received = 0;
      saveState();
      renderCart();
    };

    /* ===============================
       6) F5/ìƒˆë¡œê³ ì¹¨ ì‹œ: ì¥ë°”êµ¬ë‹ˆ+ë°›ì€ëˆë§Œ ë¦¬ì…‹ (ê³ ì •/ì‚¬ìš©íšŸìˆ˜ ìœ ì§€)
       =============================== */
    function resetCartAndReceivedOnly(){
      cart = {};
      received = 0;
      saveState();
    }
    window.addEventListener("pageshow", ()=>{
      resetCartAndReceivedOnly();
      renderCart();
    });

    /* ===============================
       7) ê²°ì œì™„ë£Œ íŒì—… + ì†Œë¦¬ + 1ì´ˆ ì ê¸ˆ
       =============================== */
    const overlay = document.getElementById("overlay");
    const payBtn  = document.getElementById("pay");
    const okBtn   = document.getElementById("okBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const modalText = document.getElementById("modalText");

    function beep(){
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type="sine"; o.frequency.value=880;
        g.gain.value=0.06;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
      }catch(_){}
    }

    let payLocked=false;

    payBtn.onclick = ()=>{
      if(payLocked) return;
      const {sum, qty} = sumCart();
      modalText.textContent = qty===0
        ? "ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤."
        : `ì´í•©ê³„(${qty}ê°œ) ${sum.toLocaleString()}ì› Â· ê²°ì œì™„ë£Œ ì²˜ë¦¬í• ê¹Œìš”?`;
      overlay.classList.add("show");
      beep(); // âœ… ê²°ì œì™„ë£Œ ëˆŒë €ì„ ë•Œ ì†Œë¦¬
    };
    cancelBtn.onclick = ()=> overlay.classList.remove("show");

    okBtn.onclick = ()=>{
      overlay.classList.remove("show");
      beep(); // í™•ì¸ ì†Œë¦¬
      payLocked=true;
      payBtn.classList.add("locked");

      setTimeout(()=>{
        resetCartAndReceivedOnly();
        renderCart();
        payLocked=false;
        payBtn.classList.remove("locked");
      }, 1000);
    };

    /* ===============================
       8) ê²€ìƒ‰/ì´ˆì„± ë²„íŠ¼
       =============================== */
    qEl.addEventListener("input", ()=> renderProducts());

    const choEl = document.getElementById("cho");
    const choKeys = ["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…","X"];
    choEl.innerHTML = "";
    choKeys.forEach(k=>{
      const b = document.createElement("button");
      b.textContent = k;
      if(k==="X") b.classList.add("xKey");
      b.onclick = ()=>{
        if(k==="X"){
          qEl.value = "";
        }else{
          qEl.value = (qEl.value || "") + k;
        }
        renderProducts();
        qEl.focus();
      };
      choEl.appendChild(b);
    });

    // âœ… ğŸ§¹ ê²€ìƒ‰ ì§€ìš°ê¸° ë²„íŠ¼(ì´ˆì„±ì¤„ ë)
    const clear = document.createElement("button");
    clear.className="clear";
    clear.textContent="ğŸ§¹";
    clear.title="ê²€ìƒ‰ ì§€ìš°ê¸°";
    clear.onclick = ()=>{ qEl.value=""; renderProducts(); qEl.focus(); };
    choEl.appendChild(clear);

    /* ===============================
       9) ì •ë ¬ ë²„íŠ¼(í‘œì‹œë§Œ)
       =============================== */
    document.getElementById("sortBtn").onclick = ()=>{
      // ì§€ê¸ˆì€ ê³ ì •+ë§ì´ì°íŒ ìˆœ ê³ ì •. (ë²„íŠ¼ì€ ìƒíƒœí‘œì‹œìš©)
      renderProducts();
      renderPinbar();
    };

    /* ===============================
       10) ì´ˆê¸° ë Œë”
       =============================== */
    renderTabs();
    renderPinbar();
    renderProducts();
    renderCart();
  </script>
</body>
</html>
