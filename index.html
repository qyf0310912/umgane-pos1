<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ì—„ê°€ë„¤ POS</title>

<style>
/* (ë„ˆê°€ ì¤€ CSS ê·¸ëŒ€ë¡œ) */
:root{
  --bg:#0f1219;
  --panel:#121827;
  --card1:#1e2639;
  --card2:#242f4a;
  --line:rgba(255,255,255,.12);
  --text:#f7f9ff;
  --muted:rgba(247,249,255,.65);
  --accent:#ff9f00;
  --danger:#ff4d4f;
  --good:#2fd27e;
  --btn:#f4f5f7;
  --btnText:#111;
  --shadow:0 14px 44px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; background:var(--bg); color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",system-ui,Segoe UI,Roboto,sans-serif;
}
button,input{font:inherit}
button{border:none; background:none}
.app{height:100%; display:grid; grid-template-columns:3fr 1fr; gap:14px; padding:14px}
.left{
  background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
  border:1px solid var(--line);
  border-radius:22px;
  box-shadow:var(--shadow);
  overflow:hidden;
  display:flex; flex-direction:column;
}
.topbar{
  display:flex; gap:10px; padding:10px 12px;
  border-bottom:1px solid var(--line);
  background:rgba(255,255,255,.02)
}
.tabs{display:flex; gap:8px; flex-wrap:wrap}
.tab{
  padding:8px 14px; border-radius:999px; border:1px solid var(--line);
  background:#1d2332; color:var(--text); font-weight:1000; cursor:pointer;
}
.tab.active{background:rgba(255,159,0,.18); border-color:rgba(255,159,0,.45)}
.searchwrap{padding:10px 12px; border-bottom:1px solid var(--line); background:rgba(255,255,255,.015)}
.searchrow{display:flex; gap:10px; align-items:center}
.search{
  flex:1; display:flex; align-items:center; gap:10px;
  background:rgba(255,255,255,.04); border:1px solid var(--line);
  border-radius:14px; padding:10px 12px;
}
.search .icon{opacity:.7}
.search input{
  width:100%; border:none; outline:none; background:transparent;
  color:var(--text); font-weight:900; font-size:15px;
}
.sort{
  display:flex; align-items:center; gap:8px; padding:10px 12px;
  border:1px solid var(--line); border-radius:14px;
  background:rgba(255,255,255,.03); font-weight:1000;
  white-space:nowrap;
}
.sort small{opacity:.7; font-weight:900}
.cho{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap}
.cho button{
  padding:8px 10px; border-radius:12px; border:1px solid var(--line);
  background:rgba(255,255,255,.03); color:var(--text);
  font-weight:1100; cursor:pointer; min-width:40px;
}
.cho button.clear{background:rgba(255,77,79,.18); border-color:rgba(255,77,79,.35)}
.products{
  padding:12px; overflow:auto;
  display:grid; grid-template-columns:repeat(4, minmax(0,1fr));
  gap:12px;
}
@media (min-width:1500px){ .products{grid-template-columns:repeat(5, minmax(0,1fr))} }
.card{
  background:linear-gradient(180deg, var(--card2), var(--card1));
  border:1px solid rgba(255,255,255,.16);
  border-radius:18px; padding:14px;
  cursor:pointer; user-select:none;
  position:relative; min-height:90px;
  touch-action:manipulation;
}
.card.flash{box-shadow:0 0 0 3px rgba(255,159,0,.45)}
.name{font-size:18px; font-weight:1200; letter-spacing:-.2px}
.price{margin-top:6px; font-size:14px; opacity:.95; font-weight:1000}
.meta{
  position:absolute; right:10px; top:10px;
  display:flex; gap:8px; align-items:center; opacity:.9
}
.badge{
  font-size:12px; padding:4px 8px; border-radius:999px;
  border:1px solid var(--line); background:rgba(255,255,255,.03);
  font-weight:1100
}
.pin{
  width:28px; height:28px; display:grid; place-items:center;
  border-radius:10px; border:1px solid var(--line);
  background:rgba(0,0,0,.15)
}
.pin.on{border-color:rgba(255,159,0,.55); background:rgba(255,159,0,.18)}
.meta, .meta * { pointer-events:none; }
.hint{
  padding:8px 12px 12px;
  color:var(--muted); font-size:12px; font-weight:900;
  border-top:1px solid var(--line); background:rgba(255,255,255,.01)
}
.right{
  background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
  border:1px solid var(--line);
  border-radius:22px;
  box-shadow:var(--shadow);
  overflow:hidden;
  display:flex; flex-direction:column;
}
.cart{padding:12px; overflow:auto; flex:1; min-height:240px}
.carthead{display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; font-weight:1200}
.carthead .muted{opacity:.7; font-weight:1000}
.item{
  background:rgba(255,255,255,.03); border:1px solid var(--line);
  border-radius:14px; padding:10px;
  display:grid; grid-template-columns:1fr auto; gap:10px; margin-bottom:8px;
}
.item .title{font-weight:1200; font-size:14px}
.item .sub{margin-top:4px; font-size:12px; opacity:.8; font-weight:900}
.controls{display:flex; gap:8px; align-items:center}
.ctrl{
  width:38px; height:36px; border-radius:12px; border:1px solid var(--line);
  background:rgba(255,255,255,.03); color:var(--text); font-weight:1300; cursor:pointer;
}
.ctrl.del{background:rgba(255,77,79,.18); border-color:rgba(255,77,79,.35)}
.count{width:26px; text-align:center; font-weight:1300}
.summary{padding:12px; border-top:1px solid var(--line); background:rgba(255,255,255,.015)}
.row{display:flex; justify-content:space-between; align-items:flex-end; gap:12px; margin-bottom:8px}
.label{font-size:12px; opacity:.7; font-weight:1100}
.val{font-size:20px; font-weight:1300}
.smallval{font-size:14px; font-weight:1200; opacity:.95}
.payline{display:flex; align-items:flex-end; gap:12px; margin-top:10px}
.payline .block{flex:1}
.payline .divider{width:2px; height:26px; background:rgba(255,255,255,.14); border-radius:99px; align-self:center}
.payline .leftAlign{text-align:left}
.payline .rightAlign{text-align:right}
.money{
  padding:12px; border-top:1px solid var(--line);
  display:grid; grid-template-columns:repeat(3,1fr); gap:10px;
  background:rgba(255,255,255,.01);
}
.money button{
  padding:12px; border-radius:14px;
  font-size:16px; font-weight:1300; cursor:pointer;
  background:var(--btn); color:var(--btnText);
}
.money button.reset{background:rgba(255,77,79,.22); color:#ffe2e2}
.pay{
  margin:12px; margin-top:0;
  border-radius:16px; padding:16px;
  background:var(--accent);
  font-size:18px; font-weight:1400;
  cursor:pointer;
}
.pay.locked{opacity:.55; pointer-events:none}
.overlay{position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:9999}
.overlay.show{display:flex}
.modal{
  width:min(520px,92vw);
  background:#161c28;
  border:1px solid rgba(255,255,255,.14);
  border-radius:20px; padding:18px;
  box-shadow:var(--shadow)
}
.modal h3{margin:0 0 8px; font-size:18px; font-weight:1300}
.modal p{margin:0; opacity:.9; font-weight:1000}
.modal .btns{display:flex; gap:10px; justify-content:flex-end; margin-top:14px}
.modal button{padding:10px 14px; border-radius:14px; font-weight:1300; cursor:pointer}
.modal .ok{background:var(--good); color:#082010}
.modal .cancel{background:rgba(255,255,255,.08); color:var(--text)}
.toast{
  position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
  background:rgba(0,0,0,.75);
  border:1px solid rgba(255,255,255,.18);
  padding:10px 12px; border-radius:14px;
  font-weight:1100; z-index:10000;
  display:none; max-width:92vw;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.toast.show{display:block}
</style>
</head>

<body>
<div class="app">
  <section class="left">
    <div class="topbar"><div class="tabs" id="tabs"></div></div>

    <div class="searchwrap">
      <div class="searchrow">
        <div class="search">
          <span class="icon">ğŸ”</span>
          <input id="q" placeholder="ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±ã„±)" autocomplete="off" />
        </div>
        <div class="sort" title="ì •ë ¬ì€ ê³ ì • â†’ ë§ì´ì°íŒ(ì‚¬ìš©íšŸìˆ˜) â†’ ì´ë¦„">
          ì •ë ¬: <small>ê³ ì • + ë§ì´ ì°íŒ ìˆœ</small>
        </div>
      </div>
      <div class="cho" id="cho"></div>
    </div>

    <div class="products" id="products"></div>
    <div class="hint">â€» ìƒí’ˆ ê³ ì •: ê¸¸ê²Œ ëˆ„ë¥´ê¸°(ëª¨ë°”ì¼) / ìš°í´ë¦­(PC). ìƒí’ˆì€ ì¹´ë“œ ì•„ë¬´ë°ë‚˜ ëˆ„ë¥´ë©´ ë‹´ê¹ë‹ˆë‹¤.</div>
  </section>

  <section class="right">
    <div class="cart" id="cart"></div>

    <div class="summary">
      <div class="row">
        <div>
          <div class="label">ì´í•©ê³„</div>
          <div class="val" id="sum">0ì›</div>
        </div>
        <div style="text-align:right">
          <div class="label">ì´ìˆ˜ëŸ‰</div>
          <div class="smallval" id="qty">0</div>
        </div>
      </div>

      <div class="payline">
        <div class="block leftAlign">
          <div class="label">ë°›ì€ëˆ</div>
          <div class="val" id="received">0ì›</div>
        </div>
        <div class="divider"></div>
        <div class="block rightAlign">
          <div class="label">ê±°ìŠ¤ë¦„ëˆ</div>
          <div class="val" id="change">0ì›</div>
        </div>
      </div>
    </div>

    <div class="money">
      <button data-add="500">500</button>
      <button data-add="1000">1ì²œ</button>
      <button data-add="5000">5ì²œ</button>
      <button data-add="10000">1ë§Œ</button>
      <button data-add="50000">5ë§Œ</button>
      <button class="reset" id="reset">ì´ˆê¸°í™”</button>
    </div>

    <button class="pay" id="pay">ê²°ì œì™„ë£Œ</button>
  </section>
</div>

<div class="overlay" id="overlay">
  <div class="modal">
    <h3>ê²°ì œ ì™„ë£Œ</h3>
    <p id="modalText">ì •ë§ ê²°ì œì™„ë£Œ ì²˜ë¦¬í• ê¹Œìš”?</p>
    <div class="btns">
      <button class="cancel" id="cancelBtn">ì·¨ì†Œ</button>
      <button class="ok" id="okBtn">í™•ì¸</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- âœ… ë¨¼ì € ì‹œíŠ¸ì—ì„œ ITEMSë¥¼ ì±„ìš°ëŠ” íŒŒì¼ -->
<script src="./items.js"></script>

<script>
window.addEventListener("error", (e)=>{
  alert("JSì˜¤ë¥˜: " + (e?.message || e));
});

/* âœ… ì´ì œ â€œí•˜ë“œì½”ë”© PRODUCTSâ€ ì‚­ì œ!
   window.ITEMS(ì‹œíŠ¸ì—ì„œ ì˜¨ ê²ƒ)ì„ PRODUCTSë¡œ ì‚¬ìš© */
const PRODUCTS = Array.isArray(window.ITEMS) ? window.ITEMS : [];

/* âœ… ì¹´í…Œê³ ë¦¬ë„ ìë™ ìƒì„±(ì‹œíŠ¸ ê¸°ì¤€) */
const CATS = (() => {
  const set = new Set(PRODUCTS.map(p => p.cat));
  return Array.from(set);
})();

const LS_KEY="umgane_pos_state_v2";
const state = (()=>{ try{
  const s=JSON.parse(localStorage.getItem(LS_KEY)||"{}");
  return { pinned:s.pinned||{}, used:s.used||{}, lastCat:s.lastCat|| (CATS[0] || "ê³¼ì¼") };
}catch(_){ return {pinned:{}, used:{}, lastCat:(CATS[0] || "ê³¼ì¼")}; }})();
const saveState=()=>localStorage.setItem(LS_KEY, JSON.stringify(state));

const productMap = Object.fromEntries(PRODUCTS.map(p=>[p.id,p]));
const cart = {};
let activeCat = state.lastCat;
let q = "";
let received = 0;
let payLocked = false;

let tapLock = false;
function lockTap(ms=120){
  tapLock = true;
  setTimeout(()=>tapLock=false, ms);
}

const tabsEl = document.getElementById("tabs");
const productsEl = document.getElementById("products");
const cartEl = document.getElementById("cart");
const toastEl = document.getElementById("toast");

function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(toastEl._t);
  toastEl._t=setTimeout(()=>toastEl.classList.remove("show"), 900);
}

/* ì´ˆì„± ê²€ìƒ‰ */
const CHO=["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
function getChosung(str){
  let out="";
  for(const ch of str){
    const code=ch.charCodeAt(0);
    if(code>=0xAC00 && code<=0xD7A3){
      out+=CHO[Math.floor((code-0xAC00)/588)]||"";
    }else out+=ch;
  }
  return out;
}
function matchQuery(p, query){
  const t=(query||"").trim();
  if(!t) return true;
  const name=p.name.replace(/\s/g,"");
  const tl=t.toLowerCase().replace(/\s/g,"");
  if(name.toLowerCase().includes(tl)) return true;
  if(getChosung(name).includes(tl)) return true;
  return false;
}

/* ì •ë ¬: ê³ ì • â†’ ë§ì´ì°í˜ â†’ ì´ë¦„ */
function sortedList(list){
  return list.slice().sort((a,b)=>{
    const ap=!!state.pinned[a.id], bp=!!state.pinned[b.id];
    if(ap!==bp) return ap?-1:1;
    const au=state.used[a.id]||0, bu=state.used[b.id]||0;
    if(au!==bu) return bu-au;
    return a.name.localeCompare(b.name,"ko");
  });
}

/* âœ… ì—¬ê¸°ì„œ â€œí•€ë§Œ ë…¸ì¶œâ€ ê°™ì€ í•„í„° ì—†ìŒ!
   - ê²€ìƒ‰ì´ë©´ ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰
   - ì•„ë‹ˆë©´ í˜„ì¬ ì¹´í…Œê³ ë¦¬ ì „ë¶€ ë…¸ì¶œ */
function currentProducts(){
  const filtered = PRODUCTS.filter(p=>{
    if(q.trim()) return matchQuery(p,q);
    return p.cat===activeCat;
  });
  return sortedList(filtered);
}

function renderTabs(){
  tabsEl.innerHTML="";
  CATS.forEach(cat=>{
    const b=document.createElement("button");
    b.className="tab"+(cat===activeCat?" active":"");
    b.textContent=cat;
    b.onclick=()=>{ activeCat=cat; state.lastCat=cat; saveState(); renderProducts(); };
    tabsEl.appendChild(b);
  });
}

function togglePin(id){
  state.pinned[id]=!state.pinned[id];
  saveState();
  renderProducts();
}

function attachPinHandlers(cardEl, id){
  let pressTimer=null;
  cardEl.addEventListener("touchstart", ()=>{
    pressTimer=setTimeout(()=>{
      cardEl.dataset.suppress="1";
      togglePin(id);
      setTimeout(()=>{delete cardEl.dataset.suppress;}, 350);
    }, 450);
  }, {passive:true});
  cardEl.addEventListener("touchend", ()=>{ if(pressTimer) clearTimeout(pressTimer); pressTimer=null; });
  cardEl.addEventListener("contextmenu",(e)=>{ e.preventDefault(); togglePin(id); });
}

function renderProducts(){
  productsEl.innerHTML="";
  currentProducts().forEach(p=>{
    const d=document.createElement("div");
    d.className="card";
    d.dataset.id=p.id;
    const used=state.used[p.id]||0;
    const pinned=!!state.pinned[p.id];
    d.innerHTML=`
      <div class="meta">
        <span class="badge">ì‚¬ìš© ${used}</span>
        <span class="pin ${pinned?"on":""}">ğŸ“Œ</span>
      </div>
      <div class="name">${p.name}</div>
      <div class="price">${Number(p.price).toLocaleString()}ì›</div>
    `;
    attachPinHandlers(d, p.id);
    productsEl.appendChild(d);
  });
}

function updateUsedBadge(id){
  const card = productsEl.querySelector(\`.card[data-id="\${id}"]\`);
  if(!card) return;
  const badge = card.querySelector(".badge");
  if(badge) badge.textContent = "ì‚¬ìš© " + (state.used[id]||0);
}

function flash(el){
  el.classList.add("flash");
  setTimeout(()=>el.classList.remove("flash"), 140);
}

/* ë‹´ê¸° */
productsEl.addEventListener("pointerdown", (e)=>{
  if(tapLock) return;
  const card = e.target.closest(".card");
  if(!card) return;
  if(card.dataset.suppress==="1") return;

  const id = card.dataset.id;
  const p = productMap[id];
  if(!p){ alert("ìƒí’ˆID ì˜¤ë¥˜: "+id); return; }

  lockTap(120);
  addToCart(id, 1);
  flash(card);
});

function addToCart(id,n){
  cart[id]=(cart[id]||0)+n;
  if(cart[id]<=0) delete cart[id];

  if(n>0){
    state.used[id]=(state.used[id]||0)+1;
    saveState();
    updateUsedBadge(id);
  }
  renderCart();
}

function sumCart(){
  let sum=0, qty=0;
  for(const id in cart){
    const p=productMap[id];
    sum += Number(p.price)*cart[id];
    qty += cart[id];
  }
  return {sum,qty};
}

function renderCart(){
  const {sum,qty}=sumCart();
  document.getElementById("sum").textContent=sum.toLocaleString()+"ì›";
  document.getElementById("qty").textContent=qty;
  document.getElementById("received").textContent=received.toLocaleString()+"ì›";
  document.getElementById("change").textContent=Math.max(0,received-sum).toLocaleString()+"ì›";

  cartEl.innerHTML=`
    <div class="carthead">
      <div>ì¥ë°”êµ¬ë‹ˆ <span class="muted">(ìˆ˜ëŸ‰ ì¡°ì ˆ + ì‚­ì œ)</span></div>
      <div class="muted">í•­ëª© ${Object.keys(cart).length}</div>
    </div>
  `;

  Object.keys(cart).forEach(id=>{
    const p=productMap[id], qn=cart[id];
    const item=document.createElement("div");
    item.className="item";
    item.innerHTML=`
      <div>
        <div class="title">${p.name} <span style="opacity:.7">x${qn}</span></div>
        <div class="sub">${Number(p.price).toLocaleString()}ì› Â· í•© ${(Number(p.price)*qn).toLocaleString()}ì›</div>
      </div>
      <div class="controls">
        <button class="ctrl" data-act="minus">-</button>
        <div class="count">${qn}</div>
        <button class="ctrl" data-act="plus">+</button>
        <button class="ctrl del" data-act="del">âœ•</button>
      </div>
    `;
    item.querySelector('[data-act="minus"]').onclick=()=>addToCart(id,-1);
    item.querySelector('[data-act="plus"]').onclick =()=>addToCart(id, 1);
    item.querySelector('[data-act="del"]').onclick  =()=>{ delete cart[id]; renderCart(); };
    cartEl.appendChild(item);
  });
}

/* ë°›ì€ëˆ */
document.querySelectorAll('.money button[data-add]').forEach(b=>{
  b.onclick=()=>{ received += Number(b.dataset.add); renderCart(); };
});
document.getElementById("reset").onclick=()=>{ received=0; renderCart(); };

/* ê²°ì œ íŒì—… */
const overlay=document.getElementById("overlay");
const payBtn=document.getElementById("pay");
const okBtn=document.getElementById("okBtn");
const cancelBtn=document.getElementById("cancelBtn");
const modalText=document.getElementById("modalText");

function beep(){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type="sine"; o.frequency.value=880; g.gain.value=0.06;
    o.connect(g); g.connect(ctx.destination);
    o.start(); setTimeout(()=>{o.stop(); ctx.close();},120);
  }catch(_){}
}

payBtn.onclick=()=>{
  if(payLocked) return;
  const {sum,qty}=sumCart();
  modalText.textContent = qty===0 ? "ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤." : `ì´ ${sum.toLocaleString()}ì› / ${qty}ê°œ Â· ê²°ì œì™„ë£Œ ì²˜ë¦¬í• ê¹Œìš”?`;
  overlay.classList.add("show"); beep();
};
cancelBtn.onclick=()=>overlay.classList.remove("show");
okBtn.onclick=()=>{
  overlay.classList.remove("show"); beep();
  payLocked=true; payBtn.classList.add("locked");
  setTimeout(()=>{
    for(const id in cart) delete cart[id];
    received=0;
    renderCart();
    payLocked=false; payBtn.classList.remove("locked");
  },1000);
};

/* ê²€ìƒ‰/ì´ˆì„± */
const qEl=document.getElementById("q");
qEl.addEventListener("input",()=>{ q=qEl.value; renderProducts(); });

const choEl=document.getElementById("cho");
const choKeys=["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
choEl.innerHTML="";
choKeys.forEach(k=>{
  const b=document.createElement("button");
  b.textContent=k;
  b.onclick=()=>{ qEl.value=qEl.value+k; q=qEl.value; renderProducts(); qEl.focus(); };
  choEl.appendChild(b);
});
const clear=document.createElement("button");
clear.className="clear"; clear.textContent="X";
clear.onclick=()=>{ qEl.value=""; q=""; renderProducts(); qEl.focus(); };
choEl.appendChild(clear);

/* âœ… ì´ˆê¸° ë Œë” */
if(!PRODUCTS.length){
  // ì‹œíŠ¸ê°€ ì•„ì§ ë¡œë”©/ìºì‹œê°€ ë¹„ì—ˆì„ ë•Œ ì•ˆë‚´
  productsEl.innerHTML = `<div style="grid-column:1/-1;opacity:.8;font-weight:1100;padding:14px;border:1px dashed rgba(255,255,255,.25);border-radius:16px">
    ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... (ì‹œíŠ¸ ê³µê°œ/CSV í™•ì¸ í•„ìš”)<br/>
    í•„ìš”í•˜ë©´ ì½˜ì†”ì—ì„œ <b>reloadItemsFromSheet()</b> ì‹¤í–‰
  </div>`;
}
renderTabs();
renderProducts();
renderCart();
</script>
</body>
</html>
