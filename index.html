<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ì—„ê°€ë„¤ POS</title>

<style>
  :root{
    --bg:#0b0c10;
    --panel:#111319;
    --panel2:#0f1116;
    --line:rgba(255,255,255,.08);
    --text:#f5f7ff;
    --muted:rgba(245,247,255,.65);
    --accent:#ff9f00;
    --good:#29d17e;
    --bad:#ff3b30;
    --shadow:0 12px 40px rgba(0,0,0,.35);
    --r:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
  button{cursor:pointer;border:0;border-radius:14px}
  .app{
    height:100%;
    display:grid;
    grid-template-columns: 1.3fr .9fr;
    gap:12px;
    padding:12px;
  }
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:1px solid var(--line);
    border-radius:22px;
    box-shadow: var(--shadow);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    min-height:0;
  }
  .topbar{
    padding:12px 12px 8px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{
    padding:10px 14px;
    background:rgba(255,255,255,.06);
    color:var(--text);
    border:1px solid var(--line);
    border-radius:999px;
    font-weight:800;
    letter-spacing:-.2px;
    opacity:.9;
  }
  .tab.active{
    outline:2px solid rgba(255,159,0,.35);
    background:rgba(255,159,0,.16);
    opacity:1;
  }
  .searchRow{
    width:100%;
    display:flex;
    gap:10px;
    align-items:center;
  }
  .search{
    flex:1;
    display:flex;
    gap:10px;
    align-items:center;
    background:rgba(0,0,0,.25);
    border:1px solid var(--line);
    border-radius:16px;
    padding:10px 12px;
  }
  .search input{
    flex:1;
    background:transparent;border:0;outline:0;color:var(--text);
    font-size:15px;
  }
  .pillBtn{
    background:rgba(255,255,255,.06);
    border:1px solid var(--line);
    color:var(--text);
    padding:10px 12px;
    border-radius:999px;
    font-weight:800;
    white-space:nowrap;
  }
  .pillBtn.accent{background:rgba(255,159,0,.18); border-color:rgba(255,159,0,.35)}
  .kbd{
    padding:0 12px 10px;
    display:flex;
    gap:6px;
    flex-wrap:wrap;
    align-items:center;
  }
  .key{
    width:34px;height:34px;border-radius:12px;
    background:rgba(255,255,255,.06);
    border:1px solid var(--line);
    color:var(--text);
    font-weight:900;
  }
  .key.red{background:rgba(255,59,48,.14);border-color:rgba(255,59,48,.28)}
  .content{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
    padding:0 12px 12px;
    min-height:0;
    overflow:hidden;
  }

  /* pinned row */
  .pinnedWrap{
    border-top:1px solid var(--line);
    padding:10px 0 2px;
  }
  .pinnedTitle{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    color:var(--muted);
    font-weight:900;
    letter-spacing:-.2px;
    margin:0 0 8px;
  }
  .pinnedRow{
    display:flex; gap:10px; overflow:auto; padding:0 2px 8px;
    scrollbar-width:thin;
  }
  .pinnedRow::-webkit-scrollbar{height:8px}
  .pinnedRow::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:99px}

  /* grid */
  .grid{
    min-height:0;
    overflow:auto;
    padding-right:4px;
  }
  .cards{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
    gap:10px;
  }
  /* iPadì—ì„œ ë” ë§ì´ ë³´ì´ê²Œ */
  @media (max-width: 1180px){
    .app{grid-template-columns:1fr; }
  }
  @media (max-width: 900px){
    .cards{grid-template-columns: repeat(auto-fit, minmax(165px, 1fr));}
  }
  .card{
    position:relative;
    background:rgba(0,0,0,.22);
    border:1px solid var(--line);
    border-radius:18px;
    padding:12px 12px 10px;
    min-height:94px; /* iPad: ë†’ì´ ë‚®ì¶°ì„œ ë§ì´ ë³´ì´ê²Œ */
    display:flex;
    flex-direction:column;
    justify-content:space-between;
    gap:6px;
  }
  .card .name{font-weight:950;font-size:18px;letter-spacing:-.2px;line-height:1.05}
  .card .price{font-weight:900;color:rgba(245,247,255,.85);font-size:14px}
  .card .meta{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .badge{
    font-size:12px;
    color:rgba(245,247,255,.75);
    background:rgba(255,255,255,.06);
    border:1px solid var(--line);
    padding:6px 9px;
    border-radius:999px;
    font-weight:900;
    max-width:110px;
    overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
  }
  .pinBtn{
    width:34px;height:34px;border-radius:12px;
    background:rgba(255,255,255,.06);
    border:1px solid var(--line);
    color:rgba(245,247,255,.75);
    font-weight:900;
  }
  .pinBtn.pinned{
    background:rgba(255,59,48,.18);
    border-color:rgba(255,59,48,.35);
    color:#ffd0cd;
  }
  .hint{
    color:var(--muted);
    font-weight:900;
    font-size:12px;
    margin-left:auto;
  }

  /* RIGHT: cart */
  .rightTop{
    padding:12px;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    border-bottom:1px solid var(--line);
  }
  .sumBox{display:flex;flex-direction:column;gap:6px}
  .sumTitle{color:var(--muted);font-weight:950}
  .sumSub{color:rgba(245,247,255,.75);font-weight:900}
  .bigTotal{font-weight:1000;font-size:28px;letter-spacing:-.5px}
  .cartList{
    min-height:0;
    overflow:auto;
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .cartItem{
    border:1px solid var(--line);
    background:rgba(0,0,0,.22);
    border-radius:16px;
    padding:10px;
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
    align-items:center;
  }
  .ciName{font-weight:950}
  .ciSub{color:rgba(245,247,255,.7);font-weight:900;font-size:12px;margin-top:3px}
  .ciBtns{display:flex;gap:8px;align-items:center}
  .mini{
    width:34px;height:34px;border-radius:12px;
    background:rgba(255,255,255,.06);
    border:1px solid var(--line);
    color:var(--text);
    font-weight:1000;
  }
  .mini.red{background:rgba(255,59,48,.18);border-color:rgba(255,59,48,.33)}
  .mini.green{background:rgba(41,209,126,.14);border-color:rgba(41,209,126,.28)}
  .payArea{
    padding:12px;
    border-top:1px solid var(--line);
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .moneyLine{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .mlLeft{color:var(--muted);font-weight:950}
  .mlVal{font-weight:1000;font-size:28px}
  .quickRow{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
  }
  .qbtn{
    padding:12px 10px;
    border-radius:14px;
    background:rgba(255,255,255,.06);
    border:1px solid var(--line);
    color:var(--text);
    font-weight:1000;
    font-size:16px;
  }
  .qbtn.red{background:rgba(255,59,48,.18);border-color:rgba(255,59,48,.33)}
  .bottomRow{
    display:grid;
    grid-template-columns: 1fr 2fr;
    gap:10px;
    align-items:stretch;
  }
  .ghost{
    background:rgba(255,255,255,.06);
    border:1px solid var(--line);
    color:rgba(245,247,255,.9);
    border-radius:16px;
    font-weight:1000;
    padding:12px;
  }
  .payBtn{
    background:rgba(255,159,0,.95);
    color:#111;
    font-weight:1100;
    border-radius:16px;
    font-size:20px;
    padding:14px 12px;
  }

  /* MISU drawer */
  .misoBar{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:flex-end;
    padding:0 12px 12px;
    border-bottom:1px solid var(--line);
  }
  .misoDrawer{
    display:none;
    padding:12px;
    border-bottom:1px solid var(--line);
    background:rgba(0,0,0,.18);
  }
  .misoDrawer.open{display:block;}
  .misoHead{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }
  .misoTitle{font-weight:1100}
  .misoList{
    display:flex;
    flex-direction:column;
    gap:10px;
    max-height:220px;
    overflow:auto;
    padding-right:4px;
  }
  .misoRow{
    border:1px solid var(--line);
    background:rgba(0,0,0,.22);
    border-radius:16px;
    padding:10px;
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
    align-items:center;
  }
  .misoMeta{color:rgba(245,247,255,.7);font-weight:900;font-size:12px;margin-top:3px}
  .misoBtns{display:flex;gap:8px;align-items:center}
  .tiny{
    padding:10px 12px;
    border-radius:14px;
    background:rgba(255,255,255,.06);
    border:1px solid var(--line);
    color:var(--text);
    font-weight:1000;
    white-space:nowrap;
  }
  .tiny.red{background:rgba(255,59,48,.18);border-color:rgba(255,59,48,.33)}
  .tiny.green{background:rgba(41,209,126,.14);border-color:rgba(41,209,126,.28)}
</style>
</head>

<body>
<div class="app">

  <!-- LEFT -->
  <section class="panel" id="leftPanel">
    <div class="topbar">
      <div class="tabs" id="tabs"></div>

      <div class="searchRow">
        <div class="search">
          <span style="opacity:.7">ğŸ”</span>
          <input id="searchInput" placeholder="ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±ã„´ã„·)" autocomplete="off" />
        </div>

        <button class="pillBtn" id="sortBtn">ì •ë ¬: ê³ ì • + ord</button>
      </div>
    </div>

    <div class="kbd" id="kbd"></div>

    <div class="content">
      <div class="pinnedWrap">
        <div class="pinnedTitle">
          <div>ê³ ì • Â· ìƒë‹¨</div>
          <div class="hint">ê¸¸ê²Œ ëˆŒëŸ¬ ê³ ì •/í•´ì œ (PC: ë”ë¸”í´ë¦­)</div>
        </div>
        <div class="pinnedRow" id="pinnedRow"></div>
      </div>

      <div class="grid" id="grid">
        <div class="cards" id="cards"></div>
      </div>
    </div>
  </section>

  <!-- RIGHT -->
  <section class="panel" id="rightPanel">
    <div class="rightTop">
      <div class="sumBox">
        <div class="sumTitle">ì´í•©ê³„ / ì´ê°¯ìˆ˜</div>
        <div class="sumSub" id="countText">0ê°œ</div>
      </div>
      <div class="bigTotal" id="totalText">0ì›</div>
    </div>

    <!-- ë¯¸ìˆ˜ ë²„íŠ¼ì¤„ -->
    <div class="misoBar">
      <button class="pillBtn" id="misoSaveBtn">ë¯¸ìˆ˜ë“±ë¡</button>
      <button class="pillBtn accent" id="misoToggleBtn">ë¯¸ìˆ˜(0)</button>
    </div>

    <!-- ë¯¸ìˆ˜ ë“œë¡œì–´ -->
    <div class="misoDrawer" id="misoDrawer">
      <div class="misoHead">
        <div class="misoTitle">ë¯¸ìˆ˜ ëª©ë¡</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="tiny red" id="misoClearAllBtn">ì „ì²´ì‚­ì œ</button>
          <button class="tiny" id="misoCloseBtn">ë‹«ê¸°</button>
        </div>
      </div>
      <div class="misoList" id="misoList"></div>
    </div>

    <div class="cartList" id="cartList"></div>

    <div class="payArea">
      <div class="moneyLine">
        <div class="mlLeft">ë°›ì€ëˆ</div>
        <div class="mlVal" id="receivedText">0ì›</div>
      </div>
      <div class="moneyLine">
        <div class="mlLeft">ê±°ìŠ¤ë¦„ëˆ</div>
        <div class="mlVal" id="changeText">0ì›</div>
      </div>

      <div class="quickRow">
        <button class="qbtn" data-add="500">+500</button>
        <button class="qbtn" data-add="1000">+1ì²œ</button>
        <button class="qbtn" data-add="5000">+5ì²œ</button>
        <button class="qbtn" data-add="10000">+1ë§Œ</button>
        <button class="qbtn" data-add="50000">+5ë§Œ</button>
        <button class="qbtn red" id="resetReceivedBtn">ì´ˆê¸°í™”</button>
      </div>

      <div class="bottomRow">
        <button class="ghost" id="clearCartBtn">ì¥ë°”êµ¬ë‹ˆë¹„ì›€</button>
        <button class="payBtn" id="payDoneBtn">ê²°ì œì™„ë£Œ</button>
      </div>
    </div>
  </section>

</div>

<script>
/* =========================================================
   âœ… ì„¤ì • (ë„ˆ ì‹œíŠ¸ URL ì´ë¯¸ ë§ìŒ)
========================================================= */
const CSV_URL = "https://docs.google.com/spreadsheets/d/1MK7TvyILEJ4_YKw1TmY1Au4Z_ZkGbF7LeRMsi89slbw/export?format=csv&gid=0";

/* =========================================================
   âœ… ë²„ì „ / ì €ì¥ì†Œ í‚¤ (ë²„ì „ ë°”ë€Œë©´ ì˜ˆì „ ì°Œêº¼ê¸° ìë™ ì •ë¦¬)
========================================================= */
const APP_VER = "umgane_pos_v20251224_misu_multi_1";
const LS_VER   = "umgane_app_ver";
const LS_ITEMS = "umgane_items_v1";
const LS_PINS  = "umgane_pins_v1";
const LS_USED  = "umgane_used_v1";
const LS_CART  = "umgane_cart_v1";
const LS_REC   = "umgane_received_v1";
const LS_MISU  = "umgane_misu_v1";

function migrateIfNeeded(){
  const v = localStorage.getItem(LS_VER);
  if(v !== APP_VER){
    // í•µì‹¬ ë°ì´í„°ë§Œ ì •ë¦¬ (ë¯¸ìˆ˜/ì¥ë°”êµ¬ë‹ˆ/í•€/ì‚¬ìš©íšŸìˆ˜/ë°›ì€ëˆ/ì•„ì´í…œ)
    localStorage.removeItem(LS_ITEMS);
    localStorage.removeItem(LS_PINS);
    localStorage.removeItem(LS_USED);
    localStorage.removeItem(LS_CART);
    localStorage.removeItem(LS_REC);
    localStorage.removeItem(LS_MISU);
    localStorage.setItem(LS_VER, APP_VER);
  }
}

/* =========================================================
   âœ… ìœ í‹¸
========================================================= */
const CAT_ORDER = ["ê³¼ì¼","ì•¼ì±„","ë´‰ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"]; // ì›í•˜ëŠ” ìˆœì„œ
const CHO_KEYS  = ["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];

function fmtWon(n){
  n = Math.max(0, Math.round(Number(n)||0));
  return n.toLocaleString("ko-KR") + "ì›";
}
function numFromAny(v){
  // "5,000.00" "5000" "5000.0" ëª¨ë‘ ì²˜ë¦¬
  if(v===null || v===undefined) return 0;
  const s = String(v).trim();
  if(!s) return 0;
  const cleaned = s.replace(/[^0-9.\-]/g,""); // ì½¤ë§ˆ/ì› ì œê±°
  const x = Number(cleaned);
  if(!isFinite(x)) return 0;
  return Math.round(x); // ì› ë‹¨ìœ„
}
function nowLabel(){
  const d = new Date();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return `${mm}/${dd} ${hh}:${mi}`;
}
function safeJsonGet(key, fallback){
  try{
    const v = localStorage.getItem(key);
    if(!v) return fallback;
    return JSON.parse(v);
  }catch(e){ return fallback; }
}
function safeJsonSet(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

/* =========================================================
   âœ… CSV íŒŒì„œ (ì½¤ë§ˆ/ë”°ì˜´í‘œ ì•ˆì „)
========================================================= */
function parseCSV(text){
  const rows = [];
  let cur = "", inQ = false;
  let row = [];
  function pushCell(){ row.push(cur); cur=""; }
  function pushRow(){ rows.push(row); row=[]; }

  for(let i=0;i<text.length;i++){
    const ch = text[i];
    if(ch === '"'){
      if(inQ && text[i+1] === '"'){ cur += '"'; i++; }
      else inQ = !inQ;
      continue;
    }
    if(!inQ && ch === ','){ pushCell(); continue; }
    if(!inQ && (ch === '\n' || ch === '\r')){
      if(ch === '\r' && text[i+1] === '\n') i++;
      pushCell(); pushRow();
      continue;
    }
    cur += ch;
  }
  pushCell(); pushRow();
  return rows.filter(r => r.some(c => String(c||"").trim() !== ""));
}

/* =========================================================
   âœ… ìƒíƒœ
========================================================= */
let allItems = []; // {id,cat,name,price,active,ord}
let selectedCat = "ê³¼ì¼";
let sortMode = "pin+ord";
let searchText = "";

let pins = new Set();        // pinned ids
let used = {};               // id -> count
let cart = [];               // [{id, qty}]
let received = 0;
let misu = [];               // [{mid,label,items:[{id,qty}], received,total,count,ts}]

/* =========================================================
   âœ… DOM
========================================================= */
const tabsEl = document.getElementById("tabs");
const kbdEl = document.getElementById("kbd");
const pinnedRowEl = document.getElementById("pinnedRow");
const cardsEl = document.getElementById("cards");
const searchInput = document.getElementById("searchInput");
const sortBtn = document.getElementById("sortBtn");

const totalText = document.getElementById("totalText");
const countText = document.getElementById("countText");
const cartListEl = document.getElementById("cartList");
const receivedText = document.getElementById("receivedText");
const changeText = document.getElementById("changeText");

const resetReceivedBtn = document.getElementById("resetReceivedBtn");
const clearCartBtn = document.getElementById("clearCartBtn");
const payDoneBtn = document.getElementById("payDoneBtn");

const misoSaveBtn = document.getElementById("misoSaveBtn");
const misoToggleBtn = document.getElementById("misoToggleBtn");
const misoDrawer = document.getElementById("misoDrawer");
const misoList = document.getElementById("misoList");
const misoCloseBtn = document.getElementById("misoCloseBtn");
const misoClearAllBtn = document.getElementById("misoClearAllBtn");

/* =========================================================
   âœ… ë¡œë“œ/ì €ì¥
========================================================= */
function loadLocal(){
  pins = new Set(safeJsonGet(LS_PINS, []));
  used = safeJsonGet(LS_USED, {});
  cart = safeJsonGet(LS_CART, []);
  received = Number(localStorage.getItem(LS_REC) || "0") || 0;
  misu = safeJsonGet(LS_MISU, []);
}
function saveLocal(){
  safeJsonSet(LS_PINS, Array.from(pins));
  safeJsonSet(LS_USED, used);
  safeJsonSet(LS_CART, cart);
  localStorage.setItem(LS_REC, String(received));
  safeJsonSet(LS_MISU, misu);
}
function saveMisu(){
  safeJsonSet(LS_MISU, misu);
  updateMisuBadge();
}

/* =========================================================
   âœ… ì‹œíŠ¸ ë¡œë“œ
========================================================= */
async function loadFromSheet(){
  const res = await fetch(CSV_URL, { cache:"no-store" });
  const text = await res.text();
  const rows = parseCSV(text);

  // header ì°¾ê¸°
  const header = rows[0].map(h => String(h||"").trim().toLowerCase());
  const idx = (name) => header.indexOf(name);

  const iId = idx("id");
  const iCat = idx("cat");
  const iName = idx("name");
  const iPrice = idx("price");
  const iActive = idx("active");
  const iOrd = idx("ord");

  const out = [];
  for(let r=1;r<rows.length;r++){
    const row = rows[r];
    const id = String(row[iId]||"").trim();
    const cat = String(row[iCat]||"").trim();
    const name = String(row[iName]||"").trim();
    if(!id || !cat || !name) continue;

    const price = numFromAny(row[iPrice]);
    const active = String(row[iActive]||"1").trim() === "1";
    const ordRaw = row[iOrd];
    const ord = ordRaw===undefined ? 999999 : Number(String(ordRaw).trim()) || 999999;

    out.push({ id, cat, name, price, active, ord });
  }

  // ì €ì¥(ë°±ì—…)
  safeJsonSet(LS_ITEMS, out);
  return out;
}

/* =========================================================
   âœ… ì¹´í…Œê³ ë¦¬/íƒ­
========================================================= */
function uniqueCats(items){
  const s = new Set(items.map(it => it.cat));
  const cats = Array.from(s);
  // CAT_ORDER ê¸°ì¤€ ì •ë ¬ + ë‚˜ë¨¸ì§€ ë’¤ì—
  cats.sort((a,b)=>{
    const ia = CAT_ORDER.indexOf(a);
    const ib = CAT_ORDER.indexOf(b);
    if(ia===-1 && ib===-1) return a.localeCompare(b,"ko");
    if(ia===-1) return 1;
    if(ib===-1) return -1;
    return ia-ib;
  });
  return cats;
}
function renderTabs(){
  tabsEl.innerHTML = "";
  const cats = uniqueCats(allItems).filter(c => c !== "ì „ì²´"); // ì „ì²´ ì œê±°
  // í˜¹ì‹œ ì‹œíŠ¸ì— ê¸°íƒ€ ì—†ìœ¼ë©´ UIì—ë§Œ ì¶”ê°€
  if(!cats.includes("ê¸°íƒ€")) cats.push("ê¸°íƒ€");

  for(const c of cats){
    const btn = document.createElement("button");
    btn.className = "tab" + (selectedCat===c ? " active": "");
    btn.textContent = c;
    btn.onclick = ()=>{
      selectedCat = c;
      renderTabs();
      renderAll();
    };
    tabsEl.appendChild(btn);
  }
}

/* =========================================================
   âœ… ì´ˆì„± í‚¤íŒ¨ë“œ
========================================================= */
function renderKbd(){
  kbdEl.innerHTML = "";
  for(const k of CHO_KEYS){
    const b = document.createElement("button");
    b.className = "key";
    b.textContent = k;
    b.onclick = ()=>{
      searchInput.value = (searchInput.value || "") + k;
      searchText = searchInput.value.trim();
      renderAll();
    };
    kbdEl.appendChild(b);
  }
  const x = document.createElement("button");
  x.className = "key red";
  x.textContent = "X";
  x.onclick = ()=>{
    searchInput.value = "";
    searchText = "";
    renderAll();
  };
  kbdEl.appendChild(x);
}

/* =========================================================
   âœ… ê²€ìƒ‰(ê°„ë‹¨: í¬í•¨ê²€ìƒ‰ + ã„±ã„´ã„· ë¬¸ìì—´ë„ ê·¸ëƒ¥ í¬í•¨ìœ¼ë¡œ ì²˜ë¦¬)
   - ìš”êµ¬ì‚¬í•­: "ì´ˆì„±ê²€ìƒ‰ì´ ì¹´í…Œê³ ë¦¬ë¡œë§Œ ë˜ì§€ ë§ê³  ì „ì²´í’ˆëª©ìœ¼ë¡œ"
   - êµ¬í˜„: ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ íƒ­ ë¬´ì‹œí•˜ê³  ì „ì²´ì—ì„œ í•„í„°
========================================================= */
function filterItems(){
  const activeItems = allItems.filter(it => it.active);

  if(searchText){
    const q = searchText.trim();
    return activeItems.filter(it => {
      const hay = (it.name + " " + it.cat + " " + it.id).replace(/\s+/g,"");
      const qq = q.replace(/\s+/g,"");
      return hay.includes(qq);
    });
  }

  // ê²€ìƒ‰ ì—†ìœ¼ë©´ íƒ­ í•„í„°
  if(selectedCat === "ê¸°íƒ€"){
    return activeItems.filter(it => it.cat === "ê¸°íƒ€");
  }
  return activeItems.filter(it => it.cat === selectedCat);
}

/* =========================================================
   âœ… ì •ë ¬
========================================================= */
function sortItems(list){
  return list.slice().sort((a,b)=>{
    // ê³ ì • ë¨¼ì €
    const pa = pins.has(a.id) ? 0 : 1;
    const pb = pins.has(b.id) ? 0 : 1;
    if(pa !== pb) return pa - pb;

    // ord ì˜¤ë¦„ì°¨ìˆœ
    if(a.ord !== b.ord) return a.ord - b.ord;

    // ì‚¬ìš© ë§ì´ í•œ ìˆœ(ë‚´ë¦¼)
    const ua = used[a.id] || 0;
    const ub = used[b.id] || 0;
    if(ua !== ub) return ub - ua;

    return a.name.localeCompare(b.name,"ko");
  });
}

/* =========================================================
   âœ… ì¹´ë“œ/í•€
========================================================= */
function addToCart(id){
  const f = cart.find(x => x.id === id);
  if(f) f.qty += 1;
  else cart.push({id, qty:1});
  used[id] = (used[id]||0) + 1;
  saveLocal();
  renderCart();
  renderAll(); // ì‚¬ìš©íšŸìˆ˜/ì •ë ¬ ë°˜ì˜
}

function togglePin(id){
  if(pins.has(id)) pins.delete(id);
  else pins.add(id);
  saveLocal();
  renderAll();
}

function renderPinned(){
  const pinnedItems = allItems.filter(it => it.active && pins.has(it.id));
  const list = sortItems(pinnedItems);

  pinnedRowEl.innerHTML = "";
  if(list.length === 0){
    const d = document.createElement("div");
    d.style.color = "rgba(245,247,255,.55)";
    d.style.fontWeight = "900";
    d.textContent = "ê³ ì • ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.";
    pinnedRowEl.appendChild(d);
    return;
  }

  for(const it of list){
    const c = makeCard(it, true);
    c.style.minWidth = "190px";
    pinnedRowEl.appendChild(c);
  }
}

function makeCard(it, inPinnedRow=false){
  const card = document.createElement("div");
  card.className = "card";

  const nm = document.createElement("div");
  nm.className = "name";
  nm.textContent = it.name;

  const pr = document.createElement("div");
  pr.className = "price";
  pr.textContent = fmtWon(it.price);

  const meta = document.createElement("div");
  meta.className = "meta";

  const badge = document.createElement("div");
  badge.className = "badge";
  badge.textContent = it.cat;

  const pin = document.createElement("button");
  pin.className = "pinBtn" + (pins.has(it.id) ? " pinned" : "");
  pin.textContent = "ğŸ“Œ";

  // ê³ ì •: ëª¨ë°”ì¼ì€ ê¸¸ê²Œ ëˆ„ë¥´ê¸°, PCëŠ” ë”ë¸”í´ë¦­
  let pressTimer = null;
  card.addEventListener("touchstart", ()=>{
    pressTimer = setTimeout(()=>togglePin(it.id), 500);
  }, {passive:true});
  card.addEventListener("touchend", ()=>{ if(pressTimer) clearTimeout(pressTimer); }, {passive:true});
  card.ondblclick = ()=>togglePin(it.id);

  pin.onclick = (e)=>{ e.stopPropagation(); togglePin(it.id); };

  meta.appendChild(badge);
  meta.appendChild(pin);

  card.appendChild(nm);
  card.appendChild(pr);
  card.appendChild(meta);

  card.onclick = ()=> addToCart(it.id);

  return card;
}

function renderCards(){
  const list = sortItems(filterItems());
  cardsEl.innerHTML = "";
  for(const it of list){
    cardsEl.appendChild(makeCard(it));
  }
}

/* =========================================================
   âœ… ì¥ë°”êµ¬ë‹ˆ/ê²°ì œ
========================================================= */
function cartTotal(){
  let total = 0, cnt = 0;
  for(const c of cart){
    const it = allItems.find(x=>x.id===c.id);
    if(!it) continue;
    total += it.price * c.qty;
    cnt += c.qty;
  }
  return { total, cnt };
}

function renderCart(){
  const { total, cnt } = cartTotal();
  totalText.textContent = fmtWon(total);
  countText.textContent = `${cnt}ê°œ`;
  receivedText.textContent = fmtWon(received);
  changeText.textContent = fmtWon(received - total);

  cartListEl.innerHTML = "";
  for(const c of cart){
    const it = allItems.find(x=>x.id===c.id);
    if(!it) continue;

    const row = document.createElement("div");
    row.className = "cartItem";

    const left = document.createElement("div");
    const t1 = document.createElement("div");
    t1.className = "ciName";
    t1.textContent = `${it.name} x${c.qty}`;
    const t2 = document.createElement("div");
    t2.className = "ciSub";
    t2.textContent = `${fmtWon(it.price)} Â· ${fmtWon(it.price*c.qty)}`;
    left.appendChild(t1); left.appendChild(t2);

    const btns = document.createElement("div");
    btns.className = "ciBtns";

    const minus = document.createElement("button");
    minus.className = "mini";
    minus.textContent = "âˆ’";
    minus.onclick = ()=>{
      c.qty -= 1;
      if(c.qty<=0) cart = cart.filter(x=>x!==c);
      saveLocal();
      renderCart();
    };

    const plus = document.createElement("button");
    plus.className = "mini green";
    plus.textContent = "+";
    plus.onclick = ()=>{
      c.qty += 1;
      saveLocal();
      renderCart();
    };

    const del = document.createElement("button");
    del.className = "mini red";
    del.textContent = "Ã—";
    del.onclick = ()=>{
      cart = cart.filter(x=>x!==c);
      saveLocal();
      renderCart();
    };

    btns.appendChild(minus);
    btns.appendChild(plus);
    btns.appendChild(del);

    row.appendChild(left);
    row.appendChild(btns);
    cartListEl.appendChild(row);
  }
}

/* =========================================================
   âœ… ë¯¸ìˆ˜ (ì—¬ëŸ¬ ê±´ í)
========================================================= */
function updateMisuBadge(){
  misoToggleBtn.textContent = `ë¯¸ìˆ˜(${misu.length})`;
}

function openMisu(){
  misoDrawer.classList.add("open");
}
function closeMisu(){
  misoDrawer.classList.remove("open");
}

function renderMisu(){
  updateMisuBadge();
  misoList.innerHTML = "";

  if(misu.length === 0){
    const d = document.createElement("div");
    d.style.color = "rgba(245,247,255,.65)";
    d.style.fontWeight = "900";
    d.textContent = "ë¯¸ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. (ë¯¸ìˆ˜ë“±ë¡ì„ ëˆ„ë¥´ë©´ ì €ì¥ë©ë‹ˆë‹¤)";
    misoList.appendChild(d);
    return;
  }

  misu.forEach((m, idx)=>{
    const row = document.createElement("div");
    row.className = "misoRow";

    const left = document.createElement("div");
    const title = document.createElement("div");
    title.style.fontWeight = "1100";
    title.textContent = `ë¯¸ìˆ˜ ${idx+1} Â· ${fmtWon(m.total)} Â· ${m.count}ê°œ`;
    const meta = document.createElement("div");
    meta.className = "misoMeta";
    meta.textContent = `${m.ts} Â· í’ˆëª© ${m.items.length}ì¢…`;
    left.appendChild(title);
    left.appendChild(meta);

    const btns = document.createElement("div");
    btns.className = "misoBtns";

    const loadBtn = document.createElement("button");
    loadBtn.className = "tiny green";
    loadBtn.textContent = "ë¶ˆëŸ¬ì˜¤ê¸°";
    loadBtn.onclick = ()=>{
      cart = JSON.parse(JSON.stringify(m.items));
      received = m.received || 0;
      saveLocal();
      closeMisu();
      renderCart();
    };

    const doneBtn = document.createElement("button");
    doneBtn.className = "tiny";
    doneBtn.textContent = "ì™„ë£Œ";
    doneBtn.onclick = ()=>{
      // ê²°ì œ ì™„ë£Œ ì²˜ë¦¬: ëª©ë¡ì—ì„œ ì œê±°ë§Œ
      misu = misu.filter(x => x.mid !== m.mid);
      saveMisu();
      renderMisu();
    };

    const delBtn = document.createElement("button");
    delBtn.className = "tiny red";
    delBtn.textContent = "ì‚­ì œ";
    delBtn.onclick = ()=>{
      misu = misu.filter(x => x.mid !== m.mid);
      saveMisu();
      renderMisu();
    };

    btns.appendChild(loadBtn);
    btns.appendChild(doneBtn);
    btns.appendChild(delBtn);

    row.appendChild(left);
    row.appendChild(btns);
    misoList.appendChild(row);
  });
}

function misuRegister(){
  const { total, cnt } = cartTotal();
  if(cart.length === 0) return;

  const mid = "m_" + Date.now() + "_" + Math.random().toString(16).slice(2);
  misu.unshift({
    mid,
    items: JSON.parse(JSON.stringify(cart)),
    received: received || 0,
    total,
    count: cnt,
    ts: nowLabel()
  });

  // í˜„ì¬ ê²°ì œëŠ” ë¹„ìš°ê³  ë‹¤ìŒ ì†ë‹˜ ë°›ê¸°
  cart = [];
  received = 0;
  saveLocal();
  saveMisu();

  renderCart();
  renderMisu();
}

/* =========================================================
   âœ… ì „ì²´ ë Œë”
========================================================= */
function renderAll(){
  renderPinned();
  renderCards();
  renderCart();
  renderMisu();
}

/* =========================================================
   âœ… ì´ë²¤íŠ¸
========================================================= */
searchInput.addEventListener("input", ()=>{
  searchText = searchInput.value.trim();
  renderAll();
});

sortBtn.onclick = ()=>{
  // ì§€ê¸ˆì€ ê³ ì •+ordë¡œ ê³ ì • (í•„ìš”í•˜ë©´ ëª¨ë“œ ì¶”ê°€ ê°€ëŠ¥)
  alert("ì •ë ¬ì€ ê³ ì • + ord ê¸°ì¤€ìœ¼ë¡œ ê³ ì •ì…ë‹ˆë‹¤.");
};

document.querySelectorAll(".qbtn[data-add]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    received += Number(btn.getAttribute("data-add")) || 0;
    saveLocal();
    renderCart();
  });
});

resetReceivedBtn.onclick = ()=>{
  received = 0;
  saveLocal();
  renderCart();
};

clearCartBtn.onclick = ()=>{
  cart = [];
  saveLocal();
  renderCart();
};

payDoneBtn.onclick = ()=>{
  // ê²°ì œì™„ë£Œ: ì¥ë°”êµ¬ë‹ˆë§Œ ë¹„ìš°ê³  ë°›ì€ëˆë„ ì´ˆê¸°í™”
  cart = [];
  received = 0;
  saveLocal();
  renderCart();
};

misoSaveBtn.onclick = misuRegister;

misoToggleBtn.onclick = ()=>{
  if(misoDrawer.classList.contains("open")) closeMisu();
  else { openMisu(); renderMisu(); }
};
misoCloseBtn.onclick = closeMisu;

misoClearAllBtn.onclick = ()=>{
  if(!confirm("ë¯¸ìˆ˜ ì „ì²´ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
  misu = [];
  saveMisu();
  renderMisu();
};

/* =========================================================
   âœ… ì‹œì‘
========================================================= */
(async function init(){
  migrateIfNeeded();
  loadLocal();
  renderKbd();

  // ì‹œíŠ¸ì—ì„œ ë¡œë“œ ì‹¤íŒ¨í•˜ë©´ ë¡œì»¬ ë°±ì—… ì‚¬ìš©
  try{
    allItems = await loadFromSheet();
  }catch(e){
    allItems = safeJsonGet(LS_ITEMS, []);
  }

  // selectedCat ì´ˆê¸°ê°’: ê³¼ì¼ ìˆìœ¼ë©´ ê³¼ì¼, ì—†ìœ¼ë©´ ì²« ì¹´í…Œê³ ë¦¬
  const cats = uniqueCats(allItems).filter(c=>c!=="ì „ì²´");
  if(cats.includes("ê³¼ì¼")) selectedCat = "ê³¼ì¼";
  else if(cats.length) selectedCat = cats[0];

  renderTabs();
  renderAll();
})();
</script>
</body>
</html>
