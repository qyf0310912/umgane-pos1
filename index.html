
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ì—„ê°€ë„¤ POS (ë‹¨ì¼íŒŒì¼ Â· êµ¬ê¸€ì‹œíŠ¸ ì—°ë™)</title>
  <style>
    :root{
      --bg:#0b0c10;
      --panel:#111319;
      --panel2:#0f1116;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.07);
      --text:#f5f7ff;
      --muted:rgba(245,247,255,.68);
      --muted2:rgba(245,247,255,.55);
      --accent:#ff9f00;
      --pin:#ff4d4d;
      --shadow:0 12px 40px rgba(0,0,0,.38);
      --r:18px;
    }
    *{box-sizing:border-box;}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;}
    button{font:inherit; cursor:pointer; border:0; background:transparent; color:inherit;}
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 1fr 420px;
      gap:14px;
      padding:14px;
    }
    @media (max-width: 980px){
      .app{grid-template-columns:1fr; grid-template-rows:auto auto;}
      .right{min-height:520px;}
    }

    /* ====== LEFT ====== */
    .left{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line2);
      border-radius:24px;
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:620px;
    }
    .topbar{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line2);
      background:rgba(255,255,255,.02);
    }
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .tab{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      font-weight:900;
      opacity:.92;
    }
    .tab.active{
      outline:2px solid rgba(255,159,0,.35);
      border-color:rgba(255,159,0,.35);
      color:var(--accent);
      background:rgba(255,159,0,.10);
    }
    .searchRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20);
    }
    .search .icon{opacity:.7;}
    #q{
      width:100%;
      border:0;
      outline:0;
      background:transparent;
      color:var(--text);
      font-size:16px;
      font-weight:900;
    }
    .sortBtn{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      font-weight:900;
      white-space:nowrap;
    }

    /* ì´ˆì„± ë²„íŠ¼ */
    .chos{
      margin-top:10px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .chos button{
      width:36px;
      height:36px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      font-weight:1100;
      opacity:.92;
    }
    .chos .clear{
      width:40px;
      background:rgba(255,77,77,.22);
      border-color:rgba(255,77,77,.35);
      font-weight:1400;
      color:#fff;
    }

    /* ê³ ì •(ì „ì²´ ê³µí†µ) 1ì¤„ */
    .pinWrap{
      padding:12px 14px 10px;
      border-bottom:1px solid var(--line2);
      background:rgba(255,255,255,.015);
    }
    .pinHead{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .pinHead .t1{font-weight:1200; opacity:.92;}
    .pinHead .t2{font-size:12px; opacity:.65;}
    .pinStrip{
      display:flex;
      gap:8px;
      overflow-x:auto;
      overflow-y:hidden;
      padding-bottom:2px;
      scrollbar-width:thin;
      -webkit-overflow-scrolling:touch;
      white-space:nowrap;
    }
    .pinCard{
      flex:0 0 auto;
      width:104px;
      height:56px;
      border-radius:14px;
      border:1px solid rgba(255,159,0,.25);
      background:rgba(255,159,0,.08);
      padding:8px 10px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      position:relative;
    }
    .pinCard .name{font-weight:1200; font-size:14px; line-height:1.1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .pinCard .price{font-size:12px; opacity:.70; font-weight:900; margin-top:4px;}
    .pinCard .pinI{
      position:absolute; right:8px; top:8px;
      width:20px; height:20px;
      border-radius:8px;
      display:grid; place-items:center;
      background:rgba(255,77,77,.25);
      border:1px solid rgba(255,77,77,.35);
      color:#fff;
      font-size:12px;
    }

    /* ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ (âœ… ë” ë§ì€ í’ˆëª© í•œëˆˆì—: ë” ì‘ê²Œ + ì¹¸ìˆ˜ ì¦ê°€) */
    .products{
      padding:12px 14px 14px;
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr)); /* âœ… 4 â†’ 5 */
      gap:8px; /* âœ… ì¡°ê¸ˆ ì´˜ì´˜ */
      align-content:start;
      overflow:auto;
      flex:1;
    }
    @media (max-width: 980px){
      .products{grid-template-columns: repeat(4, minmax(0, 1fr));}
      .pinCard{width:102px;}
    }
    @media (max-width: 520px){
      .products{grid-template-columns: repeat(3, minmax(0, 1fr));}
    }
    .card{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      padding:10px 10px 8px;
      position:relative;
      min-height:74px; /* âœ… ë” ë‚®ê²Œ */
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      user-select:none;
    }
    .card.pinned{
      border-color:rgba(255,77,77,.50);
      box-shadow:0 0 0 2px rgba(255,77,77,.18) inset;
    }
    .card .name{
      font-size:16px;   /* âœ… 18 â†’ 16 */
      font-weight:1300;
      letter-spacing:-.2px;
      line-height:1.12;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .card .price{
      font-size:12px;   /* âœ… ë” ì‘ê²Œ */
      font-weight:900;
      opacity:.68;
      margin-top:6px;
    }
    .card .meta{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      margin-top:8px;
    }
    .badge{
      font-size:11px;
      font-weight:1100;
      opacity:.7;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .pinBtn{
      width:32px; height:32px;
      border-radius:12px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
    }
    .card.pinned .pinBtn{
      background:rgba(255,77,77,.22);
      border-color:rgba(255,77,77,.35);
    }
    .hint{
      padding:0 14px 14px;
      font-size:12px;
      opacity:.70;
      line-height:1.35;
    }

    /* ====== RIGHT ====== */
    .right{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line2);
      border-radius:24px;
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:620px;
    }

    .cartHead{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:rgba(255,255,255,.02);
    }
    .cartHead .t{font-weight:1300; letter-spacing:-.2px;}
    .cartHead .n{font-weight:1100; opacity:.65;}

    .cart{
      padding:8px 10px;
      flex:1;
      overflow:auto;
    }

    /* ì¥ë°”êµ¬ë‹ˆ 1ì¤„ ì••ì¶• (âœ… ë” ë§ì´ ë³´ì´ê²Œ) */
    .item{ padding:8px 8px; border-bottom:1px solid rgba(255,255,255,.06); }
    .itemRow{
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      gap:10px;
    }
    .itemLeft{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }
    .itemName{
      font-size:15px;
      font-weight:1200;
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .itemSub{
      font-size:13px;
      font-weight:900;
      opacity:.70;
      white-space:nowrap;
    }
    .itemCtrls{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .itemCtrls .ctrl{
      width:34px;
      height:34px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      font-size:18px;
      font-weight:1200;
    }
    .itemCtrls .del{
      width:40px;
      height:34px;
      border-radius:10px;
      font-size:18px;
      font-weight:1400;
      background:rgba(255,77,77,.18);
      border:1px solid rgba(255,77,77,.30);
    }

    /* ìš”ì•½ì˜ì—­ (âœ… ìš”ì²­í•œ ë ˆì´ì•„ì›ƒ: ë¼ë²¨ ìœ„ / ê¸ˆì•¡ ì•„ë˜) */
    .summary{
      padding:12px 14px 12px;
      border-top:1px solid var(--line2);
      background:rgba(255,255,255,.015);
    }

    .sumBlock{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding-bottom:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }

    /* ì´í•©ê³„ ë¼ë²¨/ê¸ˆì•¡ */
    .sumLabel{
      font-size:13px;             /* âœ… ì‘ì€ ê¸€ì”¨ */
      font-weight:1100;
      opacity:.78;
      line-height:1;
    }
    .sumMoney{
      font-size:30px;             /* âœ… ê¸ˆì•¡ í¬ê²Œ */
      font-weight:1500;
      letter-spacing:-.3px;
      line-height:1.05;
    }

    /* ë°›ì€ëˆ/ê±°ìŠ¤ë¦„ëˆ: í•œ ì¤„ 2ì¹¸, ì™¼ìª½ì •ë ¬, ë¼ë²¨ ìœ„/ê¸ˆì•¡ ì•„ë˜ */
    .payGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      padding-top:10px;
      align-items:start;
    }
    .payBox{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-start;
      min-width:0;
    }
    .payLabel{
      font-size:13px;             /* âœ… ì´í•©ê³„ì™€ ê°™ì€ ë¼ë²¨ í¬ê¸° */
      font-weight:1100;
      opacity:.78;
      line-height:1;
    }
    .payMoney{
      font-size:26px;             /* âœ… ë°›ì€ëˆ í¬ê²Œ */
      font-weight:1400;
      letter-spacing:-.2px;
      line-height:1.05;
    }
    .payMoney.change{
      font-size:23px;             /* âœ… ê±°ìŠ¤ë¦„ëˆì€ ì•½ê°„ ì‘ê²Œ(ì‹¤ìˆ˜ë°©ì§€ + ê³µê°„) */
      opacity:.92;
    }

    /* ë°›ì€ëˆ ë²„íŠ¼ */
    .money{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
      margin-top:12px;
    }
    .money button{
      height:54px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.92);
      color:#111;
      font-size:18px;
      font-weight:1200;
    }
    .money button#reset{
      background:rgba(255,77,77,.18);
      border-color:rgba(255,77,77,.28);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-weight:1300;
    }

    #pay{
      margin-top:12px;
      width:100%;
      height:64px;
      border-radius:16px;
      background:var(--accent);
      color:#111;
      font-size:22px;
      font-weight:1500;
    }
    #pay.locked{opacity:.55; filter:saturate(.5);}

    /* ê²°ì œ íŒì—… */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .overlay.show{display:flex;}
    .modal{
      width:min(520px, 96vw);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(20,22,28,.98), rgba(14,16,20,.98));
      box-shadow:0 20px 80px rgba(0,0,0,.55);
      padding:18px;
    }
    .modal h3{margin:0 0 10px; font-size:18px; font-weight:1400;}
    .modal p{margin:0 0 16px; opacity:.80; line-height:1.35;}
    .modal .btns{display:flex; gap:10px;}
    .modal .btns button{
      flex:1;
      height:52px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      font-weight:1200;
    }
    .modal .btns .ok{
      background:var(--accent);
      color:#111;
      border-color:rgba(255,159,0,.35);
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT -->
    <section class="left">
      <div class="topbar">
        <div class="tabs" id="tabs"></div>

        <div class="searchRow">
          <div class="search">
            <div class="icon">ğŸ”</div>
            <input id="q" placeholder="ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±ã„´ã„·)" autocomplete="off" />
          </div>
          <button class="sortBtn" id="sortBtn">ì •ë ¬: ê³ ì • + ë§ì´ ì°íŒ ìˆœ</button>
        </div>

        <div class="chos" id="cho"></div>
      </div>

      <div class="pinWrap">
        <div class="pinHead">
          <div class="t1">ê³ ì •(ì „ì²´) Â· ìƒë‹¨ 1ì¤„</div>
          <div class="t2">ê¸¸ê²Œ=ê³ ì • / í´ë¦­=ë‹´ê¸°</div>
        </div>
        <div class="pinStrip" id="pinStrip"></div>
      </div>

      <div class="products" id="products"></div>

      <div class="hint">
        â€» ìƒí’ˆ ê³ ì •(ì „ì²´ ê³µí†µ): <b>ê¸¸ê²Œ ëˆ„ë¥´ê¸°(ëª¨ë°”ì¼)</b> / <b>ìš°í´ë¦­(PC)</b><br/>
        â€» ê²€ìƒ‰ì€ ì¹´í…Œê³ ë¦¬ ë¬´ê´€ + ì´ˆì„±(ã„±ã„´ã„·)ë„ ë©ë‹ˆë‹¤. (X ë²„íŠ¼ì€ ë¹¨ê°„ìƒ‰)
      </div>
    </section>

    <!-- RIGHT -->
    <section class="right">
      <div class="cartHead">
        <div class="t">ì¥ë°”êµ¬ë‹ˆ</div>
        <div class="n" id="cartCount">í•­ëª© 0</div>
      </div>

      <div class="cart" id="cart"></div>

      <div class="summary">
        <div class="sumBlock">
          <div class="sumLabel" id="sumText">ì´í•©ê³„(0ê°œ)</div>
          <div class="sumMoney" id="sumValue">0ì›</div>
        </div>

        <div class="payGrid">
          <div class="payBox">
            <div class="payLabel">ë°›ì€ëˆ</div>
            <div class="payMoney" id="received">0ì›</div>
          </div>
          <div class="payBox">
            <div class="payLabel">ê±°ìŠ¤ë¦„ëˆ</div>
            <div class="payMoney change" id="change">0ì›</div>
          </div>
        </div>

        <div class="money">
          <button data-add="500">500</button>
          <button data-add="1000">1ì²œ</button>
          <button data-add="5000">5ì²œ</button>
          <button data-add="10000">1ë§Œ</button>
          <button data-add="50000">5ë§Œ</button>
          <button id="reset"><span>ğŸ§¹</span>ì´ˆê¸°í™”</button>
        </div>

        <button id="pay">ê²°ì œì™„ë£Œ</button>
      </div>
    </section>
  </div>

  <!-- ê²°ì œ í™•ì¸ ëª¨ë‹¬ -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <h3>ê²°ì œ í™•ì¸</h3>
      <p id="modalText">ê²°ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      <div class="btns">
        <button id="cancelBtn">ì·¨ì†Œ</button>
        <button class="ok" id="okBtn">í™•ì¸</button>
      </div>
    </div>
  </div>

  <script>
  /* =================================================
     ì—„ê°€ë„¤ POS â€“ ë‹¨ì¼íŒŒì¼ (êµ¬ê¸€ì‹œíŠ¸ CSV ì—°ë™ + í•€/ì‚¬ìš©íšŸìˆ˜ ìœ ì§€)
     âœ… ì´ íŒŒì¼ì„ index.htmlë¡œ í†µì§¸ ë³µë¶™í•˜ë©´ ë
  ================================================= */

  /* ===========================
     0) êµ¬ê¸€ì‹œíŠ¸ ì„¤ì •
  =========================== */
  const SHEET_ID = "1MK7TvyILEJ4_YKw1TmY1Au4Z_ZkGbF7LeRMsI89sIbw";
  const GID = "0";
  const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${GID}`;

  /* ===========================
     1) ì €ì¥í‚¤ (ë²„ì „ ì˜¬ë¦¼: ê¼¬ì¸ ë°ì´í„° ë°©ì§€)
  =========================== */
  const LS_ITEMS = "umgane_items_v3";      // ìƒí’ˆ(í•€/ì‚¬ìš©íšŸìˆ˜ í¬í•¨)
  const LS_CART  = "umgane_cart_v3";       // ì¥ë°”êµ¬ë‹ˆ
  const LS_REC   = "umgane_received_v3";   // ë°›ì€ëˆ

  /* ===========================
     2) ê¸°ë³¸ ìƒí’ˆ(ì‹œíŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ ëŒ€ë¹„)
  =========================== */
  const DEFAULT_ITEMS = [
    {id:"p1",  cat:"ê³¼ì¼", name:"ë°”ë‚˜ë‚˜", price:2500, pinned:true,  used:2},
    {id:"p2",  cat:"ê³¼ì¼", name:"í† ë§ˆí† ", price:10000,pinned:true,  used:3},
    {id:"p3",  cat:"ì•¼ì±„", name:"ê°ì",   price:3000, pinned:false, used:1},
    {id:"p4",  cat:"ì•¼ì±„", name:"ì–‘íŒŒ",   price:2500, pinned:false, used:1},
    {id:"p5",  cat:"ìƒì„ ", name:"ê³ ë“±ì–´/1ë§ˆë¦¬", price:3500, pinned:false, used:0},
    {id:"p6",  cat:"ì•¼ì±„", name:"ëŒ€íŒŒ",   price:1800, pinned:false, used:0},
    {id:"p7",  cat:"ì•¼ì±„", name:"ë§ˆëŠ˜",   price:4000, pinned:false, used:0},
    {id:"p8",  cat:"ì•¼ì±„", name:"ë‹¹ê·¼",   price:2000, pinned:false, used:0},
    {id:"p9",  cat:"ë´‰ì±„ì†Œ", name:"ìƒì¶”", price:2000, pinned:false, used:0},
    {id:"p10", cat:"ë´‰ì±„ì†Œ", name:"ê¹»ì", price:2000, pinned:false, used:0},
    {id:"p11", cat:"ìƒì„ ", name:"ì˜¤ì§•ì–´", price:6000, pinned:false, used:0},
    {id:"p12", cat:"ê¸°íƒ€", name:"ê³„ë€",   price:7000, pinned:false, used:0},
  ];

  /* ===========================
     3) ìƒíƒœ
  =========================== */
  let ITEMS = loadItems();                 // âœ… ì‹œíŠ¸ ë°˜ì˜ ì „: ë¡œì»¬/ê¸°ë³¸ìœ¼ë¡œ ë¨¼ì € ëœ¸
  let cart = loadJSON(LS_CART, {});
  let received = Number(localStorage.getItem(LS_REC) || "0") || 0;

  let activeCat = "ì „ì²´";
  let sortMode = "pin_used"; // pin_used â†’ name â†’ price ìˆœí™˜
  let payLocked = false;

  /* ===========================
     4) ìœ í‹¸
  =========================== */
  function loadJSON(key, fallback){
    try{
      const v = localStorage.getItem(key);
      if(!v) return fallback;
      return JSON.parse(v);
    }catch(e){ return fallback; }
  }
  function saveItems(){ localStorage.setItem(LS_ITEMS, JSON.stringify(ITEMS)); }
  function saveCart(){ localStorage.setItem(LS_CART, JSON.stringify(cart)); }
  function saveReceived(){ localStorage.setItem(LS_REC, String(received)); }

  function normalizeItems(list){
    return (Array.isArray(list)?list:[]).map(x=>({
      id: String(x.id || "").trim(),
      cat: (x.cat || "ê¸°íƒ€").toString().trim() || "ê¸°íƒ€",
      name: (x.name || "").toString().trim(),
      price: Number(x.price||0) || 0,
      pinned: !!x.pinned,
      used: Number(x.used||0)||0
    })).filter(x=>x.id && x.name);
  }

  function loadItems(){
    const saved = loadJSON(LS_ITEMS, null);
    if(Array.isArray(saved) && saved.length) return normalizeItems(saved);
    return normalizeItems(DEFAULT_ITEMS);
  }

  function itemMap(){
    const m = {};
    for(const p of ITEMS) m[p.id]=p;
    return m;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function beep(){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type="sine"; o.frequency.value=880;
      g.gain.value=0.06;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
    }catch(e){}
  }

  /* ===========================
     5) âœ… ì½¤ë§ˆ/ë”°ì˜´í‘œ ì•ˆì „ CSV íŒŒì„œ + ì‹œíŠ¸ ë¡œë“œ
  =========================== */
  function parseCSV(text) {
    const rows = [];
    let cur = "", inQ = false;
    let row = [];
    function pushCell(){ row.push(cur); cur=""; }
    function pushRow(){ rows.push(row); row=[]; }

    for (let i=0;i<text.length;i++){
      const ch=text[i];
      if(ch === '"'){
        if(inQ && text[i+1] === '"'){ cur+='"'; i++; }
        else inQ = !inQ;
      } else if(ch === "," && !inQ){
        pushCell();
      } else if((ch === "\n" || ch === "\r") && !inQ){
        if(ch === "\r" && text[i+1] === "\n") i++;
        pushCell();
        if(row.length>1 || (row[0] && row[0].trim())) pushRow();
      } else {
        cur += ch;
      }
    }
    if(cur.length || row.length){ pushCell(); pushRow(); }
    return rows;
  }

  async function loadSheetItems(){
    const res = await fetch(CSV_URL + "&t=" + Date.now(), { cache:"no-store" });
    if(!res.ok) throw new Error("CSV fetch failed: " + res.status);
    const text = await res.text();

    const table = parseCSV(text);
    if(!table || table.length < 2) return [];

    const head = table[0].map(h => (h||"").trim().toLowerCase());
    const idx = (k) => head.indexOf(k);

    // âœ… í—¤ë”ê°€ ì—†ê±°ë‚˜ ì´ë¦„ì´ ë‹¤ë¥´ë©´ ì—¬ê¸°ì„œ ë°”ë¡œ "0" ëœ¨ë‹ˆê¹Œ ë°©ì–´
    if(idx("id") === -1 || idx("name") === -1 || idx("cat") === -1 || idx("price") === -1){
      // í—¤ë”ê°€ ë‹¤ë¥´ë©´, ë„¤ ì‹œíŠ¸ ì²«ì¤„ í—¤ë”ë¥¼ id/cat/name/price/active ë¡œ ë§ì¶°ì•¼ í•¨
      // ê·¸ë˜ë„ ì•±ì´ ë¹„ì–´ë²„ë¦¬ë©´ ì•ˆë˜ë‹ˆê¹Œ ë¹ˆë°°ì—´ ë°˜í™˜(=ë¡œì»¬/ê¸°ë³¸ ìœ ì§€)
      return [];
    }

    const out = [];
    for(let i=1;i<table.length;i++){
      const r = table[i];
      if(!r || !r.length) continue;

      const active = (r[idx("active")] ?? "1").toString().trim();
      if(active === "0") continue;

      const id = (r[idx("id")] ?? "").toString().trim();
      const cat = (r[idx("cat")] ?? "ê¸°íƒ€").toString().trim();
      const name = (r[idx("name")] ?? "").toString().trim();
      const priceRaw = (r[idx("price")] ?? "0").toString();
      const price = Number(priceRaw.replace(/[^\d]/g,"")) || 0;

      if(!id || !name) continue;

      out.push({ id, cat, name, price, pinned:false, used:0 });
    }
    return out;
  }

  // âœ… ì‹œíŠ¸ + ë¡œì»¬(í•€/ì‚¬ìš©íšŸìˆ˜) ë³‘í•©
  async function applySheetMerge(){
    const sheet = await loadSheetItems();
    if(!sheet || !sheet.length) return false; // ì‹¤íŒ¨/ë¹„ì–´ìˆìŒ â†’ ê¸°ì¡´ ìœ ì§€

    const local = itemMap();
    ITEMS = normalizeItems(sheet.map(p=>{
      const old = local[p.id];
      return {
        ...p,
        pinned: old?.pinned || false,
        used: old?.used || 0
      };
    }));
    saveItems();
    return true;
  }

  /* ===========================
     6) ì´ˆì„± ê²€ìƒ‰
  =========================== */
  const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
  function getChoChar(ch){
    const code = ch.charCodeAt(0);
    if(code < 0xAC00 || code > 0xD7A3) return ch;
    const idx = Math.floor((code - 0xAC00) / 588);
    return CHO[idx] || ch;
  }
  function toChoString(str){
    let out="";
    for(const ch of str) out += getChoChar(ch);
    return out;
  }
  function matchQuery(p, q){
    if(!q) return true;
    const name = p.name || "";
    const q2 = q.trim();
    if(name.includes(q2)) return true;
    const nCho = toChoString(name);
    if(nCho.includes(q2)) return true;
    if(name.replace(/\s+/g,"").includes(q2.replace(/\s+/g,""))) return true;
    if(nCho.replace(/\s+/g,"").includes(q2.replace(/\s+/g,""))) return true;
    return false;
  }

  /* ===========================
     7) ë Œë”
  =========================== */
  const tabsEl = document.getElementById("tabs");
  const productsEl = document.getElementById("products");
  const pinStripEl = document.getElementById("pinStrip");
  const cartEl = document.getElementById("cart");
  const cartCountEl = document.getElementById("cartCount");

  function categories(){
    const set = new Set(["ì „ì²´"]);
    ITEMS.forEach(p=>set.add(p.cat));
    return Array.from(set);
  }

  function renderTabs(){
    tabsEl.innerHTML="";
    const cats = categories();
    cats.forEach(cat=>{
      const b = document.createElement("button");
      b.className="tab"+(cat===activeCat?" active":"");
      b.textContent=cat;
      b.onclick=()=>{ activeCat=cat; renderProducts(); };
      tabsEl.appendChild(b);
    });
  }

  function renderCho(){
    const choEl = document.getElementById("cho");
    choEl.innerHTML="";
    const keys = ["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
    keys.forEach(k=>{
      const b=document.createElement("button");
      b.textContent=k;
      b.onclick=()=>{
        const qEl=document.getElementById("q");
        qEl.value = (qEl.value||"") + k;
        renderProducts();
        qEl.focus();
      };
      choEl.appendChild(b);
    });
    const clear=document.createElement("button");
    clear.className="clear";
    clear.textContent="X";
    clear.title="ê²€ìƒ‰ ì§€ìš°ê¸°";
    clear.onclick=()=>{
      const qEl=document.getElementById("q");
      qEl.value="";
      renderProducts();
      qEl.focus();
    };
    choEl.appendChild(clear);
  }

  function sortItems(list){
    const arr = [...list];
    if(sortMode==="pin_used"){
      arr.sort((a,b)=>{
        const ap=a.pinned?1:0, bp=b.pinned?1:0;
        if(bp!==ap) return bp-ap;
        if((b.used||0)!==(a.used||0)) return (b.used||0)-(a.used||0);
        return a.name.localeCompare(b.name,"ko");
      });
    }else if(sortMode==="name"){
      arr.sort((a,b)=>a.name.localeCompare(b.name,"ko"));
    }else if(sortMode==="price"){
      arr.sort((a,b)=>(a.price||0)-(b.price||0));
    }
    return arr;
  }

  function renderPinStrip(){
    pinStripEl.innerHTML="";
    const pins = ITEMS.filter(p=>p.pinned)
      .sort((a,b)=>(b.used||0)-(a.used||0))
      .slice(0, 80);
    if(!pins.length){
      const d=document.createElement("div");
      d.style.opacity=.6;
      d.style.padding="8px 2px";
      d.textContent="ê³ ì • ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. (ìƒí’ˆì¹´ë“œ ê¸¸ê²Œ ëˆŒëŸ¬ ê³ ì •)";
      pinStripEl.appendChild(d);
      return;
    }
    pins.forEach(p=>{
      const c=document.createElement("button");
      c.className="pinCard";
      c.onclick=()=>addToCart(p.id, 1, true);
      c.oncontextmenu=(e)=>{ e.preventDefault(); togglePin(p.id); };
      c.innerHTML = `
        <div class="pinI">ğŸ“Œ</div>
        <div class="name">${escapeHtml(p.name)}</div>
        <div class="price">${p.price.toLocaleString()}ì›</div>
      `;
      pinStripEl.appendChild(c);
    });
  }

  function renderProducts(){
    const q = (document.getElementById("q").value||"").trim();
    let list = ITEMS;

    if(activeCat!=="ì „ì²´") list = list.filter(p=>p.cat===activeCat);
    list = list.filter(p=>matchQuery(p, q));
    list = sortItems(list);

    productsEl.innerHTML="";
    if(!list.length){
      const empty=document.createElement("div");
      empty.style.opacity=.7;
      empty.style.padding="12px";
      empty.textContent="ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
      productsEl.appendChild(empty);
      renderPinStrip();
      return;
    }

    list.forEach(p=>{
      const card=document.createElement("button");
      card.className="card"+(p.pinned?" pinned":"");
      card.onclick=()=>addToCart(p.id, 1, true);

      // ëª¨ë°”ì¼ ê¸¸ê²Œ ëˆ„ë¥´ê¸°(í•€ í† ê¸€)
      let pressTimer=null;
      card.ontouchstart=()=>{ pressTimer=setTimeout(()=>togglePin(p.id), 520); };
      card.ontouchend=()=>{ if(pressTimer) clearTimeout(pressTimer); };

      // PC ìš°í´ë¦­(í•€ í† ê¸€)
      card.oncontextmenu=(e)=>{ e.preventDefault(); togglePin(p.id); };

      card.innerHTML=`
        <div>
          <div class="name">${escapeHtml(p.name)}</div>
          <div class="price">${p.price.toLocaleString()}ì›</div>
        </div>
        <div class="meta">
          <div class="badge">ì‚¬ìš© ${p.used||0}</div>
          <div class="pinBtn" title="ê³ ì • í† ê¸€">ğŸ“Œ</div>
        </div>
      `;
      productsEl.appendChild(card);
    });

    renderPinStrip();
  }

  function sumCart(){
    const map = itemMap();
    let sum=0, qty=0;
    for(const id in cart){
      const q=cart[id]||0;
      if(q<=0) continue;
      const p=map[id];
      if(!p) continue;
      sum += p.price*q;
      qty += q;
    }
    return {sum, qty};
  }

  function renderCart(){
    const map = itemMap();
    const keys = Object.keys(cart).filter(id=>cart[id]>0 && map[id]);

    cartCountEl.textContent = `í•­ëª© ${keys.length}`;

    const {sum, qty} = sumCart();
    document.getElementById("sumText").textContent = `ì´í•©ê³„(${qty}ê°œ)`;
    document.getElementById("sumValue").textContent = `${sum.toLocaleString()}ì›`;

    document.getElementById("received").textContent = `${received.toLocaleString()}ì›`;
    document.getElementById("change").textContent   = `${Math.max(0, received - sum).toLocaleString()}ì›`;

    cartEl.innerHTML="";
    if(!keys.length){
      const d=document.createElement("div");
      d.style.opacity=.65;
      d.style.padding="12px 10px";
      d.textContent="â€”";
      cartEl.appendChild(d);
      return;
    }

    keys.forEach(id=>{
      const p=map[id], qn=cart[id];
      const item=document.createElement("div");
      item.className="item";
      item.innerHTML = `
        <div class="itemRow" title="ë‹¨ê°€ ${p.price.toLocaleString()}ì›">
          <div class="itemLeft">
            <div class="itemName">${escapeHtml(p.name)} <span style="opacity:.75">x${qn}</span></div>
            <div class="itemSub">${(p.price*qn).toLocaleString()}ì›</div>
          </div>
          <div class="itemCtrls">
            <button class="ctrl" data-act="minus">âˆ’</button>
            <button class="ctrl" data-act="plus">+</button>
            <button class="del" data-act="del">Ã—</button>
          </div>
        </div>
      `;
      item.querySelector('[data-act="minus"]').onclick=()=>addToCart(id, -1, false);
      item.querySelector('[data-act="plus"]').onclick =()=>addToCart(id,  1, false);
      item.querySelector('[data-act="del"]').onclick  =()=>{ delete cart[id]; saveCart(); renderCart(); };
      cartEl.appendChild(item);
    });
  }

  /* ===========================
     8) ë™ì‘
  =========================== */
  function addToCart(id, delta, countUsed){
    const map=itemMap();
    if(!map[id]) return;

    cart[id] = (cart[id]||0) + delta;
    if(cart[id] <= 0) delete cart[id];
    saveCart();

    if(countUsed){
      const p = map[id];
      p.used = (p.used||0) + 1;
      saveItems();
    }
    renderPinStrip();
    renderProducts();
    renderCart();
  }

  function togglePin(id){
    const map=itemMap();
    const p=map[id];
    if(!p) return;
    p.pinned = !p.pinned;
    saveItems();
    renderPinStrip();
    renderProducts();
  }

  /* ===========================
     9) ë²„íŠ¼/ì´ë²¤íŠ¸
  =========================== */
  document.getElementById("sortBtn").onclick=()=>{
    const btn = document.getElementById("sortBtn");
    if(sortMode==="pin_used"){ sortMode="name";  btn.textContent="ì •ë ¬: ì´ë¦„ ìˆœ"; }
    else if(sortMode==="name"){ sortMode="price"; btn.textContent="ì •ë ¬: ê°€ê²© ë‚®ì€ ìˆœ"; }
    else { sortMode="pin_used"; btn.textContent="ì •ë ¬: ê³ ì • + ë§ì´ ì°íŒ ìˆœ"; }
    renderProducts();
  };

  document.getElementById("q").addEventListener("input", ()=>renderProducts());

  document.querySelectorAll('.money button[data-add]').forEach(b=>{
    b.onclick=()=>{
      received += Number(b.dataset.add||0);
      saveReceived();
      renderCart();
    };
  });

  document.getElementById("reset").onclick=()=>{
    received = 0;
    saveReceived();
    renderCart();
  };

  const overlay=document.getElementById("overlay");
  const payBtn=document.getElementById("pay");
  const okBtn=document.getElementById("okBtn");
  const cancelBtn=document.getElementById("cancelBtn");
  const modalText=document.getElementById("modalText");

  payBtn.onclick=()=>{
    if(payLocked) return;
    const {sum, qty} = sumCart();
    modalText.textContent = (qty===0)
      ? "ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤."
      : `ì´í•©ê³„(${qty}ê°œ) ${sum.toLocaleString()}ì› Â· ê²°ì œì™„ë£Œ ì²˜ë¦¬í• ê¹Œìš”?`;
    overlay.classList.add("show");
    beep();
  };
  cancelBtn.onclick=()=>overlay.classList.remove("show");
  okBtn.onclick=()=>{
    overlay.classList.remove("show");
    beep();

    payLocked=true;
    payBtn.classList.add("locked");

    setTimeout(()=>{
      cart = {};
      received = 0;
      saveCart();
      saveReceived();
      renderCart();

      payLocked=false;
      payBtn.classList.remove("locked");
    }, 700);
  };

  /* ===========================
     10) ìƒˆë¡œê³ ì¹¨/ìƒˆíƒ­ ë¡œë“œì‹œ ì •ì±…
     - ì¥ë°”êµ¬ë‹ˆ + ë°›ì€ëˆë§Œ ìë™ ë¦¬ì…‹
     - í•€/ì‚¬ìš©íšŸìˆ˜ëŠ” ìœ ì§€
  =========================== */
  function resetCartAndReceivedOnly(){
    cart = {};
    received = 0;
    saveCart();
    saveReceived();
  }
  window.addEventListener("pageshow", ()=>{
    resetCartAndReceivedOnly();
    renderCart();
  });

  /* ===========================
     11) ì‹œì‘ (âœ… ë¡œì»¬/ê¸°ë³¸ ë¨¼ì € ëœ¨ê³ , ì‹œíŠ¸ ì„±ê³µí•˜ë©´ êµì²´)
  =========================== */
  async function boot(){
    renderTabs();
    renderCho();
    renderProducts();
    renderCart();

    // ì‹œíŠ¸ ì ìš©(ì„±ê³µí•˜ë©´ íƒ­/ëª©ë¡ ë‹¤ì‹œ ê·¸ë¦¼)
    try{
      const ok = await applySheetMerge();
      if(ok){
        // ì¹´í…Œê³ ë¦¬ê°€ ë°”ë€” ìˆ˜ ìˆìœ¼ë‹ˆ íƒ­ ë‹¤ì‹œ ìƒì„±
        if(activeCat !== "ì „ì²´" && !categories().includes(activeCat)) activeCat = "ì „ì²´";
        renderTabs();
        renderProducts();
        renderCart();
      }
    }catch(e){
      console.warn("[sheet] load failed:", e);
      // ì‹¤íŒ¨í•´ë„ ê¸°ì¡´(ë¡œì»¬/ê¸°ë³¸) ìœ ì§€
    }
  }
  boot();
  </script>
</body>
</html>
