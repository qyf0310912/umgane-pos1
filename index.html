<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>POS</title>
  <style>
    :root{
      --bg:#10141b;
      --panel:#151c26;
      --card:#1b2432;
      --cardHover:#202b3c;
      --line:rgba(255,255,255,.11);

      --text:#f3f6ff;
      --muted:rgba(243,246,255,.72);
      --muted2:rgba(243,246,255,.52);

      --accent:#ff9f00;
      --good:#29d17e;
      --danger:#ff3b30;

      --btn:#f5f6f8;
      --btnText:#111;

      --shadow:0 14px 44px rgba(0,0,0,.42);
    }

    *{box-sizing:border-box;}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Apple SD Gothic Neo", Arial;}
    button,input{font:inherit;}

    /* ì „ì²´ ë ˆì´ì•„ì›ƒ: 3/1 ê³ ì • */
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 3fr 1fr;
      gap:16px;
      padding:16px;
    }

    .cardShell{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:0;
    }

    /* LEFT */
    .left{display:flex; flex-direction:column; min-height:0;}
    .leftHeader{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      background:rgba(0,0,0,.08);
    }

    /* "ë¼íŒ¡ POS"ì€ ìˆ¨ê¹€(í•„ìš”í•˜ë©´ display:block) */
    .brand{display:none; font-weight:1000; font-size:18px; letter-spacing:.2px;}

    .tabs{display:flex; gap:8px; flex-wrap:wrap;}
    .tab{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      padding:9px 13px;
      border-radius:999px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
      font-size:14px;
    }
    .tab.active{
      background:rgba(255,159,0,.18);
      border-color:rgba(255,159,0,.35);
      color:#ffd9a3;
    }

    .searchWrap{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      gap:10px;
      align-items:center;
      background:rgba(0,0,0,.05);
    }
    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      background:rgba(255,255,255,.05);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
    }
    .search input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:15px;
      font-weight:900;
    }
    .pill{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
    }
    .pill b{color:var(--text);}

    /* ì´ˆì„± ë²„íŠ¼ ë°” */
    .chosungBar{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      padding:8px 12px 10px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.04);
    }
    .chobtn{
      min-width:36px;
      height:34px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(243,246,255,.95);
      font-weight:1100;
      cursor:pointer;
      user-select:none;
    }
    .chobtn:active{ transform:scale(.96); }
    .chobtn.clear{
      background:rgba(255,59,48,.14);
      border-color:rgba(255,59,48,.35);
      color:#ffd1cf;
    }

    .leftBody{
      padding:12px;
      min-height:0;
      overflow:auto;
    }

    /* íš¡ì—´ 4~5ê°œ */
    .grid{
      display:grid;
      gap:12px;
      grid-template-columns: repeat(5, minmax(0, 1fr));
    }
    @media (max-width: 1280px){ .grid{ grid-template-columns: repeat(4, minmax(0,1fr)); } }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .grid{ grid-template-columns: repeat(4, minmax(0,1fr)); }
    }
    @media (max-width: 560px){ .grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }

    /* ìƒí’ˆ ì¹´ë“œ */
    .pbtn{
      width:100%;
      text-align:left;
      cursor:pointer;
      user-select:none;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      padding:12px 12px;
      min-height:82px;
      transition:transform .03s ease, background .15s ease, border-color .15s ease;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
      position:relative;
      outline:none;
    }
    .pbtn:hover{ background:rgba(255,255,255,.07); }
    .pbtn:active{ transform:scale(.99); }

    /* âœ… ì—°íƒ€ ê°•ì¡° í”Œë˜ì‹œ */
    .pbtn.flash{
      border-color: rgba(255,159,0,.55);
      box-shadow: 0 0 0 3px rgba(255,159,0,.18), var(--shadow);
      background: rgba(255,159,0,.10);
    }

    .pname{
      font-weight:1200;
      font-size:18px;
      letter-spacing:.1px;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pprice{
      font-weight:1000;
      font-size:14px;
      color:rgba(243,246,255,.82);
    }
    .pmeta{
      margin-top:2px;
      font-size:11px;
      color:rgba(243,246,255,.55);
      font-weight:900;
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(255,159,0,.13);
      border:1px solid rgba(255,159,0,.22);
      color:#ffd9a3;
      font-weight:1000;
    }
    .pinIcon{
      position:absolute;
      top:10px;
      right:10px;
      font-size:14px;
      opacity:.95;
      display:none;
    }
    .pbtn.pinned .pinIcon{ display:block; }

    /* RIGHT */
    .right{display:flex; flex-direction:column; min-height:0;}

    .rightTop{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.07);
    }
    .sum{ font-size:22px; font-weight:1200; letter-spacing:.1px; }
    .count{ margin-top:4px; color:var(--muted); font-weight:1000; font-size:12px; }

    .divider{ height:1px; background:var(--line); margin:10px 0; }

    .payline{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      font-weight:1100;
    }
    .payline .label{ font-size:12px; font-weight:1000; color:rgba(243,246,255,.72); }
    .payline .val{ font-size:18px; font-weight:1200; }

    /* ëˆë²„íŠ¼ 3ê°œì”© 2ì¤„(3ì—´) */
    .paybox{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .moneyBtn{
      background:var(--btn);
      color:var(--btnText);
      border:none;
      border-radius:14px;
      padding:12px 10px;
      font-weight:1200;
      font-size:16px;
      cursor:pointer;
      user-select:none;
    }
    .moneyBtn:active{ transform:scale(.99); }
    .resetBtn{
      background:rgba(255,255,255,.10);
      color:rgba(243,246,255,.92);
      border:1px solid rgba(255,255,255,.18);
    }

    .rightBody{
      padding:10px 12px 12px;
      min-height:0;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .cart{
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .cartHead{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      color:rgba(243,246,255,.82);
      font-weight:1100;
      font-size:13px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      background:rgba(0,0,0,.06);
    }

    /* âœ… ì¥ë°”êµ¬ë‹ˆ 7ê°œ ì´ìƒ ë…¸ì¶œ(í•´ìƒë„ ë‹¬ë¼ë„ ì•ˆì •) */
    .cartList{
      padding:8px;
      overflow:auto;
      min-height: 520px;
      height: calc(100vh - 420px);
      max-height: 700px;
    }

    .item{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.16);
      margin-bottom:8px;
      align-items:center;
    }
    .iname{
      font-weight:1200;
      font-size:14px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .iprice{
      font-size:12px;
      font-weight:1000;
      color:rgba(243,246,255,.65);
      margin-top:4px;
    }
    .qtyBox{ display:flex; align-items:center; gap:8px; }
    .qbtn{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:rgba(243,246,255,.95);
      font-weight:1200;
      font-size:18px;
      cursor:pointer;
    }
    .qnum{ min-width:28px; text-align:center; font-weight:1200; font-size:14px; }
    .del{
      width:38px; height:34px;
      border-radius:12px;
      border:1px solid rgba(255,59,48,.35);
      background:rgba(255,59,48,.14);
      color:#ffd1cf;
      font-weight:1200;
      cursor:pointer;
    }

    .payBtn{
      margin-top:auto;
      background:var(--accent);
      color:#19150a;
      border:none;
      border-radius:16px;
      padding:14px 12px;
      font-weight:1300;
      font-size:18px;
      cursor:pointer;
      transition:opacity .15s ease, filter .15s ease;
    }
    .payBtn:active{ transform:scale(.99); }
    .payBtn.locked{
      opacity:.55;
      cursor:not-allowed;
      filter:saturate(.6);
    }

    /* POPUP */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .overlay.show{ display:flex; }
    .modal{
      width:min(520px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(17,19,25,.95), rgba(12,13,18,.95));
      box-shadow:0 18px 70px rgba(0,0,0,.55);
      padding:18px;
    }
    .modal h2{ margin:0 0 8px; font-size:22px; font-weight:1300; }
    .modal .meta{ color:rgba(243,246,255,.76); font-weight:1000; font-size:13px; line-height:1.6; }
    .modal .actions{ margin-top:14px; display:flex; gap:10px; justify-content:flex-end; }
    .mBtn{ border:none; border-radius:14px; padding:10px 14px; font-weight:1200; cursor:pointer; }
    .mOk{ background:var(--good); color:#072213; }
    .mMute{ background:rgba(255,255,255,.08); color:rgba(243,246,255,.9); border:1px solid rgba(255,255,255,.14); }
  </style>
</head>

<body>
  <div class="app">
    <!-- LEFT -->
    <section class="cardShell left">
      <div class="leftHeader">
        <div class="brand">ë¼íŒ¡ POS</div>
        <div class="tabs" id="tabs"></div>
      </div>

      <div class="searchWrap">
        <div class="search" title="ì „ì¹´í…Œê³ ë¦¬ í†µí•© ê²€ìƒ‰ / ì´ˆì„±ê²€ìƒ‰ ê°€ëŠ¥">
          <span style="opacity:.7;font-weight:900;">ğŸ”</span>
          <input id="q" placeholder="ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±ã„±)" autocomplete="off" />
        </div>
        <div class="pill">ì •ë ¬: <b>ê³ ì • + ë§ì´ ì°íŒ ìˆœ</b></div>
      </div>

      <div class="chosungBar" id="chosungBar"></div>

      <div class="leftBody">
        <div class="grid" id="grid"></div>
        <div style="margin-top:10px; color:rgba(243,246,255,.45); font-size:12px; font-weight:900;">
          â€» ìƒí’ˆ ê³ ì •: ê¸¸ê²Œ ëˆ„ë¥´ê¸°(ëª¨ë°”ì¼) / ìš°í´ë¦­(PC)
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="cardShell right">
      <div class="rightTop">
        <div class="sum">ì´í•©ê³„: <span id="sum">0</span>ì›</div>
        <div class="count">ì´ìˆ˜ëŸ‰: <span id="totalQty">0</span></div>

        <div class="divider"></div>

        <div class="payline">
          <div>
            <div class="label">ë°›ì€ëˆ</div>
            <div class="val"><span id="received">0</span>ì›</div>
          </div>
          <div style="opacity:.5; font-weight:1100;">|</div>
          <div style="text-align:right;">
            <div class="label">ê±°ìŠ¤ë¦„ëˆ</div>
            <div class="val"><span id="change">0</span>ì›</div>
          </div>
        </div>

        <!-- ëˆë²„íŠ¼: 3ê°œ x 2ì¤„ -->
        <div class="paybox">
          <button class="moneyBtn" data-add="500">500</button>
          <button class="moneyBtn" data-add="1000">1ì²œ</button>
          <button class="moneyBtn" data-add="5000">5ì²œ</button>
          <button class="moneyBtn" data-add="10000">1ë§Œ</button>
          <button class="moneyBtn" data-add="50000">5ë§Œ</button>
          <button class="moneyBtn resetBtn" id="resetReceived">ì´ˆê¸°í™”</button>
        </div>
      </div>

      <div class="rightBody">
        <div class="cart">
          <div class="cartHead">
            <div>ì¥ë°”êµ¬ë‹ˆ (ìˆ˜ëŸ‰ ì¡°ì ˆ + ì‚­ì œ)</div>
            <div style="opacity:.85;">í•­ëª© <span id="cartCount">0</span></div>
          </div>
          <div class="cartList" id="cartList"></div>
        </div>

        <button class="payBtn" id="pay">ê²°ì œì™„ë£Œ</button>
      </div>
    </section>
  </div>

  <!-- POPUP -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <h2>ê²°ì œ ì™„ë£Œ âœ…</h2>
      <div class="meta" id="receiptMeta"></div>
      <div class="actions">
        <button class="mBtn mMute" id="toggleSound">ì™„ë£ŒìŒ: ON</button>
        <button class="mBtn mOk" id="closeModal">í™•ì¸</button>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  ì¹´í…Œê³ ë¦¬(ê³ ì • ê¸°ì¤€)
 *  ========================= */
const CATEGORIES = ["ê³¼ì¼","ì•¼ì±„","ë´‰ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];

/** =========================
 *  ìƒí’ˆ ë°ì´í„°(ì˜ˆì‹œ) - ì—¬ê¸°ë§Œ ê³„ì† ì¶”ê°€í•˜ë©´ ë¨
 *  ========================= */
const PRODUCTS = [
  // ê³¼ì¼(ì˜ˆì‹œ)
  { id:"fruit_dangam3", cat:"ê³¼ì¼", name:"ë‹¨ê°/3ê°œ", price:5000 },
  { id:"fruit_dangam7", cat:"ê³¼ì¼", name:"ë‹¨ê°/7ê°œ", price:10000 },
  { id:"fruit_apple3", cat:"ê³¼ì¼", name:"ì‚¬ê³¼/3ê°œ", price:5000 },
  { id:"fruit_apple7", cat:"ê³¼ì¼", name:"ì‚¬ê³¼/7ê°œ", price:10000 },
  { id:"fruit_daebong6", cat:"ê³¼ì¼", name:"ëŒ€ë´‰/6ê°œ", price:5000 },
  { id:"fruit_daebong13", cat:"ê³¼ì¼", name:"ëŒ€ë´‰/13ê°œ", price:10000 },
  { id:"fruit_tanger9", cat:"ê³¼ì¼", name:"ê·¤/9ê°œ", price:3000 },
  { id:"fruit_tanger20", cat:"ê³¼ì¼", name:"ê·¤/20ê°œ", price:6000 },
  { id:"fruit_shine2", cat:"ê³¼ì¼", name:"ìƒ¤ì¸/2ì†¡ì´", price:8000 },
  { id:"fruit_kiwi", cat:"ê³¼ì¼", name:"í‚¤ìœ„", price:10000 },
  { id:"fruit_pomegranate1", cat:"ê³¼ì¼", name:"ì„ë¥˜/1ê°œ", price:3500 },
  { id:"fruit_pomegranate3", cat:"ê³¼ì¼", name:"ì„ë¥˜/3ê°œ", price:10000 },
  { id:"fruit_banana", cat:"ê³¼ì¼", name:"ë°”ë‚˜ë‚˜", price:2500 },
  { id:"fruit_pineapple", cat:"ê³¼ì¼", name:"íŒŒì¸ì• í”Œ", price:4000 },
  { id:"fruit_straw1", cat:"ê³¼ì¼", name:"ë”¸ê¸°/1íŒ©", price:8000 },
  { id:"fruit_straw2", cat:"ê³¼ì¼", name:"ë”¸ê¸°/2íŒ©", price:15000 },
  { id:"fruit_tomato", cat:"ê³¼ì¼", name:"í† ë§ˆí† ", price:10000 },
  { id:"fruit_cherryTom1", cat:"ê³¼ì¼", name:"ë°©ìš¸í† ë§ˆí† /1íŒ©", price:6000 },
  { id:"fruit_cherryTom2", cat:"ê³¼ì¼", name:"ë°©ìš¸í† ë§ˆí† /2íŒ©", price:11000 },
  { id:"fruit_cherry", cat:"ê³¼ì¼", name:"ì²´ë¦¬", price:12000 },

  // ì•¼ì±„(ì˜ˆì‹œ)
  { id:"veg_onion", cat:"ì•¼ì±„", name:"ì–‘íŒŒ(ë§)", price:3000 },
  { id:"veg_potato", cat:"ì•¼ì±„", name:"ê°ì(ë´‰)", price:3000 },
  { id:"veg_carrot", cat:"ì•¼ì±„", name:"ë‹¹ê·¼(ë´‰)", price:3000 },

  // ë´‰ì±„ì†Œ/ìƒì„ /ê¸°íƒ€ëŠ” í•„ìš” ì‹œ ì¶”ê°€
];

/** =========================
 *  ì´ˆì„±ê²€ìƒ‰ ìœ í‹¸
 *  ========================= */
const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
function getChosung(str){
  let out = "";
  for (const ch of str){
    const code = ch.charCodeAt(0);
    if (code >= 0xAC00 && code <= 0xD7A3){
      const idx = Math.floor((code - 0xAC00) / 588);
      out += CHO[idx] || "";
    } else if (/[ã„±-ã…]/.test(ch)){
      out += ch;
    } else if (/[A-Za-z0-9]/.test(ch)){
      out += ch.toLowerCase();
    }
  }
  return out;
}
function normalize(s){
  return (s||"").toString().trim().replace(/\s+/g,"").toLowerCase();
}
function matchProduct(p, qRaw){
  const q = normalize(qRaw);
  if (!q) return true;
  const nameN = normalize(p.name);
  const choN  = normalize(getChosung(p.name));
  return nameN.includes(q) || choN.includes(q);
}

/** =========================
 *  ì €ì¥(ê³ ì •/ì‚¬ìš©íšŸìˆ˜)
 *  ========================= */
const LS_KEY_COUNTS = "lapang_pos_counts_v3";
const LS_KEY_PINS   = "lapang_pos_pins_v3";
function loadJSON(key, def){
  try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(def)); }
  catch{ return def; }
}
function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }

let counts = loadJSON(LS_KEY_COUNTS, {}); // {id: n}
let pins   = loadJSON(LS_KEY_PINS,   {}); // {id: true}

/** =========================
 *  ìƒíƒœ
 *  ========================= */
let activeCat = "ê³¼ì¼";
let cart = {};           // {productId: qty}
let receivedMoney = 0;
let soundOn = true;

/* âœ… ê²°ì œ 1ì´ˆ ì ê¸ˆ */
let payLocked = false;

/** =========================
 *  DOM
 *  ========================= */
const $tabs = document.getElementById("tabs");
const $grid = document.getElementById("grid");
const $q = document.getElementById("q");

/** =========================
 *  ë Œë”: íƒ­
 *  ========================= */
function renderTabs(){
  $tabs.innerHTML = "";
  CATEGORIES.forEach(cat=>{
    const b = document.createElement("button");
    b.className = "tab" + (cat===activeCat ? " active":"");
    b.textContent = cat;
    b.onclick = ()=>{ activeCat = cat; renderAll(); };
    $tabs.appendChild(b);
  });
}

/** =========================
 *  ì •ë ¬: 1) ê³ ì • 2) ë§ì´ ì°íŒ ìˆœ 3) ì´ë¦„
 *  ========================= */
function getSortedProducts(list){
  return [...list].sort((a,b)=>{
    const pa = !!pins[a.id], pb = !!pins[b.id];
    if (pb !== pa) return (pb?1:0) - (pa?1:0);

    const ca = counts[a.id] || 0;
    const cb = counts[b.id] || 0;
    if (cb !== ca) return cb - ca;

    return a.name.localeCompare(b.name, "ko");
  });
}

/** =========================
 *  í”Œë˜ì‹œ(ì—°íƒ€ í”¼ë“œë°±)
 *  ========================= */
const flashTimers = {};
function flashCard(el, id){
  if (!el) return;
  el.classList.add("flash");
  clearTimeout(flashTimers[id]);
  flashTimers[id] = setTimeout(()=> el.classList.remove("flash"), 160);
}

/** =========================
 *  ê³ ì •(í•€) í† ê¸€: ê¸¸ê²Œëˆ„ë¥´ê¸°/ìš°í´ë¦­
 *  ========================= */
function togglePin(id){
  pins[id] = !pins[id];
  if (!pins[id]) delete pins[id];
  saveJSON(LS_KEY_PINS, pins);
  renderAll();
}

/** =========================
 *  ë Œë”: ìƒí’ˆ ê·¸ë¦¬ë“œ
 *  ========================= */
function renderGrid(){
  const query = $q.value;

  let list = [];
  if (normalize(query)){
    list = PRODUCTS.filter(p => matchProduct(p, query));
  } else {
    list = PRODUCTS.filter(p => p.cat === activeCat);
  }

  list = getSortedProducts(list);

  $grid.innerHTML = "";
  list.forEach(p=>{
    const btn = document.createElement("button");
    btn.className = "pbtn" + (pins[p.id] ? " pinned" : "");
    const used = counts[p.id] || 0;

    btn.innerHTML = `
      <div class="pinIcon">ğŸ“Œ</div>
      <div class="pname">${p.name}</div>
      <div class="pprice">${formatWon(p.price)}ì›</div>
      <div class="pmeta">
        <span>${normalize(query) ? `<span class="badge">${p.cat}</span>` : (pins[p.id] ? `<span class="badge">ê³ ì •</span>` : "")}</span>
        <span style="opacity:.75">ì‚¬ìš© ${used}</span>
      </div>
    `;

    /* âœ… ì¹´ë“œ ì•„ë¬´ë°ë‚˜ ëˆ„ë¥´ë©´ ë‹´ê¹€ + í”Œë˜ì‹œ */
    btn.onclick = ()=>{
      addToCart(p.id, 1);
      counts[p.id] = (counts[p.id] || 0) + 1;
      saveJSON(LS_KEY_COUNTS, counts);
      flashCard(btn, p.id);
      renderAll();
    };

    /* âœ… PC: ìš°í´ë¦­ ê³ ì •/í•´ì œ */
    btn.oncontextmenu = (e)=>{
      e.preventDefault();
      togglePin(p.id);
      return false;
    };

    /* âœ… ëª¨ë°”ì¼: ê¸¸ê²Œëˆ„ë¥´ê¸° ê³ ì •/í•´ì œ */
    let pressTimer = null;
    btn.addEventListener("touchstart", ()=>{
      pressTimer = setTimeout(()=> togglePin(p.id), 520);
    }, {passive:true});
    btn.addEventListener("touchend", ()=>{ clearTimeout(pressTimer); }, {passive:true});
    btn.addEventListener("touchmove", ()=>{ clearTimeout(pressTimer); }, {passive:true});

    $grid.appendChild(btn);
  });
}

/** =========================
 *  ë Œë”: ì¥ë°”êµ¬ë‹ˆ
 *  ========================= */
function renderCart(){
  const $list = document.getElementById("cartList");
  const ids = Object.keys(cart);
  document.getElementById("cartCount").textContent = ids.length;

  if (!ids.length){
    $list.innerHTML = `<div style="padding:14px 10px; color:rgba(243,246,255,.55); font-weight:1000;">ë‹´ê¸´ ìƒí’ˆ ì—†ìŒ</div>`;
    return;
  }

  const items = ids
    .map(id => ({ p: PRODUCTS.find(x=>x.id===id), qty: cart[id] }))
    .filter(x=>x.p);

  // ì‹¬í”Œ: ê³ ì •/ì‚¬ìš©ìˆœì— ë§ì¶° ì •ë ¬(ë³µì¡í•œ ê°€ê²©ì •ë ¬ X)
  items.sort((a,b)=>{
    const pa = !!pins[a.p.id], pb = !!pins[b.p.id];
    if (pb !== pa) return (pb?1:0) - (pa?1:0);

    const ca = counts[a.p.id] || 0;
    const cb = counts[b.p.id] || 0;
    if (cb !== ca) return cb - ca;

    return a.p.name.localeCompare(b.p.name,"ko");
  });

  $list.innerHTML = "";
  items.forEach(({p,qty})=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div>
        <div class="iname">${p.name} <span style="opacity:.75;font-weight:1200;">x${qty}</span></div>
        <div class="iprice">${formatWon(p.price)}ì› Â· í•© ${formatWon(p.price*qty)}ì›</div>
      </div>
      <div class="qtyBox">
        <button class="qbtn" data-act="minus">-</button>
        <div class="qnum">${qty}</div>
        <button class="qbtn" data-act="plus">+</button>
        <button class="del" title="ì‚­ì œ">âœ•</button>
      </div>
    `;
    row.querySelector('[data-act="minus"]').onclick = ()=> setQty(p.id, qty-1);
    row.querySelector('[data-act="plus"]').onclick  = ()=> setQty(p.id, qty+1);
    row.querySelector('.del').onclick = ()=> removeItem(p.id);
    $list.appendChild(row);
  });
}

function calcTotal(){
  let sum = 0, qty = 0;
  for (const id of Object.keys(cart)){
    const p = PRODUCTS.find(x=>x.id===id);
    if (!p) continue;
    sum += p.price * cart[id];
    qty += cart[id];
  }
  return {sum, qty};
}

function renderTotals(){
  const {sum, qty} = calcTotal();
  document.getElementById("sum").textContent = formatWon(sum);
  document.getElementById("totalQty").textContent = qty;

  document.getElementById("received").textContent = formatWon(receivedMoney);
  const change = Math.max(0, receivedMoney - sum);
  document.getElementById("change").textContent = formatWon(change);

  // pay ë²„íŠ¼ ë½ UI ë°˜ì˜
  const payBtn = document.getElementById("pay");
  payBtn.classList.toggle("locked", payLocked);
}

function renderAll(){
  renderTabs();
  renderGrid();
  renderCart();
  renderTotals();
}

/** =========================
 *  ì¹´íŠ¸ ì¡°ì‘
 *  ========================= */
function addToCart(id, n){
  cart[id] = (cart[id] || 0) + n;
  if (cart[id] <= 0) delete cart[id];
}
function setQty(id, q){
  if (q <= 0) delete cart[id];
  else cart[id] = q;
  renderAll();
}
function removeItem(id){
  delete cart[id];
  renderAll();
}

/** =========================
 *  ëˆ ë²„íŠ¼
 *  ========================= */
document.querySelectorAll(".moneyBtn[data-add]").forEach(btn=>{
  btn.onclick = ()=>{
    const add = Number(btn.getAttribute("data-add") || 0);
    receivedMoney += add;
    renderTotals();
  };
});
document.getElementById("resetReceived").onclick = ()=>{
  receivedMoney = 0; // ì´ˆê¸°í™”ëŠ” ë°›ì€ëˆë§Œ ë¦¬ì…‹
  renderTotals();
};

/** =========================
 *  ì´ˆì„± ë²„íŠ¼ ìƒì„±
 *  ========================= */
const CHOS = ["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
const $chosungBar = document.getElementById("chosungBar");
function renderChosung(){
  $chosungBar.innerHTML = "";
  CHOS.forEach(c=>{
    const b = document.createElement("button");
    b.className = "chobtn";
    b.textContent = c;
    b.onclick = ()=>{
      $q.value += c;   // ëˆ„ì 
      renderGrid();    // ì¦‰ì‹œ ë°˜ì˜
    };
    $chosungBar.appendChild(b);
  });

  const clr = document.createElement("button");
  clr.className = "chobtn clear";
  clr.textContent = "âœ•";
  clr.onclick = ()=>{
    $q.value = "";
    renderGrid();
  };
  $chosungBar.appendChild(clr);
}
renderChosung();

/** =========================
 *  ê²°ì œì™„ë£Œ + íŒì—… + ì‚¬ìš´ë“œ + 1ì´ˆ ì ê¸ˆ
 *  ========================= */
const $overlay = document.getElementById("overlay");
const $receiptMeta = document.getElementById("receiptMeta");
const $toggleSound = document.getElementById("toggleSound");

function beep(){
  if (!soundOn) return;
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.value = 880;
    g.gain.value = 0.05;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 180);
  }catch(e){}
}

function lockPayFor1s(){
  payLocked = true;
  renderTotals();
  setTimeout(()=>{
    payLocked = false;
    renderTotals();
  }, 1000);
}

document.getElementById("pay").onclick = ()=>{
  if (payLocked) return; // âœ… ì¤‘ë³µ í´ë¦­ ë°©ì§€
  lockPayFor1s();

  const {sum, qty} = calcTotal();
  if (sum <= 0){
    alert("ë‹´ê¸´ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const change = Math.max(0, receivedMoney - sum);
  $receiptMeta.innerHTML = `
    ì´ì•¡: <b>${formatWon(sum)}ì›</b><br/>
    ì´ìˆ˜ëŸ‰: <b>${qty}</b><br/>
    ë°›ì€ëˆ: <b>${formatWon(receivedMoney)}ì›</b><br/>
    ê±°ìŠ¤ë¦„ëˆ: <b>${formatWon(change)}ì›</b>
  `;

  $overlay.classList.add("show");
  beep();

  // ê²°ì œì™„ë£Œ = ì „ì²´ ë¦¬ì…‹(ì™„ë£Œê°)
  cart = {};
  receivedMoney = 0;
  renderAll();
};

document.getElementById("closeModal").onclick = ()=> $overlay.classList.remove("show");
$overlay.addEventListener("click",(e)=>{ if (e.target === $overlay) $overlay.classList.remove("show"); });

$toggleSound.onclick = ()=>{
  soundOn = !soundOn;
  $toggleSound.textContent = "ì™„ë£ŒìŒ: " + (soundOn ? "ON" : "OFF");
};

/** =========================
 *  ê²€ìƒ‰(íƒ€ì´í•‘ ë°˜ì˜)
 *  ========================= */
let qTimer = null;
$q.addEventListener("input", ()=>{
  clearTimeout(qTimer);
  qTimer = setTimeout(()=> renderGrid(), 30);
});

/** =========================
 *  ê¸°íƒ€
 *  ========================= */
function formatWon(n){
  n = Math.round(Number(n)||0);
  return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// ì´ˆê¸° ë Œë”
renderAll();
</script>
</body>
</html>
