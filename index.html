<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ì—„ê°€ë„¤ í˜„ì¥ ê³„ì‚°ê¸°</title>

  <style>
    :root{
      --bg:#0b0b10; --panel:#0f0f16; --card:#171725; --stroke:#2a2a3a;
      --text:#f2f2f6; --muted:#a7a7b6; --accent:#ff9f0a; --ok:#2ee06a; --bad:#ff3b30;
      --paid:#60a5fa; --chg:#34d399;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo",system-ui,Segoe UI,Roboto,sans-serif; }
    header{
      height:56px; display:flex; align-items:center; justify-content:center;
      background:var(--accent); color:#111; font-weight:1000; letter-spacing:-.2px;
      position:sticky; top:0; z-index:10;
    }

    /* ===== Layout 70/30 ===== */
    .wrap{ height:calc(100vh - 56px); display:flex; gap:12px; padding:12px; }
    .left{ width:70%; min-width:0; display:flex; flex-direction:column; gap:10px; }
    .right{ width:30%; min-width:320px; background:var(--panel); border:1px solid var(--stroke);
      border-radius:16px; overflow:hidden; display:flex; flex-direction:column; }

    /* ===== Cats + Search ===== */
    .topline{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .cats{ display:flex; gap:8px; flex-wrap:wrap; }
    .cat{
      padding:10px 14px; border-radius:999px; border:1px solid var(--stroke);
      background:#13131d; color:var(--muted); font-weight:1000; cursor:pointer; user-select:none;
    }
    .cat.on{ background:var(--accent); color:#111; border:none; }
    .search{ flex:1; min-width:240px; }
    .search input{
      width:100%; padding:12px 14px; border-radius:14px; border:1px solid var(--stroke);
      background:#0f0f16; color:var(--text); font-size:16px; font-weight:900; outline:none;
    }
    .search input::placeholder{ color:#7e7e92; }

    /* ===== Products grid ===== */
    .gridWrap{
      flex:1; min-height:0; border:1px solid var(--stroke); border-radius:16px;
      background:linear-gradient(180deg,#10101a,#0b0b10);
      padding:10px; overflow:auto;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(4, minmax(0, 1fr)); /* âœ… 4ì—´ ê³ ì • */
      gap:10px;
    }
    .pbtn{
      height:86px; border-radius:16px; border:1px solid var(--stroke);
      background:#171725; color:var(--text); cursor:pointer; user-select:none;
      padding:12px 10px;
      display:flex; flex-direction:column; justify-content:space-between; align-items:center; text-align:center;
    }
    .pname{
      font-size:20px; font-weight:1100; letter-spacing:-.3px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%;
    }
    .pprice{
      font-size:13px; font-weight:1000; color:var(--muted);
    }

    /* ===== Right: summary fixed ===== */
    .sumBar{
      padding:12px 14px; border-bottom:1px solid var(--stroke); background:#0e0e16;
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
    }
    .sumLeft{ font-size:28px; font-weight:1200; letter-spacing:-.4px; }
    .sumRight{ font-size:16px; font-weight:1000; color:var(--muted); white-space:nowrap; }

    /* ===== Cart list scroll only ===== */
    .cart{
      flex:1; min-height:0; overflow:auto; padding:10px;
      display:flex; flex-direction:column; gap:8px;
    }
    .row{
      border:1px solid var(--stroke); border-radius:14px; background:#13131d;
      padding:10px 10px; display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center;
    }
    .rLeft{ min-width:0; }
    .rName{ font-size:15px; font-weight:1100; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .rSub{ margin-top:4px; font-size:12px; color:var(--muted); font-weight:900; display:flex; gap:10px; }
    .rRight{ display:flex; align-items:center; gap:8px; white-space:nowrap; }
    .rQty{
      font-size:14px; font-weight:1100; color:var(--accent);
      padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:#10101a;
    }
    .trash{
      width:42px; height:38px; border:none; border-radius:12px; cursor:pointer;
      background:var(--bad); color:#fff; font-size:16px; font-weight:1100;
    }

    /* ===== Payment block fixed ===== */
    .payBox{
      border-top:1px solid var(--stroke);
      padding:12px;
      background:#0e0e16;
    }
    .paidLine{
      border:1px solid var(--stroke); border-radius:14px; background:#121222;
      padding:12px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:10px;
    }
    .paidLine .label{ color:var(--muted); font-weight:1000; }
    .paidLine .nums{ display:flex; gap:14px; font-weight:1200; letter-spacing:-.3px; font-size:18px; }
    .paid{ color:var(--paid); }
    .chg{ color:var(--chg); }

    .moneyBtns{
      display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-bottom:10px;
    }
    .moneyBtns button{
      height:54px; border-radius:14px; border:1px solid var(--stroke);
      background:#f1f1f1; color:#111; font-size:18px; font-weight:1100; cursor:pointer;
    }
    .moneyBtns .reset{
      background:var(--bad); color:#fff; border:none;
    }
    .payBtn{
      width:100%; height:68px; border:none; border-radius:16px; cursor:pointer;
      background:var(--ok); color:#111; font-size:24px; font-weight:1200;
    }

    /* Small screens: stack */
    @media (max-width: 900px){
      .wrap{ flex-direction:column; height:auto; }
      .left,.right{ width:100%; }
      .right{ min-width:0; }
      .grid{ grid-template-columns:repeat(4, minmax(0, 1fr)); }
    }
  </style>
</head>

<body>
<header>ì—„ê°€ë„¤ í˜„ì¥ ê³„ì‚°ê¸°</header>

<div class="wrap">
  <!-- LEFT 70% -->
  <section class="left">
    <div class="topline">
      <div class="cats" id="cats"></div>
      <div class="search">
        <input id="q" placeholder="ê²€ìƒ‰ (ì˜ˆ: ã„±, ê³ êµ¬ë§ˆ, ê°ì)" />
      </div>
    </div>

    <div class="gridWrap">
      <div class="grid" id="grid"></div>
    </div>
  </section>

  <!-- RIGHT 30% -->
  <aside class="right">
    <div class="sumBar">
      <div class="sumLeft" id="sumText">â‚©0</div>
      <div class="sumRight" id="cntText">ì´ 0ê°œ</div>
    </div>

    <div class="cart" id="cart"></div>

    <div class="payBox">
      <div class="paidLine">
        <div class="label">ë°›ì€ëˆ / ê±°ìŠ¤ë¦„</div>
        <div class="nums">
          <span class="paid" id="paidText">â‚©0</span>
          <span class="chg" id="chgText">â‚©0</span>
        </div>
      </div>

      <div class="moneyBtns">
        <button onclick="addMoney(1000)">1ì²œ</button>
        <button onclick="addMoney(5000)">5ì²œ</button>
        <button onclick="addMoney(10000)">1ë§Œ</button>
        <button onclick="addMoney(30000)">3ë§Œ</button>
        <button onclick="addMoney(50000)">5ë§Œ</button>
        <!-- âœ… 10ë§Œ ì‚­ì œ, ê·¸ ìë¦¬ì— ì´ˆê¸°í™”(ë°›ì€ëˆë§Œ) -->
        <button class="reset" onclick="resetMoneyOnly()">ì´ˆê¸°í™”</button>
      </div>

      <button class="payBtn" onclick="complete()">ê²°ì œ ì™„ë£Œ</button>
    </div>
  </aside>
</div>

<script>
/* =========================================================
   âœ… (2ë²ˆ) ë°ì´í„° ì—°ê²°: êµ¬ê¸€ì‹œíŠ¸ CSV ë¶™ì—¬ë„£ê¸°
   - ì‹œíŠ¸: category,name,unit,price (í—¤ë” í¬í•¨)
   - ê³µê°œ: íŒŒì¼ > ê³µìœ  > ì›¹ì— ê²Œì‹œ > CSV
   - ì•„ë˜ SHEET_URLì— ë„£ìœ¼ë©´ ìë™ ë¡œë“œë¨
   ========================================================= */
const SHEET_URL = ""; // ì˜ˆ: "https://docs.google.com/spreadsheets/d/e/XXXX/pub?output=csv"

/* =========================================================
   âœ… ìƒ˜í”Œ í’ˆëª© (SHEET_URL ë¹„ì›Œë‘ë©´ ì´ê±¸ë¡œ ë™ì‘)
   - ë¬¶ìŒìƒí’ˆì€ 'ë‹¤ë¥¸ í’ˆëª©'ìœ¼ë¡œ ë„£ìœ¼ë©´ ë
   ========================================================= */
const ITEMS_FALLBACK = [
  {category:"ê³¼ì¼", name:"ë‹¨ê° 3ê°œ", unit:"ê°œ", price:5000},
  {category:"ê³¼ì¼", name:"ë‹¨ê° 7ê°œ", unit:"ê°œ", price:10000},
  {category:"ê³¼ì¼", name:"ì‚¬ê³¼ 3ê°œ", unit:"ê°œ", price:5000},
  {category:"ê³¼ì¼", name:"ì‚¬ê³¼ 7ê°œ", unit:"ê°œ", price:10000},
  {category:"ê³¼ì¼", name:"ë°”ë‚˜ë‚˜", unit:"ê°œ", price:2500},
  {category:"ì•¼ì±„", name:"ê°ì", unit:"ê°œ", price:3000},
  {category:"ì•¼ì±„", name:"ê³ êµ¬ë§ˆ", unit:"ê°œ", price:3000},
  {category:"ì•¼ì±„", name:"ì–‘íŒŒ", unit:"ê°œ", price:2500},
  {category:"ì•¼ì±„", name:"ì• í˜¸ë°• 3ê°œ", unit:"ê°œ", price:3500},
  {category:"ìì±„ì†Œ", name:"ìƒì¶”", unit:"ë´‰", price:1000},
  {category:"ìƒì„ ", name:"ì˜¤ì§•ì–´ 1ë§ˆë¦¬", unit:"ë§ˆë¦¬", price:3000},
];

/* ===== ì¹´í…Œê³ ë¦¬ (ê³ ì •) ===== */
const CATEGORIES = ["ê³¼ì¼","ì•¼ì±„","ìì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];

/* ===== ìƒíƒœ ===== */
let ITEMS = [];
let activeCat = "ê³¼ì¼";
let query = "";
let paid = 0;

/* cartMap: key=name|price -> {name, price, unit, category, qty} */
const cartMap = new Map();

/* ===== ìœ í‹¸ ===== */
const money = n => "â‚©" + (n||0).toLocaleString("ko-KR");

function calcTotals(){
  let total = 0, count = 0;
  cartMap.forEach(v => { total += v.price * v.qty; count += v.qty; });
  return { total, count };
}
function updateMoneyLine(){
  const { total } = calcTotals();
  document.getElementById("paidText").innerText = money(paid);
  document.getElementById("chgText").innerText = money(Math.max(paid - total, 0));
}

/* =========================================================
   âœ… ì´ˆì„± ê²€ìƒ‰ (ã„±,ã„´,ã„·â€¦ + ì¼ë°˜ ë¶€ë¶„ê²€ìƒ‰ ëª¨ë‘ ì§€ì›)
   ========================================================= */
const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
function getChosung(str){
  let out = "";
  for(const ch of str){
    const code = ch.charCodeAt(0);
    if(code >= 0xAC00 && code <= 0xD7A3){
      const idx = Math.floor((code - 0xAC00) / (21 * 28));
      out += CHO[idx] || "";
    } else {
      out += ch;
    }
  }
  return out;
}
function matchQuery(name, q){
  if(!q) return true;
  const s = (name||"").toLowerCase();
  const qq = q.toLowerCase();
  if(s.includes(qq)) return true;                 // ì¼ë°˜ í¬í•¨
  const cs = getChosung(name);
  if(cs.includes(q)) return true;                 // ì´ˆì„± í¬í•¨ (ã„±ã„± ë“±)
  return false;
}

/* ===== ë Œë” ===== */
function renderCats(){
  const el = document.getElementById("cats");
  el.innerHTML = "";
  CATEGORIES.forEach(cat=>{
    const b = document.createElement("div");
    b.className = "cat" + (cat===activeCat ? " on" : "");
    b.textContent = cat;
    b.onclick = ()=>{ activeCat = cat; renderAll(); };
    el.appendChild(b);
  });
}

function getFilteredItems(){
  return ITEMS
    .filter(x => (activeCat==="ê¸°íƒ€" ? true : x.category === activeCat))
    .filter(x => matchQuery(x.name, query));
}

function renderGrid(){
  const grid = document.getElementById("grid");
  grid.innerHTML = "";
  const list = getFilteredItems();

  list.forEach(item=>{
    const btn = document.createElement("button");
    btn.className = "pbtn";
    btn.innerHTML = `
      <div class="pname" title="${escapeHtml(item.name)}">${escapeHtml(item.name)}</div>
      <div class="pprice">${money(item.price)}</div>
    `;
    btn.onclick = ()=> addItem(item);
    grid.appendChild(btn);
  });
}

function renderCart(){
  const cart = document.getElementById("cart");
  cart.innerHTML = "";

  if(cartMap.size === 0){
    cart.innerHTML = `<div style="color:#8d8da3;font-weight:1000;padding:8px;">(ë¹„ì–´ìˆìŒ)</div>`;
  } else {
    [...cartMap.values()].forEach(v=>{
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="rLeft">
          <div class="rName">${escapeHtml(v.name)}</div>
          <div class="rSub">
            <span>ë‹¨ê°€ ${money(v.price)}</span>
            <span>í•©ê³„ ${money(v.price * v.qty)}</span>
          </div>
        </div>
        <div class="rRight">
          <div class="rQty">x${v.qty}</div>
          <button class="trash" title="ì‚­ì œ">ğŸ—‘</button>
        </div>
      `;
      row.querySelector(".trash").onclick = ()=> { cartMap.delete(v.key); renderAll(); };
      cart.appendChild(row);
    });
  }

  const { total, count } = calcTotals();
  document.getElementById("sumText").innerText = money(total);
  document.getElementById("cntText").innerText = `ì´ ${count}ê°œ`;
  updateMoneyLine();
}

function renderAll(){
  renderCats();
  renderGrid();
  renderCart();
}

/* ===== ì•¡ì…˜ ===== */
function addItem(item){
  const key = `${item.name}__${item.price}`; // ì´ë¦„+ê°€ê²© ê¸°ì¤€(ë¬¶ìŒì€ ì´ë¦„ì´ ë‹¤ë¦„)
  const prev = cartMap.get(key);
  if(prev){
    prev.qty += 1;
  } else {
    cartMap.set(key, {
      key, category:item.category, name:item.name, unit:item.unit||"", price:Number(item.price)||0, qty:1
    });
  }
  renderAll();
}

function addMoney(n){
  paid += n;
  updateMoneyLine();
}
function resetMoneyOnly(){
  paid = 0;
  updateMoneyLine();
}
function complete(){
  const { total, count } = calcTotals();
  if(count === 0){
    alert("í’ˆëª©ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
    return;
  }
  const change = Math.max(paid - total, 0);
  alert(`ê²°ì œ ì™„ë£Œ\nì´í•©ê³„: ${money(total)}\nì´ê°¯ìˆ˜: ${count}ê°œ\në°›ì€ëˆ: ${money(paid)}\nê±°ìŠ¤ë¦„: ${money(change)}`);

  // ê²°ì œ í›„: ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê³  ë°›ì€ëˆë„ 0
  cartMap.clear();
  paid = 0;
  renderAll();
}

/* ===== CSV ë¡œë“œ ===== */
async function loadFromSheet(url){
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error("ì‹œíŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
  const text = await res.text();

  // ê°„ë‹¨ CSV íŒŒì„œ(ë”°ì˜´í‘œ ì—†ëŠ” ê¸°ë³¸ CSV ê¸°ì¤€)
  const lines = text.trim().split(/\r?\n/);
  if(lines.length < 2) return [];
  const header = lines[0].split(",").map(s=>s.trim().toLowerCase());
  const idxC = header.indexOf("category");
  const idxN = header.indexOf("name");
  const idxU = header.indexOf("unit");
  const idxP = header.indexOf("price");

  const out = [];
  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split(",").map(s=>s.trim());
    const category = cols[idxC] || "";
    const name = cols[idxN] || "";
    const unit = cols[idxU] || "";
    const price = Number((cols[idxP]||"").replace(/[^\d]/g,""));
    if(!category || !name || !price) continue;
    out.push({ category, name, unit, price });
  }
  return out;
}

/* ===== ë³´ì•ˆìš© escape ===== */
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ===== Init ===== */
document.getElementById("q").addEventListener("input", (e)=>{
  query = (e.target.value||"").trim();
  renderAll();
});

(async function init(){
  try{
    if(SHEET_URL){
      ITEMS = await loadFromSheet(SHEET_URL);
      if(!ITEMS.length) ITEMS = ITEMS_FALLBACK;
    } else {
      ITEMS = ITEMS_FALLBACK;
    }
  } catch(e){
    ITEMS = ITEMS_FALLBACK;
    alert("ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨ â†’ ì„ì‹œ í’ˆëª©ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.\n(SHEET_URL í™•ì¸ í•„ìš”)");
  }
  renderAll();
})();
</script>
</body>
</html>
