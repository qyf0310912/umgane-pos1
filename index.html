<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ì—„ê°€ë„¤ POS (ë‹¨ì¼íŒŒì¼)</title>
  <style>
    :root{
      --bg:#0b0c10;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.07);
      --text:#f5f7ff;
      --muted:rgba(245,247,255,.68);
      --accent:#ff9f00;
      --shadow:0 12px 40px rgba(0,0,0,.38);
    }
    *{box-sizing:border-box;}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;}
    button{font:inherit; cursor:pointer; border:0; background:transparent; color:inherit;}

    .app{
      height:100%;
      display:grid;
      grid-template-columns: 1fr 420px;
      gap:14px;
      padding:14px;
    }
    @media (max-width: 980px){
      .app{grid-template-columns:1fr; grid-template-rows:auto auto;}
      .right{min-height:520px;}
    }

    /* ====== LEFT ====== */
    .left{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line2);
      border-radius:24px;
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    /* âœ… ìƒë‹¨(íƒ­/ê²€ìƒ‰/ì´ˆì„±) ë†’ì´ ë‹¤ì´ì–´íŠ¸ */
    .topbar{
      padding:10px 12px 8px;
      border-bottom:1px solid var(--line2);
      background:rgba(255,255,255,.02);
    }
    .tabs{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .tab{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      font-weight:900;
      font-size:13px;
      opacity:.92;
    }
    .tab.active{
      outline:2px solid rgba(255,159,0,.35);
      border-color:rgba(255,159,0,.35);
      color:var(--accent);
      background:rgba(255,159,0,.10);
    }
    .searchRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20);
    }
    .search .icon{opacity:.7;}
    #q{
      width:100%;
      border:0;
      outline:0;
      background:transparent;
      color:var(--text);
      font-size:15px;
      font-weight:900;
    }
    .sortBtn{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }

    /* ì´ˆì„± ë²„íŠ¼ (ì‘ê²Œ) */
    .chos{
      margin-top:8px;
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
    }
    .chos button{
      width:32px;
      height:32px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      font-weight:1100;
      font-size:13px;
      opacity:.92;
    }
    .chos .clear{
      width:36px;
      background:rgba(255,77,77,.22);
      border-color:rgba(255,77,77,.35);
      font-weight:1400;
      color:#fff;
    }

    /* ê³ ì •(ì „ì²´ ê³µí†µ) 1ì¤„ (ì»´íŒ©íŠ¸) */
    .pinWrap{
      padding:10px 12px 8px;
      border-bottom:1px solid var(--line2);
      background:rgba(255,255,255,.015);
    }
    .pinHead{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      margin-bottom:6px;
    }
    .pinHead .t1{font-weight:1200; opacity:.92;}
    .pinHead .t2{font-size:11px; opacity:.65;}
    .pinStrip{
      display:flex;
      gap:8px;
      overflow-x:auto;
      overflow-y:hidden;
      padding-bottom:2px;
      scrollbar-width:thin;
      -webkit-overflow-scrolling:touch;
      white-space:nowrap;
    }
    .pinCard{
      flex:0 0 auto;
      width:96px;
      height:48px;
      border-radius:12px;
      border:1px solid rgba(255,159,0,.25);
      background:rgba(255,159,0,.08);
      padding:7px 8px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      position:relative;
    }
    .pinCard .name{font-weight:1200; font-size:13px; line-height:1.1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .pinCard .price{font-size:11px; opacity:.70; font-weight:900; margin-top:3px;}
    .pinCard .pinI{
      position:absolute; right:6px; top:6px;
      width:18px; height:18px;
      border-radius:7px;
      display:grid; place-items:center;
      background:rgba(255,77,77,.25);
      border:1px solid rgba(255,77,77,.35);
      color:#fff;
      font-size:11px;
    }

    /* âœ… ìƒí’ˆ ë¦¬ìŠ¤íŠ¸: 4ì—´ â†’ 6ì—´(ê¸°ë³¸) + ì¹´ë“œ ì¶•ì†Œ */
    .products{
      padding:10px 12px 12px;
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap:8px;
      align-content:start;
      overflow:auto;
      flex:1;
    }
    @media (max-width: 1200px){
      .products{ grid-template-columns: repeat(5, minmax(0, 1fr)); }
    }
    @media (max-width: 980px){
      .products{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
    @media (max-width: 520px){
      .products{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    .card{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      padding:10px 10px 8px;
      position:relative;
      min-height:64px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      user-select:none;
    }
    .card.pinned{
      border-color:rgba(255,77,77,.50);
      box-shadow:0 0 0 2px rgba(255,77,77,.18) inset;
    }
    .card .name{
      font-size:16px;
      font-weight:1400;
      letter-spacing:-.2px;
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .card .price{
      font-size:12px;
      font-weight:1000;
      opacity:.60;
      margin-top:5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .card .meta{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      margin-top:6px;
    }
    .badge{
      font-size:11px;
      font-weight:1100;
      opacity:.7;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .pinBtn{
      width:30px; height:30px;
      border-radius:10px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      flex:0 0 auto;
    }
    .card.pinned .pinBtn{
      background:rgba(255,77,77,.22);
      border-color:rgba(255,77,77,.35);
    }

    .hint{
      padding:0 12px 12px;
      font-size:12px;
      opacity:.70;
      line-height:1.35;
    }

    /* ====== RIGHT ====== */
    .right{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line2);
      border-radius:24px;
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .cartHead{
      padding:12px 14px 10px;
      border-bottom:1px solid var(--line2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:rgba(255,255,255,.02);
    }
    .cartHead .t{
      font-weight:1300;
      letter-spacing:-.2px;
    }
    .cartHead .n{
      font-weight:1100;
      opacity:.65;
      font-size:12px;
    }

    .cart{
      padding:6px 10px;
      flex:1;
      overflow:auto;
    }

    /* ì¥ë°”êµ¬ë‹ˆ 1ì¤„ ì••ì¶• + ë” ë§ì´ ë³´ì´ê²Œ */
    .item{
      padding:8px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .itemRow{
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      gap:10px;
    }
    .itemLeft{
      display:flex;
      align-items:baseline;
      gap:10px;
      min-width:0;
    }
    .itemName{
      font-size:15px;
      font-weight:1200;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
      flex:1;
    }
    .itemSub{
      font-size:14px;
      font-weight:900;
      opacity:.70;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .itemCtrls{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    .itemCtrls .ctrl{
      width:34px;
      height:34px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      font-size:18px;
      font-weight:1200;
    }
    .itemCtrls .del{
      width:40px;
      height:34px;
      border-radius:10px;
      font-size:18px;
      font-weight:1400;
      background:rgba(255,77,77,.18);
      border:1px solid rgba(255,77,77,.30);
    }

    /* âœ… ìš”ì•½ì˜ì—­: ì´í•©ê³„/ë°›ì€ëˆ/ê±°ìŠ¤ë¦„ëˆ ëª¨ë‘ "ë¼ë²¨ ìœ„ / ê¸ˆì•¡ ì•„ë˜" */
    .summary{
      padding:12px 14px 12px;
      border-top:1px solid var(--line2);
      background:rgba(255,255,255,.015);
    }
    .sumBlock{
      display:flex;
      flex-direction:column;
      gap:12px; /* âœ… ì´í•©ê³„ â†” ë°›ì€ëˆ/ê±°ìŠ¤ë¦„ëˆ ê°„ê²© ë™ì¼ */
    }
    .blk{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:6px;
      min-width:0;
    }
    .blkLabel{
      font-size:13px;  /* âœ… ì‘ì€ê¸€ì”¨(ìœ„) */
      font-weight:1100;
      opacity:.78;
      letter-spacing:-.1px;
    }
    .blkValue{
      font-size:30px;  /* âœ… ì´í•©ê³„ í¬ê²Œ */
      font-weight:1500;
      letter-spacing:-.3px;
      line-height:1.05;
      white-space:nowrap;
    }
    .blkRow{
      display:grid;
      grid-template-columns: 1fr 1fr; /* âœ… ë°›ì€ëˆ(ì™¼) / ê±°ìŠ¤ë¦„ëˆ(ì˜¤) í•œì¤„ */
      gap:18px;
      align-items:start;
    }
    .blkRow .blkValue{
      font-size:26px; /* âœ… ë°›ì€ëˆ ê¸°ë³¸ í¬ê²Œ */
      font-weight:1450;
    }
    .blkValueChange{
      font-size:22px; /* âœ… ê±°ìŠ¤ë¦„ëˆì€ ì¡°ê¸ˆ ë” ì‘ê²Œ(ì‹¤ìˆ˜ ë°©ì§€/ê³µê°„í™•ë³´) */
      font-weight:1400;
      opacity:.95;
    }

    /* ë°›ì€ëˆ ë²„íŠ¼: ì‚´ì§ ì¤„ì—¬ ê³µê°„ í™•ë³´ + ê²°ì œì™„ë£Œ ì˜¤í´ë¦­ ë°©ì§€ */
    .money{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
      margin-top:10px;
    }
    .money button{
      height:50px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.92);
      color:#111;
      font-size:17px;
      font-weight:1200;
    }
    .money button#reset{
      background:rgba(255,77,77,.18);
      border-color:rgba(255,77,77,.28);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-weight:1300;
    }

    #pay{
      margin-top:14px; /* âœ… ë‹¨ìœ„ë²„íŠ¼ê³¼ ê²°ì œì™„ë£Œ ê°„ê²© í™•ë³´ */
      width:100%;
      height:62px;
      border-radius:16px;
      background:var(--accent);
      color:#111;
      font-size:22px;
      font-weight:1500;
    }
    #pay.locked{opacity:.55; filter:saturate(.5);}

    /* ê²°ì œ íŒì—… */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .overlay.show{display:flex;}
    .modal{
      width:min(520px, 96vw);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(20,22,28,.98), rgba(14,16,20,.98));
      box-shadow:0 20px 80px rgba(0,0,0,.55);
      padding:18px;
    }
    .modal h3{margin:0 0 10px; font-size:18px; font-weight:1400;}
    .modal p{margin:0 0 16px; opacity:.80; line-height:1.35;}
    .modal .btns{display:flex; gap:10px;}
    .modal .btns button{
      flex:1;
      height:52px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      font-weight:1200;
    }
    .modal .btns .ok{
      background:var(--accent);
      color:#111;
      border-color:rgba(255,159,0,.35);
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT -->
    <section class="left">
      <div class="topbar">
        <div class="tabs" id="tabs"></div>

        <div class="searchRow">
          <div class="search">
            <div class="icon">ğŸ”</div>
            <input id="q" placeholder="ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±ã„´ã„·)" autocomplete="off" />
          </div>
          <button class="sortBtn" id="sortBtn">ì •ë ¬: ê³ ì • + ë§ì´ ì°íŒ ìˆœ</button>
        </div>

        <div class="chos" id="cho"></div>
      </div>

      <div class="pinWrap">
        <div class="pinHead">
          <div class="t1">ê³ ì •(ì „ì²´) Â· ìƒë‹¨ 1ì¤„</div>
          <div class="t2">ê¸¸ê²Œ=ê³ ì • / í´ë¦­=ë‹´ê¸°</div>
        </div>
        <div class="pinStrip" id="pinStrip"></div>
      </div>

      <div class="products" id="products"></div>

      <div class="hint">
        â€» ìƒí’ˆ ê³ ì •(ì „ì²´ ê³µí†µ): <b>ê¸¸ê²Œ ëˆ„ë¥´ê¸°(ëª¨ë°”ì¼)</b> / <b>ìš°í´ë¦­(PC)</b><br/>
        â€» ê²€ìƒ‰ì€ ì¹´í…Œê³ ë¦¬ ë¬´ê´€ + ì´ˆì„±(ã„±ã„´ã„·)ë„ ë©ë‹ˆë‹¤.
      </div>
    </section>

    <!-- RIGHT -->
    <section class="right">
      <div class="cartHead">
        <div class="t">ì¥ë°”êµ¬ë‹ˆ</div>
        <div class="n" id="cartCount">í•­ëª© 0</div>
      </div>

      <div class="cart" id="cart"></div>

      <div class="summary">
        <div class="sumBlock">
          <!-- ì´í•©ê³„ -->
          <div class="blk">
            <div class="blkLabel" id="sumText">ì´í•©ê³„(0ê°œ)</div>
            <div class="blkValue" id="sumValue">0ì›</div>
          </div>

          <!-- âœ… ë°›ì€ëˆ / ê±°ìŠ¤ë¦„ëˆ í•œì¤„ -->
          <div class="blkRow">
            <div class="blk">
              <div class="blkLabel">ë°›ì€ëˆ</div>
              <div class="blkValue" id="received">0ì›</div>
            </div>
            <div class="blk">
              <div class="blkLabel">ê±°ìŠ¤ë¦„ëˆ</div>
              <div class="blkValue blkValueChange" id="change">0ì›</div>
            </div>
          </div>
        </div>

        <div class="money">
          <button data-add="500">500</button>
          <button data-add="1000">1ì²œ</button>
          <button data-add="5000">5ì²œ</button>
          <button data-add="10000">1ë§Œ</button>
          <button data-add="50000">5ë§Œ</button>
          <button id="reset"><span>ğŸ§¹</span>ì´ˆê¸°í™”</button>
        </div>

        <button id="pay">ê²°ì œì™„ë£Œ</button>
      </div>
    </section>
  </div>

  <!-- ê²°ì œ í™•ì¸ ëª¨ë‹¬ -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <h3>ê²°ì œ í™•ì¸</h3>
      <p id="modalText">ê²°ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      <div class="btns">
        <button id="cancelBtn">ì·¨ì†Œ</button>
        <button class="ok" id="okBtn">í™•ì¸</button>
      </div>
    </div>
  </div>


   <script>
/* =================================================
   ì—„ê°€ë„¤ POS â€“ ë‹¨ì¼íŒŒì¼ JS (êµ¬ê¸€ì‹œíŠ¸ ì—°ë™ ìµœì¢…ë³¸)
   ğŸ‘‰ ì´ ìŠ¤í¬ë¦½íŠ¸ í•˜ë‚˜ë§Œ ìˆìœ¼ë©´ ë¨
================================================= */

/* ===========================
   0) ì €ì¥ í‚¤
=========================== */
const LS_ITEMS = "umgane_items_v2";   // í•€/ì‚¬ìš©íšŸìˆ˜
const LS_CART  = "umgane_cart_v2";    // ì¥ë°”êµ¬ë‹ˆ
const LS_REC   = "umgane_received_v2";// ë°›ì€ëˆ

/* ===========================
   1) êµ¬ê¸€ì‹œíŠ¸ ì„¤ì • (ë„ˆê°€ ë§Œë“  ì‹œíŠ¸)
=========================== */
const SHEET_ID = "1MK7TvyILEJ4_YKw1TmY1Au4Z_ZkGbF7LeRMsI89sIbw";
const GID = "0";
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${GID}`;

/*
ì‹œíŠ¸ ì»¬ëŸ¼ ì˜ˆì‹œ (ì²« ì¤„ í—¤ë”)
id | cat | name | price | active
active = 1 â†’ ì‚¬ìš© / 0 â†’ ìˆ¨ê¹€
*/

/* ===========================
   2) ìƒíƒœ
=========================== */
let ITEMS = loadJSON(LS_ITEMS, []);
let cart = loadJSON(LS_CART, {});
let received = Number(localStorage.getItem(LS_REC) || 0);
let activeCat = "ì „ì²´";
let sortMode = "pin_used";
let payLocked = false;

/* ===========================
   3) ìœ í‹¸
=========================== */
function loadJSON(k, d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } }
function saveItems(){ localStorage.setItem(LS_ITEMS, JSON.stringify(ITEMS)); }
function saveCart(){ localStorage.setItem(LS_CART, JSON.stringify(cart)); }
function saveReceived(){ localStorage.setItem(LS_REC, received); }

function itemMap(){
  const m={}; ITEMS.forEach(p=>m[p.id]=p); return m;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g,m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/* ===========================
   4) CSV ë¡œë“œ
=========================== */
async function loadSheetItems(){
  const res = await fetch(CSV_URL + "&t=" + Date.now());
  const text = await res.text();
  const rows = text.split(/\r?\n/).map(r=>r.split(","));
  const head = rows[0].map(h=>h.trim().toLowerCase());

  const idx = k => head.indexOf(k);

  const out = [];
  for(let i=1;i<rows.length;i++){
    const r = rows[i];
    if(!r || !r.length) continue;

    const active = (r[idx("active")] || "1").trim();
    if(active==="0") continue;

    const id = r[idx("id")]?.trim();
    if(!id) continue;

    out.push({
      id,
      cat: r[idx("cat")] || "ê¸°íƒ€",
      name: r[idx("name")] || "",
      price: Number((r[idx("price")]||"0").replace(/[^\d]/g,"")),
      pinned:false,
      used:0
    });
  }
  return out;
}

/* ===========================
   5) ì‹œíŠ¸ + ë¡œì»¬ ë³‘í•©
=========================== */
async function applySheet(){
  const sheet = await loadSheetItems();
  const local = itemMap();

  ITEMS = sheet.map(p=>{
    const old = local[p.id];
    return {
      ...p,
      pinned: old?.pinned || false,
      used: old?.used || 0
    };
  });
  saveItems();
}

/* ===========================
   6) ì´ˆì„± ê²€ìƒ‰
=========================== */
const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
function cho(ch){
  const c=ch.charCodeAt(0);
  if(c<0xAC00||c>0xD7A3) return ch;
  return CHO[Math.floor((c-0xAC00)/588)];
}
function toCho(s){ return [...s].map(cho).join(""); }
function match(p,q){
  if(!q) return true;
  return p.name.includes(q) || toCho(p.name).includes(q);
}

/* ===========================
   7) ë Œë”
=========================== */
function renderTabs(){
  const el=document.getElementById("tabs"); el.innerHTML="";
  ["ì „ì²´",...new Set(ITEMS.map(p=>p.cat))].forEach(c=>{
    const b=document.createElement("button");
    b.className="tab"+(c===activeCat?" active":"");
    b.textContent=c;
    b.onclick=()=>{activeCat=c; renderProducts();}
    el.appendChild(b);
  });
}

function renderPin(){
  const el=document.getElementById("pinStrip"); el.innerHTML="";
  ITEMS.filter(p=>p.pinned)
    .sort((a,b)=>b.used-a.used)
    .forEach(p=>{
      const b=document.createElement("button");
      b.className="pinCard";
      b.innerHTML=`<div class="pinI">ğŸ“Œ</div>
                   <div class="name">${escapeHtml(p.name)}</div>
                   <div class="price">${p.price.toLocaleString()}ì›</div>`;
      b.onclick=()=>add(p.id,1,true);
      b.oncontextmenu=e=>{e.preventDefault(); togglePin(p.id);}
      el.appendChild(b);
    });
}

function renderProducts(){
  const q=document.getElementById("q").value.trim();
  const el=document.getElementById("products"); el.innerHTML="";

  let list=[...ITEMS];
  if(activeCat!=="ì „ì²´") list=list.filter(p=>p.cat===activeCat);
  list=list.filter(p=>match(p,q));
  list.sort((a,b)=>(b.pinned-a.pinned)||(b.used-a.used));

  list.forEach(p=>{
    const c=document.createElement("button");
    c.className="card"+(p.pinned?" pinned":"");
    c.innerHTML=`
      <div class="name">${escapeHtml(p.name)}</div>
      <div class="price">${p.price.toLocaleString()}ì›</div>
      <div class="meta">
        <div class="badge">ì‚¬ìš© ${p.used}</div>
        <div class="pinBtn">ğŸ“Œ</div>
      </div>`;
    c.onclick=()=>add(p.id,1,true);
    c.oncontextmenu=e=>{e.preventDefault(); togglePin(p.id);}
    el.appendChild(c);
  });

  renderPin();
}

function renderCart(){
  const map=itemMap();
  const el=document.getElementById("cart"); el.innerHTML="";
  let sum=0, qty=0;

  Object.keys(cart).forEach(id=>{
    const q=cart[id], p=map[id];
    if(!p) return;
    sum+=p.price*q; qty+=q;

    const d=document.createElement("div");
    d.className="item";
    d.innerHTML=`
      <div class="itemRow">
        <div class="itemName">${escapeHtml(p.name)} x${q}</div>
        <div class="itemSub">${(p.price*q).toLocaleString()}ì›</div>
        <div class="itemCtrls">
          <button class="ctrl">âˆ’</button>
          <button class="ctrl">+</button>
          <button class="ctrl del">Ã—</button>
        </div>
      </div>`;
    d.querySelectorAll(".ctrl")[0].onclick=()=>add(id,-1,false);
    d.querySelectorAll(".ctrl")[1].onclick=()=>add(id,1,false);
    d.querySelectorAll(".del")[0].onclick=()=>{delete cart[id]; saveCart(); renderCart();}
    el.appendChild(d);
  });

  document.getElementById("cartCount").textContent=`í•­ëª© ${Object.keys(cart).length}`;
  document.getElementById("sumText").textContent=`ì´í•©ê³„(${qty}ê°œ)`;
  document.getElementById("sumValue").textContent=sum.toLocaleString()+"ì›";
  document.getElementById("received").textContent=received.toLocaleString()+"ì›";
  document.getElementById("change").textContent=Math.max(0,received-sum).toLocaleString()+"ì›";
}

/* ===========================
   8) ì•¡ì…˜
=========================== */
function add(id,d,cnt){
  cart[id]=(cart[id]||0)+d;
  if(cart[id]<=0) delete cart[id];
  saveCart();

  if(cnt){
    const p=itemMap()[id];
    p.used++; saveItems();
  }
  renderProducts(); renderCart();
}

function togglePin(id){
  const p=itemMap()[id];
  p.pinned=!p.pinned;
  saveItems();
  renderProducts();
}

/* ===========================
   9) ë²„íŠ¼
=========================== */
document.getElementById("q").oninput=renderProducts;
document.querySelectorAll(".money button[data-add]").forEach(b=>{
  b.onclick=()=>{ received+=Number(b.dataset.add); saveReceived(); renderCart(); }
});
document.getElementById("reset").onclick=()=>{
  received=0; saveReceived(); renderCart();
};

/* ===========================
   10) ì‹œì‘
=========================== */
async function boot(){
  try{ await applySheet(); }catch(e){ console.warn("ì‹œíŠ¸ ì‹¤íŒ¨",e); }
  renderTabs();
  renderProducts();
  renderCart();
}
window.addEventListener("pageshow",()=>{
  cart={}; received=0; saveCart(); saveReceived();
});
boot();
  </script>
</body>
</html>
