<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ì—„ê°€ë„¤ POS</title>

<style>
:root{
  --bg:#0f1219;
  --panel:#121827;
  --card1:#1e2639;
  --card2:#242f4a;
  --line:rgba(255,255,255,.12);
  --text:#f7f9ff;
  --muted:rgba(247,249,255,.65);
  --accent:#ff9f00;
  --danger:#ff4d4f;
  --good:#2fd27e;
  --btn:#f4f5f7;
  --btnText:#111;
  --shadow:0 14px 44px rgba(0,0,0,.35);
  --r:22px;
}

*{box-sizing:border-box}
html,body{height:100%; margin:0; background:var(--bg); color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",system-ui,Segoe UI,Roboto,sans-serif;
}
button,input{font:inherit}
button{border:none; background:none}

.app{height:100%; display:grid; grid-template-columns:3fr 1fr; gap:14px; padding:14px}

/* LEFT */
.left{
  background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
  border:1px solid var(--line);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  overflow:hidden;
  display:flex; flex-direction:column;
}
.topbar{
  display:flex; gap:10px; padding:10px 12px;
  border-bottom:1px solid var(--line);
  background:rgba(255,255,255,.02)
}
.tabs{display:flex; gap:8px; flex-wrap:wrap}
.tab{
  padding:10px 16px; border-radius:999px; border:1px solid var(--line);
  background:#1d2332; color:var(--text); font-weight:1100; cursor:pointer;
}
.tab.active{background:rgba(255,159,0,.20); border-color:rgba(255,159,0,.55); box-shadow:0 0 0 2px rgba(255,159,0,.12) inset}

.searchwrap{padding:10px 12px; border-bottom:1px solid var(--line); background:rgba(255,255,255,.015)}
.searchrow{display:flex; gap:10px; align-items:center}
.search{
  flex:1; display:flex; align-items:center; gap:10px;
  background:rgba(255,255,255,.04); border:1px solid var(--line);
  border-radius:14px; padding:10px 12px;
}
.search .icon{opacity:.7}
.search input{
  width:100%; border:none; outline:none; background:transparent;
  color:var(--text); font-weight:900; font-size:15px;
}
.sort{
  display:flex; align-items:center; gap:8px; padding:10px 12px;
  border:1px solid var(--line); border-radius:14px;
  background:rgba(255,255,255,.03); font-weight:1100;
  white-space:nowrap;
}
.sort small{opacity:.7; font-weight:900}

.cho{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap}
.cho button{
  padding:8px 10px; border-radius:12px; border:1px solid var(--line);
  background:rgba(255,255,255,.03); color:var(--text);
  font-weight:1100; cursor:pointer; min-width:40px;
}
.cho button.clear{background:rgba(255,77,79,.18); border-color:rgba(255,77,79,.35)}

.products{
  padding:12px; overflow:auto;
  display:grid; grid-template-columns:repeat(4, minmax(0,1fr));
  gap:12px;
}
@media (min-width:1500px){ .products{grid-template-columns:repeat(5, minmax(0,1fr))} }

.card{
  background:linear-gradient(180deg, var(--card2), var(--card1));
  border:1px solid rgba(255,255,255,.16);
  border-radius:18px; padding:14px;
  cursor:pointer; user-select:none;
  position:relative; min-height:84px;
  touch-action:manipulation;
}
.card.flash{box-shadow:0 0 0 3px rgba(255,159,0,.45)}
.name{font-size:18px; font-weight:1200; letter-spacing:-.2px}
.price{margin-top:6px; font-size:14px; opacity:.95; font-weight:1000}

.meta{
  position:absolute; right:10px; top:10px;
  display:flex; gap:8px; align-items:center; opacity:.92
}
.badge{
  font-size:12px; padding:4px 8px; border-radius:999px;
  border:1px solid var(--line); background:rgba(255,255,255,.03);
  font-weight:1100
}
.pin{
  width:28px; height:28px; display:grid; place-items:center;
  border-radius:10px; border:1px solid var(--line);
  background:rgba(0,0,0,.15)
}
.pin.on{border-color:rgba(255,159,0,.55); background:rgba(255,159,0,.18)}
/* ë©”íƒ€ ì˜ì—­ì´ í´ë¦­ ê°€ë¡œì±„ì§€ ì•Šê²Œ */
.meta, .meta * { pointer-events:none; }

.hint{
  padding:8px 12px 12px;
  color:var(--muted); font-size:12px; font-weight:900;
  border-top:1px solid var(--line); background:rgba(255,255,255,.01)
}

/* RIGHT */
.right{
  background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
  border:1px solid var(--line);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  overflow:hidden;
  display:flex; flex-direction:column;
}

/* ì¥ë°”êµ¬ë‹ˆ */
.cart{padding:12px; overflow:auto; flex:1; min-height:260px}
.carthead{display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; font-weight:1200}
.carthead .muted{opacity:.7; font-weight:1000}

.item{
  background:rgba(255,255,255,.03); border:1px solid var(--line);
  border-radius:14px; padding:10px;
  display:grid; grid-template-columns:1fr auto; gap:10px; margin-bottom:8px;
}
.item .title{font-weight:1200; font-size:14px}
.item .sub{margin-top:4px; font-size:12px; opacity:.8; font-weight:900}

.controls{display:flex; gap:8px; align-items:center}
.ctrl{
  width:38px; height:36px; border-radius:12px; border:1px solid var(--line);
  background:rgba(255,255,255,.03); color:var(--text); font-weight:1300; cursor:pointer;
}
.ctrl.del{background:rgba(255,77,79,.18); border-color:rgba(255,77,79,.35)}
.count{width:26px; text-align:center; font-weight:1300}

/* 7ì¤„ ì´ìƒ ë³´ì´ê²Œ: ë¹ˆì¤„ placeholder */
.placeholder{
  height:58px;
  border-radius:14px;
  border:1px dashed rgba(255,255,255,.10);
  background:rgba(255,255,255,.015);
  margin-bottom:8px;
}

/* ì´í•©ê³„/ë‹´ê¸´ê°¯ìˆ˜ í•œ ì¤„ */
.summary{padding:12px; border-top:1px solid var(--line); background:rgba(255,255,255,.015)}
.row1{display:flex; justify-content:space-between; align-items:flex-end; gap:12px}
.label{font-size:12px; opacity:.7; font-weight:1100}
.val{font-size:22px; font-weight:1300}
.smallval{font-size:14px; font-weight:1200; opacity:.95}

/* ë°›ì€ëˆ/ê±°ìŠ¤ë¦„ëˆ í•œ ì¤„ */
.payline{display:flex; align-items:flex-end; gap:12px; margin-top:10px}
.payline .block{flex:1}
.payline .divider{width:2px; height:26px; background:rgba(255,255,255,.14); border-radius:99px; align-self:center}
.payline .leftAlign{text-align:left}
.payline .rightAlign{text-align:right}

/* ê±°ìŠ¤ë¦„ëˆ ë²„íŠ¼: 3ê°œì”© 2ì¤„ */
.money{
  padding:12px; border-top:1px solid var(--line);
  display:grid; grid-template-columns:repeat(3,1fr); gap:10px;
  background:rgba(255,255,255,.01);
}
.money button{
  padding:12px; border-radius:14px;
  font-size:16px; font-weight:1300; cursor:pointer;
  background:var(--btn); color:var(--btnText);
}
.money button.reset{background:rgba(255,77,79,.22); color:#ffe2e2}

/* ê²°ì œì™„ë£Œ ê³ ì • */
.pay{
  margin:12px; margin-top:0;
  border-radius:16px; padding:16px;
  background:var(--accent);
  font-size:18px; font-weight:1400;
  cursor:pointer;
}
.pay.locked{opacity:.55; pointer-events:none}

/* íŒì—… */
.overlay{position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:9999}
.overlay.show{display:flex}
.modal{
  width:min(520px,92vw);
  background:#161c28;
  border:1px solid rgba(255,255,255,.14);
  border-radius:20px; padding:18px;
  box-shadow:var(--shadow)
}
.modal h3{margin:0 0 8px; font-size:18px; font-weight:1300}
.modal p{margin:0; opacity:.9; font-weight:1000}
.modal .btns{display:flex; gap:10px; justify-content:flex-end; margin-top:14px}
.modal button{padding:10px 14px; border-radius:14px; font-weight:1300; cursor:pointer}
.modal .ok{background:var(--good); color:#082010}
.modal .cancel{background:rgba(255,255,255,.08); color:var(--text)}

/* í† ìŠ¤íŠ¸(ë””ë²„ê·¸) */
.toast{
  position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
  background:rgba(0,0,0,.75);
  border:1px solid rgba(255,255,255,.18);
  padding:10px 12px; border-radius:14px;
  font-weight:1100; z-index:10000;
  display:none; max-width:92vw;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.toast.show{display:block}
</style>
</head>

<body>
<div class="app">

  <section class="left">
    <div class="topbar"><div class="tabs" id="tabs"></div></div>

    <div class="searchwrap">
      <div class="searchrow">
        <div class="search">
          <span class="icon">ğŸ”</span>
          <input id="q" placeholder="ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±ã„±)" autocomplete="off" />
        </div>
        <div class="sort" title="ì •ë ¬: ê³ ì • â†’ ë§ì´ì°íŒ(ì‚¬ìš©íšŸìˆ˜) ìˆœ">
          ì •ë ¬: <small>ê³ ì • + ë§ì´ ì°íŒ ìˆœ</small>
        </div>
      </div>
      <div class="cho" id="cho"></div>
    </div>

    <div class="products" id="products"></div>
    <div class="hint">â€» ê³ ì •í•€: ê¸¸ê²Œëˆ„ë¥´ê¸°(ëª¨ë°”ì¼) / ìš°í´ë¦­(PC). ì¹´ë“œëŠ” ì•„ë¬´ë°ë‚˜ ëˆ„ë¥´ë©´ ë‹´ê¹ë‹ˆë‹¤.</div>
  </section>

  <section class="right">
    <div class="cart" id="cart"></div>

    <div class="summary">
      <div class="row1">
        <div>
          <div class="label">ì´í•©ê³„</div>
          <div class="val" id="sum">0ì›</div>
        </div>
        <div style="text-align:right">
          <div class="label">ë‹´ê¸´ê°¯ìˆ˜</div>
          <div class="smallval" id="qty">0</div>
        </div>
      </div>

      <div class="payline">
        <div class="block leftAlign">
          <div class="label">ë°›ì€ëˆ</div>
          <div class="val" id="received">0ì›</div>
        </div>
        <div class="divider"></div>
        <div class="block rightAlign">
          <div class="label">ê±°ìŠ¤ë¦„ëˆ</div>
          <div class="val" id="change">0ì›</div>
        </div>
      </div>
    </div>

    <div class="money">
      <button data-add="500">500</button>
      <button data-add="1000">1ì²œ</button>
      <button data-add="5000">5ì²œ</button>
      <button data-add="10000">1ë§Œ</button>
      <button data-add="50000">5ë§Œ</button>
      <button class="reset" id="reset">ì´ˆê¸°í™”</button>
    </div>

    <button class="pay" id="pay">ê²°ì œì™„ë£Œ</button>
  </section>
</div>

<div class="overlay" id="overlay">
  <div class="modal">
    <h3>ê²°ì œ ì™„ë£Œ</h3>
    <p id="modalText">ì •ë§ ê²°ì œì™„ë£Œ ì²˜ë¦¬í• ê¹Œìš”?</p>
    <div class="btns">
      <button class="cancel" id="cancelBtn">ì·¨ì†Œ</button>
      <button class="ok" id="okBtn">í™•ì¸</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- (ì„ íƒ) items.js ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ window.ITEMSë¥¼ ì½ì–´ì„œ ìƒí’ˆìœ¼ë¡œ ì”€ -->
<script src="./items.js?v=1"></script>

<script>
/* JS ì—ëŸ¬ ì¦‰ì‹œ ì•Œë¦¼ */
window.addEventListener("error", (e)=>{
  alert("JSì˜¤ë¥˜: " + (e?.message || e));
});

/* âœ… ì¹´í…Œê³ ë¦¬: ì „ì²´/ê³¼ì¼/ì•¼ì±„/ë´‰ì±„ì†Œ/ìƒì„ /ê¸°íƒ€ */
const CATS = ["ì „ì²´","ê³¼ì¼","ì•¼ì±„","ë´‰ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];

/* âœ… items.js(êµ¬ê¸€ì‹œíŠ¸ ì—°ë™) ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„  ì‚¬ìš©
   items.jsì˜ í˜•ì‹: window.ITEMS = [{id,cat,name,unit,price,active}, ...]
*/
function normalizeItems(items){
  return (items||[])
    .filter(x=>x && x.id && x.name)
    .filter(x=> (x.active===undefined ? true : !!x.active))
    .map(x=>({
      id:String(x.id),
      cat:(x.cat||"ê¸°íƒ€"),
      name:String(x.name),
      price:Number(x.price||0)
    }));
}

/* âœ… items.jsê°€ ì—†ê±°ë‚˜ ë¹„ë©´ ê¸°ë³¸ ìƒí’ˆ(ìµœì†Œ ì•ˆì „ë§) */
const FALLBACK_PRODUCTS = [
  {id:"apple_3",   cat:"ê³¼ì¼", name:"ì‚¬ê³¼",  price:3000},
  {id:"banana",    cat:"ê³¼ì¼", name:"ë°”ë‚˜ë‚˜", price:2500},
  {id:"tomato",    cat:"ê³¼ì¼", name:"í† ë§ˆí† ", price:10000},

  {id:"potato",    cat:"ì•¼ì±„", name:"ê°ì",  price:3000},
  {id:"sweetpot",  cat:"ì•¼ì±„", name:"ê³ êµ¬ë§ˆ", price:3000},
  {id:"onion",     cat:"ì•¼ì±„", name:"ì–‘íŒŒ",  price:2500},
  {id:"carrot",    cat:"ì•¼ì±„", name:"ë‹¹ê·¼",  price:2500},

  {id:"leaf1",     cat:"ë´‰ì±„ì†Œ", name:"ê¹»ì", price:2000},

  {id:"fish1",     cat:"ìƒì„ ", name:"ê³ ë“±ì–´", price:6000},

  {id:"etc1",      cat:"ê¸°íƒ€", name:"ìƒì¶”",  price:1500},
];

const LS_KEY="umgane_pos_state_v1006";
const state = (()=>{ try{
  const s=JSON.parse(localStorage.getItem(LS_KEY)||"{}");
  return { pinned:s.pinned||{}, used:s.used||{}, lastCat:s.lastCat||"ì „ì²´" };
}catch(_){ return {pinned:{}, used:{}, lastCat:"ì „ì²´"}; }})();
const saveState=()=>localStorage.setItem(LS_KEY, JSON.stringify(state));

/* ìƒí’ˆ ë¡œë“œ */
let PRODUCTS = normalizeItems(window.ITEMS);
if(!PRODUCTS.length) PRODUCTS = FALLBACK_PRODUCTS.slice();
const productMap = Object.fromEntries(PRODUCTS.map(p=>[p.id,p]));

/* ì¥ë°”êµ¬ë‹ˆ */
const cart = {};
let activeCat = state.lastCat;
let q = "";
let received = 0;
let payLocked = false;

/* âœ… ì—°íƒ€/ì´ì¤‘ ì´ë²¤íŠ¸ ë°©ì§€ (í† ë§ˆí† â†’ë°”ë‚˜ë‚˜ ê°™ì€ ì˜¤ì‘ë™ ë°©ì§€) */
let tapLock = false;
function lockTap(ms=120){ tapLock = true; setTimeout(()=>tapLock=false, ms); }

const tabsEl = document.getElementById("tabs");
const productsEl = document.getElementById("products");
const cartEl = document.getElementById("cart");
const toastEl = document.getElementById("toast");

function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(toastEl._t);
  toastEl._t=setTimeout(()=>toastEl.classList.remove("show"), 850);
}

/* âœ… ì´ˆì„± ê²€ìƒ‰ */
const CHO=["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
function getChosung(str){
  let out="";
  for(const ch of str){
    const code=ch.charCodeAt(0);
    if(code>=0xAC00 && code<=0xD7A3){
      out+=CHO[Math.floor((code-0xAC00)/588)]||"";
    }else out+=ch;
  }
  return out;
}
function matchQuery(p, query){
  const t=(query||"").trim();
  if(!t) return true;
  const name=p.name.replace(/\s/g,"");
  const tl=t.toLowerCase().replace(/\s/g,"");
  if(name.toLowerCase().includes(tl)) return true;
  if(getChosung(name).includes(tl)) return true;
  return false;
}

/* âœ… ì •ë ¬: ê³ ì • â†’ ë§ì´ì°í˜(ì‚¬ìš©íšŸìˆ˜) ë‚´ë¦¼ì°¨ìˆœ */
function sortedList(list){
  return list.slice().sort((a,b)=>{
    const ap=!!state.pinned[a.id], bp=!!state.pinned[b.id];
    if(ap!==bp) return ap?-1:1;
    const au=state.used[a.id]||0, bu=state.used[b.id]||0;
    if(au!==bu) return bu-au;
    return 0; // ì´ë¦„ìˆœ ì•ˆ ì”€(ìš”êµ¬ì‚¬í•­)
  });
}

function currentProducts(){
  const filtered = PRODUCTS.filter(p=>{
    // ê²€ìƒ‰ ì¤‘ì´ë©´ "ì „ ì¹´í…Œê³ ë¦¬"ë¡œ ê²€ìƒ‰ (ìš”êµ¬ì‚¬í•­)
    if(q.trim()) return matchQuery(p,q);
    // ê²€ìƒ‰ ì—†ìœ¼ë©´ ì¹´í…Œê³ ë¦¬ í•„í„°
    if(activeCat==="ì „ì²´") return true;
    return p.cat===activeCat;
  });
  return sortedList(filtered);
}

function renderTabs(){
  tabsEl.innerHTML="";
  CATS.forEach(cat=>{
    const b=document.createElement("button");
    b.className="tab"+(cat===activeCat?" active":"");
    b.textContent=cat;
    b.onclick=()=>{
      activeCat=cat;
      state.lastCat=cat;
      saveState();
      renderTabs();       // âœ… í™œì„±ìƒ‰ ë°”ë¡œ ë°˜ì˜
      renderProducts();
    };
    tabsEl.appendChild(b);
  });
}

function togglePin(id){
  state.pinned[id]=!state.pinned[id];
  saveState();
  renderProducts();
}

function attachPinHandlers(cardEl, id){
  let pressTimer=null;
  cardEl.addEventListener("touchstart", ()=>{
    pressTimer=setTimeout(()=>{
      cardEl.dataset.suppress="1";
      togglePin(id);
      setTimeout(()=>{delete cardEl.dataset.suppress;}, 350);
    }, 450);
  }, {passive:true});
  cardEl.addEventListener("touchend", ()=>{ if(pressTimer) clearTimeout(pressTimer); pressTimer=null; });
  cardEl.addEventListener("contextmenu",(e)=>{ e.preventDefault(); togglePin(id); });
}

function renderProducts(){
  productsEl.innerHTML="";
  const list = currentProducts();

  list.forEach(p=>{
    const d=document.createElement("div");
    d.className="card";
    d.dataset.id=p.id;

    const used=state.used[p.id]||0;
    const pinned=!!state.pinned[p.id];

    d.innerHTML=`
      <div class="meta">
        <span class="badge">ì‚¬ìš© ${used}</span>
        <span class="pin ${pinned?"on":""}">ğŸ“Œ</span>
      </div>
      <div class="name">${p.name}</div>
      <div class="price">${(p.price||0).toLocaleString()}ì›</div>
    `;
    attachPinHandlers(d, p.id);
    productsEl.appendChild(d);
  });
}

function updateUsedBadge(id){
  const card = productsEl.querySelector(\`.card[data-id="\${id}"]\`);
  if(!card) return;
  const badge = card.querySelector(".badge");
  if(badge) badge.textContent = "ì‚¬ìš© " + (state.used[id]||0);
}

function flash(el){
  el.classList.add("flash");
  setTimeout(()=>el.classList.remove("flash"), 140);
}

/* âœ… ë‹´ê¸° */
productsEl.addEventListener("pointerdown", (e)=>{
  if(tapLock) return;
  const card = e.target.closest(".card");
  if(!card) return;
  if(card.dataset.suppress==="1") return;

  const id = card.dataset.id;
  const p = productMap[id];
  if(!p){ alert("ìƒí’ˆID ì˜¤ë¥˜: "+id); return; }

  lockTap(120);
  addToCart(id, 1);
  flash(card);
});

function addToCart(id,n){
  cart[id]=(cart[id]||0)+n;
  if(cart[id]<=0) delete cart[id];

  if(n>0){
    state.used[id]=(state.used[id]||0)+1;
    saveState();
    updateUsedBadge(id); // ì „ì²´ ì¬ë Œë” ì—†ì´ badgeë§Œ ì—…ë°ì´íŠ¸
  }
  renderCart();
}

function sumCart(){
  let sum=0, qty=0;
  for(const id in cart){
    const p=productMap[id];
    sum += (p.price||0)*cart[id];
    qty += cart[id];
  }
  return {sum,qty};
}

function renderCart(){
  const {sum,qty}=sumCart();
  document.getElementById("sum").textContent=sum.toLocaleString()+"ì›";
  document.getElementById("qty").textContent=qty;
  document.getElementById("received").textContent=received.toLocaleString()+"ì›";
  document.getElementById("change").textContent=Math.max(0,received-sum).toLocaleString()+"ì›";

  cartEl.innerHTML=`
    <div class="carthead">
      <div>ì¥ë°”êµ¬ë‹ˆ <span class="muted">(ìˆ˜ëŸ‰ ì¡°ì ˆ + ì‚­ì œ)</span></div>
      <div class="muted">í•­ëª© ${Object.keys(cart).length}</div>
    </div>
  `;

  const ids = Object.keys(cart);
  ids.forEach(id=>{
    const p=productMap[id], qn=cart[id];
    const item=document.createElement("div");
    item.className="item";
    item.innerHTML=`
      <div>
        <div c
