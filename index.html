<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ì—„ê°€ë„¤ POS</title>
  <style>
    :root{
      --bg:#0b0c10;
      --panel:#121827;
      --panel2:#0f131e;
      --card:#1a2338;
      --card2:#152032;
      --line:rgba(255,255,255,.10);
      --text:#f3f6ff;
      --muted:rgba(243,246,255,.65);
      --accent:#ff9f00;
      --btn:#f4f5f7;
      --btnText:#111;
      --danger:#ff4d4f;
      --good:#29d17e;
      --shadow:0 14px 44px rgba(0,0,0,.42);
      --r:18px;
      --r2:22px;
    }
    *{box-sizing:border-box;}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,"Noto Sans KR",Segoe UI,Roboto,sans-serif;}
    button,input{font:inherit}
    .app{
      height:100%;
      display:grid;
      grid-template-columns: minmax(520px, 1fr) 420px;
      gap:14px;
      padding:14px;
    }
    .left,.right{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--r2);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .left{display:flex; flex-direction:column;}
    .topbar{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.02);
    }
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .tab{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      letter-spacing:-.2px;
      user-select:none;
    }
    .tab.active{
      border-color:rgba(255,159,0,.6);
      box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
      color:var(--accent);
    }
    .searchRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .search .icon{opacity:.8}
    .search input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-weight:700;
    }
    .sortBtn{
      white-space:nowrap;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
    }
    .choRow{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .choRow button{
      min-width:44px;
      padding:10px 0;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .hint{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }
    .grid{
      padding:12px;
      display:grid;
      grid-template-columns: repeat(4, minmax(160px, 1fr));
      gap:12px;
      overflow:auto;
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:22px;
      padding:14px 14px 12px;
      cursor:pointer;
      user-select:none;
      position:relative;
    }
    .card:active{transform:translateY(1px);}
    .name{
      font-weight:900;
      font-size:22px;
      letter-spacing:-.4px;
      line-height:1.1;
      margin-bottom:8px;
    }
    .price{
      font-weight:900;
      font-size:16px;
      opacity:.95;
    }
    .meta{
      position:absolute;
      right:12px;
      top:10px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .usePill{
      font-weight:900;
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.15);
    }
    .pinBtn{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      cursor:pointer;
      display:grid; place-items:center;
      user-select:none;
    }
    .pinBtn.pinned{
      border-color:rgba(255,159,0,.65);
      box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
    }

    /* RIGHT */
    .right{display:flex; flex-direction:column;}
    .rTop{
      padding:12px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.02);
      font-weight:900;
      letter-spacing:-.2px;
    }
    .cart{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
      flex:1;
    }
    .cartList{
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      background:rgba(255,255,255,.02);
    }
    .cartRow{
      display:grid;
      grid-template-columns: 1fr auto auto auto;
      gap:8px;
      align-items:center;
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      min-height:46px;
    }
    .cartRow:last-child{border-bottom:none;}
    .cName{font-weight:900; letter-spacing:-.2px;}
    .cSub{font-weight:800; color:var(--muted); font-size:12px;}
    .qtyCtl{
      display:flex;
      gap:6px;
      align-items:center;
      font-weight:900;
    }
    .qtyCtl button{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      cursor:pointer;
      font-weight:1000;
    }
    .qtyNum{
      min-width:34px;
      text-align:center;
      font-weight:1000;
    }
    .delBtn{
      width:42px; height:34px;
      border-radius:12px;
      border:1px solid rgba(255,77,79,.45);
      background:rgba(255,77,79,.12);
      color:#ffd7d7;
      cursor:pointer;
      font-weight:1000;
    }
    .rowLine{
      display:flex;
      justify-content:space-between;
      align-items:center;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      border-radius:18px;
      padding:10px 12px;
      font-weight:1000;
    }
    .rowLine .big{font-size:20px;}
    .rowLine .muted{color:var(--muted); font-weight:900;}
    .moneyPad{
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.02);
      padding:10px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .moneyPad button{
      height:46px;
      border-radius:14px;
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--btnText);
      cursor:pointer;
      font-weight:1000;
      letter-spacing:-.2px;
    }
    .moneyPad .reset{
      background:rgba(255,77,79,.18);
      border-color:rgba(255,77,79,.45);
      color:#ffd7d7;
    }
    .payBtn{
      margin-top:10px;
      height:64px;
      border-radius:16px;
      border:none;
      cursor:pointer;
      font-weight:1000;
      font-size:20px;
      background:var(--accent);
      color:#111;
      box-shadow:0 10px 28px rgba(255,159,0,.25);
    }
    .payBtn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    /* Responsive: ì‘ì€ í™”ë©´ */
    @media (max-width: 980px){
      .app{grid-template-columns:1fr; grid-template-rows:auto auto;}
      .right{min-height:520px;}
      .grid{grid-template-columns: repeat(2, minmax(160px, 1fr));}
    }
  </style>
</head>
<body>
  <div class="app">
    <section class="left">
      <div class="topbar">
        <div class="tabs" id="tabs"></div>

        <div class="searchRow">
          <div class="search">
            <span class="icon">ğŸ”</span>
            <input id="q" placeholder="ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±ã„´ã„·)" autocomplete="off" />
          </div>
          <button class="sortBtn" id="sortBtn">ì •ë ¬: ê³ ì • + ë§ì´ ì°íŒ ìˆœ</button>
        </div>

        <div class="choRow" id="cho"></div>
        <div class="hint">â€» ê³ ì •í•€: ê¸¸ê²Œ ì“°ëŠ” í’ˆëª©ì„ â€œí•­ìƒ ìœ„â€ë¡œ ì˜¬ë¦½ë‹ˆë‹¤. (ëª¨ë°”ì¼=ê¸¸ê²Œëˆ„ë¥´ê¸° / PC=ìš°í´ë¦­)</div>
      </div>

      <div class="grid" id="grid"></div>
    </section>

    <aside class="right">
      <div class="rTop">ê²°ì œ</div>
      <div class="cart">
        <!-- ì¥ë°”êµ¬ë‹ˆ -->
        <div class="cartList" id="cartList"></div>

        <!-- ì´í•©ê³„/ë‹´ê¸´ê°¯ìˆ˜ í•œì¤„ -->
        <div class="rowLine">
          <div>
            <div class="muted">ì´í•©ê³„</div>
            <div class="big" id="sum">0ì›</div>
          </div>
          <div style="text-align:right">
            <div class="muted">ë‹´ê¸´ê°¯ìˆ˜</div>
            <div class="big" id="count">0</div>
          </div>
        </div>

        <!-- ë°›ì€ëˆ/ê±°ìŠ¤ë¦„ëˆ í•œì¤„ -->
        <div class="rowLine">
          <div>
            <div class="muted">ë°›ì€ëˆ</div>
            <div class="big" id="paid">0ì›</div>
          </div>
          <div style="text-align:right">
            <div class="muted">ê±°ìŠ¤ë¦„ëˆ</div>
            <div class="big" id="change">0ì›</div>
          </div>
        </div>

        <!-- ê±°ìŠ¤ë¦„ëˆ ë²„íŠ¼ 3ê°œì”© 2ì¤„ -->
        <div class="moneyPad">
          <button data-add="500">500</button>
          <button data-add="1000">1ì²œ</button>
          <button data-add="5000">5ì²œ</button>
          <button data-add="10000">1ë§Œ</button>
          <button data-add="50000">5ë§Œ</button>
          <button class="reset" id="resetPaid">ì´ˆê¸°í™”</button>
        </div>

        <button class="payBtn" id="payBtn" disabled>ê²°ì œì™„ë£Œ</button>
      </div>
    </aside>
  </div>

  <!-- êµ¬ê¸€ì‹œíŠ¸ ì—°ë™ items.js (window.ITEMSë¥¼ ì±„ìš°ëŠ” íŒŒì¼) -->
  <script src="./items.js?v=1"></script>

  <script>
    /**********************
     * ìƒíƒœ/ì €ì¥ í‚¤
     **********************/
    const LS_PIN = "UMGANE_PIN_V1";
    const LS_USE = "UMGANE_USE_V1";

    const state = {
      cat: "ê³¼ì¼",             // ê¸°ë³¸ íƒ­
      q: "",
      sort: "pin_use",         // ê³ ì •+ì‚¬ìš©ìˆœ
      cart: new Map(),         // id -> {item, qty}
      paid: 0
    };

    const CATS = ["ê³¼ì¼","ì•¼ì±„","ë´‰ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];

    /**********************
     * ìœ í‹¸
     **********************/
    const fmt = (n)=> (Number(n||0)).toLocaleString("ko-KR") + "ì›";

    function safeItems(){
      const arr = (window.ITEMS && Array.isArray(window.ITEMS)) ? window.ITEMS : [];
      // ê¸°ëŒ€ í¬ë§·: {id, cat, name, unit, price, active}
      return arr
        .filter(x => x && (x.active === undefined ? true : !!x.active))
        .map(x => ({
          id: String(x.id ?? ""),
          cat: String(x.cat ?? "ê¸°íƒ€"),
          name: String(x.name ?? ""),
          unit: String(x.unit ?? ""),
          price: Number(x.price ?? 0)
        }))
        .filter(x => x.id && x.name);
    }

    function loadJSON(key, fallback){
      try{
        const v = localStorage.getItem(key);
        if(!v) return fallback;
        return JSON.parse(v);
      }catch(e){ return fallback; }
    }
    function saveJSON(key, val){
      try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){}
    }

    const pinMap = loadJSON(LS_PIN, {}); // id -> true
    const useMap = loadJSON(LS_USE, {}); // id -> number

    function isPinned(id){ return !!pinMap[String(id)]; }
    function togglePin(id){
      id = String(id);
      pinMap[id] = !pinMap[id];
      saveJSON(LS_PIN, pinMap);
      renderProducts();
    }
    function incUse(id){
      id = String(id);
      useMap[id] = (useMap[id] || 0) + 1;
      saveJSON(LS_USE, useMap);
    }
    function getUse(id){ return Number(useMap[String(id)] || 0); }

    // ì´ˆì„± ë§¤ì¹­
    const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
    function toChosung(str){
      let out = "";
      for(const ch of str){
        const code = ch.charCodeAt(0);
        if(code >= 0xAC00 && code <= 0xD7A3){
          const idx = Math.floor((code - 0xAC00) / 588);
          out += CHO[idx] || "";
        }else{
          out += ch;
        }
      }
      return out;
    }
    function isOnlyChosung(q){
      if(!q) return false;
      // ã„±-ã…, ã…-ã…£ ì œì™¸í•˜ê³  ì´ˆì„±ë§Œ í—ˆìš©
      return /^[ã„±-ã…\s]+$/.test(q);
    }
    function matchQuery(name, q){
      if(!q) return true;
      const nq = q.replace(/\s+/g,"");
      const nn = name.replace(/\s+/g,"");
      if(!nq) return true;

      // ì´ˆì„±ë§Œ ë“¤ì–´ì˜¤ë©´ ì´ˆì„± ë¬¸ìì—´ë¡œ ë¹„êµ
      if(isOnlyChosung(nq)){
        return toChosung(nn).includes(nq);
      }
      // ì¼ë°˜ ë¬¸ìì—´ í¬í•¨
      return nn.includes(nq) || toChosung(nn).includes(nq);
    }

    /**********************
     * UI ì—˜ë¦¬ë¨¼íŠ¸
     **********************/
    const elTabs = document.getElementById("tabs");
    const elGrid = document.getElementById("grid");
    const elQ = document.getElementById("q");
    const elCho = document.getElementById("cho");
    const elSortBtn = document.getElementById("sortBtn");

    const elCartList = document.getElementById("cartList");
    const elSum = document.getElementById("sum");
    const elCount = document.getElementById("count");
    const elPaid = document.getElementById("paid");
    const elChange = document.getElementById("change");
    const elPayBtn = document.getElementById("payBtn");
    const elResetPaid = document.getElementById("resetPaid");

    /**********************
     * ë Œë”: íƒ­
     **********************/
    function renderTabs(){
      elTabs.innerHTML = "";
      CATS.forEach(cat=>{
        const b = document.createElement("button");
        b.className = "tab" + (state.cat===cat ? " active" : "");
        b.textContent = cat;
        b.onclick = ()=>{
          state.cat = cat;
          renderTabs();
          renderProducts();
        };
        elTabs.appendChild(b);
      });
    }

    /**********************
     * ë Œë”: ìƒí’ˆ
     **********************/
    function getFilteredItems(){
      const items = safeItems();
      const q = state.q;
      return items.filter(it=>{
        const catOk = (state.cat === "ê¸°íƒ€") ? true : (it.cat === state.cat); // "ê¸°íƒ€"ë¥¼ ì „ì²´ì²˜ëŸ¼ ì“°ì§€ ì•ŠìŒ
        const qOk = matchQuery(it.name, q);
        return catOk && qOk;
      });
    }

    function sortItems(list){
      // ê³ ì • ë¨¼ì €, ê·¸ ë‹¤ìŒ ì‚¬ìš©ë§ì€ìˆœ, ê·¸ ë‹¤ìŒ ì´ë¦„
      return [...list].sort((a,b)=>{
        const ap = isPinned(a.id) ? 1 : 0;
        const bp = isPinned(b.id) ? 1 : 0;
        if(bp !== ap) return bp - ap;

        const au = getUse(a.id);
        const bu = getUse(b.id);
        if(bu !== au) return bu - au;

        return a.name.localeCompare(b.name, "ko");
      });
    }

    function renderProducts(){
      const list = sortItems(getFilteredItems());
      elGrid.innerHTML = "";

      if(list.length === 0){
        const empty = document.createElement("div");
        empty.style.color = "rgba(243,246,255,.6)";
        empty.style.fontWeight = "900";
        empty.style.padding = "10px";
        empty.textContent = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
        elGrid.appendChild(empty);
        return;
      }

      for(const it of list){
        const card = document.createElement("div");
        card.className = "card";

        // í´ë¦­: ë‹´ê¸°
        card.onclick = ()=>{
          addToCart(it);
        };

        // PC ìš°í´ë¦­: ê³ ì • í† ê¸€
        card.oncontextmenu = (e)=>{
          e.preventDefault();
          togglePin(it.id);
        };

        // ëª¨ë°”ì¼ ê¸¸ê²Œ ëˆ„ë¥´ê¸°: ê³ ì • í† ê¸€
        let pressT = null;
        card.addEventListener("touchstart", ()=>{
          pressT = setTimeout(()=> togglePin(it.id), 520);
        }, {passive:true});
        card.addEventListener("touchend", ()=>{
          if(pressT) clearTimeout(pressT);
          pressT = null;
        }, {passive:true});

        const meta = document.createElement("div");
        meta.className = "meta";

        const use = document.createElement("div");
        use.className = "usePill";
        use.textContent = "ì‚¬ìš© " + getUse(it.id);

        const pin = document.createElement("button");
        pin.className = "pinBtn" + (isPinned(it.id) ? " pinned" : "");
        pin.title = "ê³ ì •";
        pin.textContent = "ğŸ“Œ";
        pin.onclick = (e)=>{
          e.stopPropagation();
          togglePin(it.id);
        };

        meta.appendChild(use);
        meta.appendChild(pin);

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = it.unit ? `${it.name}/${it.unit}` : it.name;

        const price = document.createElement("div");
        price.className = "price";
        price.textContent = fmt(it.price);

        card.appendChild(meta);
        card.appendChild(name);
        card.appendChild(price);

        elGrid.appendChild(card);
      }
    }

    /**********************
     * ì¥ë°”êµ¬ë‹ˆ
     **********************/
    function addToCart(item){
      const id = String(item.id);
      const cur = state.cart.get(id);
      if(cur) cur.qty += 1;
      else state.cart.set(id, { item, qty: 1 });

      incUse(id);
      renderProducts();
      renderCart();
    }

    function decQty(id){
      const cur = state.cart.get(id);
      if(!cur) return;
      cur.qty -= 1;
      if(cur.qty <= 0) state.cart.delete(id);
      renderCart();
    }
    function incQty(id){
      const cur = state.cart.get(id);
      if(!cur) return;
      cur.qty += 1;
      incUse(id);
      renderProducts();
      renderCart();
    }
    function delItem(id){
      state.cart.delete(id);
      renderCart();
    }

    function calcSum(){
      let s = 0, c = 0;
      for(const {item, qty} of state.cart.values()){
        s += item.price * qty;
        c += qty;
      }
      return {sum:s, count:c};
    }

    function renderCart(){
      const entries = [...state.cart.values()];
      const {sum, count} = calcSum();
      const change = Math.max(0, state.paid - sum);

      elSum.textContent = fmt(sum);
      elCount.textContent = String(count);
      elPaid.textContent = fmt(state.paid);
      elChange.textContent = fmt(change);

      // ê²°ì œë²„íŠ¼ í™œì„± ì¡°ê±´: ì¥ë°”êµ¬ë‹ˆ ìˆê³ , ë°›ì€ëˆ >= í•©ê³„(0ë„ ê²°ì œ í—ˆìš©í•˜ë©´ ì—¬ê¸° ë³€ê²½)
      elPayBtn.disabled = !(count > 0);

      // ì¥ë°”êµ¬ë‹ˆ ë¦¬ìŠ¤íŠ¸ + ìµœì†Œ 7ì¤„ ë³´ì´ê²Œ ë¹ˆ ì¤„ ì±„ìš°ê¸°
      elCartList.innerHTML = "";
      const MIN_ROWS = 7;

      const rows = [];

      for(const row of entries){
        const {item, qty} = row;
        const r = document.createElement("div");
        r.className = "cartRow";

        const left = document.createElement("div");
        const nm = document.createElement("div");
        nm.className = "cName";
        nm.textContent = item.unit ? `${item.name}/${item.unit}` : item.name;

        const sub = document.createElement("div");
        sub.className = "cSub";
        sub.textContent = `${fmt(item.price)} Ã— ${qty} = ${fmt(item.price * qty)}`;

        left.appendChild(nm);
        left.appendChild(sub);

        const qtyCtl = document.createElement("div");
        qtyCtl.className = "qtyCtl";

        const bMinus = document.createElement("button");
        bMinus.textContent = "âˆ’";
        bMinus.onclick = ()=> decQty(String(item.id));

        const num = document.createElement("div");
        num.className = "qtyNum";
        num.textContent = String(qty);

        const bPlus = document.createElement("button");
        bPlus.textContent = "+";
        bPlus.onclick = ()=> incQty(String(item.id));

        qtyCtl.appendChild(bMinus);
        qtyCtl.appendChild(num);
        qtyCtl.appendChild(bPlus);

        const del = document.createElement("button");
        del.className = "delBtn";
        del.textContent = "ì‚­ì œ";
        del.onclick = ()=> delItem(String(item.id));

        // ë¹ˆ ì¹¸ í•˜ë‚˜ ë” ë‘ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸° ì¶”ê°€ ê°€ëŠ¥
        r.appendChild(left);
        r.appendChild(qtyCtl);
        r.appendChild(del);

        // gridê°€ 4ì¹¸ì¸ë° 3ê°œë§Œ ë„£ì—ˆìœ¼ë‹ˆ ë§ˆì§€ë§‰ ì¹¸ ë§ì¶”ê¸°
        const spacer = document.createElement("div");
        spacer.style.width = "1px";
        spacer.style.height = "1px";
        r.appendChild(spacer);

        rows.push(r);
      }

      // ë¹ˆ ì¤„ ì±„ìš°ê¸°
      const need = Math.max(0, MIN_ROWS - rows.length);
      for(let i=0;i<need;i++){
        const r = document.createElement("div");
        r.className = "cartRow";
        r.style.opacity = ".35";
        r.innerHTML = `<div class="cName">â€”</div><div></div><div></div><div></div>`;
        rows.push(r);
      }

      rows.forEach(r => elCartList.appendChild(r));
    }

    /**********************
     * ë°›ì€ëˆ / ê²°ì œì™„ë£Œ / ì†Œë¦¬
     **********************/
    function addPaid(v){
      state.paid = Math.max(0, state.paid + v);
      renderCart();
    }
    function resetPaid(){
      state.paid = 0; // ìš”êµ¬ì‚¬í•­: ì´ˆê¸°í™”ëŠ” ë°›ì€ëˆë§Œ ë¦¬ì…‹
      renderCart();
    }

    // â€œì‚‘â€ ì†Œë¦¬ (íŒŒì¼ ì—†ì´ WebAudio)
    function playBeep(){
      try{
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioContext();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "square";
        o.frequency.value = 880;     // í†¤
        g.gain.value = 0.06;         // ë³¼ë¥¨
        o.connect(g);
        g.connect(ctx.destination);
        o.start();
        setTimeout(()=>{
          o.stop();
          ctx.close();
        }, 140); // ì§§ê²Œ
      }catch(e){
        // ì¡°ìš©íˆ ë¬´ì‹œ
      }
    }

    function payComplete(){
      if(state.cart.size === 0) return;

      // ê²°ì œì™„ë£Œ ì‹œ: ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê³  ë°›ì€ëˆë„ 0ìœ¼ë¡œ
      state.cart.clear();
      state.paid = 0;

      playBeep();       // âœ… ì—¬ê¸°ì„œ ì†Œë¦¬
      renderCart();
    }

    /**********************
     * ì´ë²¤íŠ¸ ë°”ì¸ë”©
     **********************/
    elQ.addEventListener("input", ()=>{
      state.q = elQ.value;
      renderProducts();
    });

    // ì´ˆì„± ë²„íŠ¼
    const choKeys = ["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
    elCho.innerHTML = "";
    choKeys.forEach(k=>{
      const b = document.createElement("button");
      b.textContent = k;
      b.onclick = ()=>{
        elQ.value = (elQ.value || "") + k;
        state.q = elQ.value;
        elQ.focus();
        renderProducts();
      };
      elCho.appendChild(b);
    });
    // X(ì§€ìš°ê¸°)
    const clear = document.createElement("button");
    clear.textContent = "X";
    clear.onclick = ()=>{
      elQ.value = "";
      state.q = "";
      elQ.focus();
      renderProducts();
    };
    elCho.appendChild(clear);

    // ì •ë ¬ ë²„íŠ¼ (ì§€ê¸ˆì€ ê³ ì •+ì‚¬ìš©ìˆœ ê³ ì • ìœ ì§€. ë²„íŠ¼ì€ UIìš©)
    elSortBtn.onclick = ()=>{
      // í˜¹ì‹œ ë‚˜ì¤‘ì— ì •ë ¬ ëª¨ë“œ ì¶”ê°€í•  ê±°ë©´ ì—¬ê¸°ì„œ í† ê¸€
      // ì§€ê¸ˆì€ ìš”êµ¬ëŒ€ë¡œ ê³ ì •+ì‚¬ìš©ìˆœ ê³ ì •
      alert("ì •ë ¬ì€ 'ê³ ì • + ë§ì´ ì°íŒ ìˆœ' ê³ ì •ì…ë‹ˆë‹¤.");
    };

    // ëˆ ë²„íŠ¼ë“¤
    document.querySelectorAll(".moneyPad button[data-add]").forEach(b=>{
      b.addEventListener("click", ()=>{
        addPaid(Number(b.getAttribute("data-add")||0));
      });
    });
    elResetPaid.onclick = resetPaid;

    elPayBtn.onclick = payComplete;

    /**********************
     * ì´ˆê¸° ë Œë”
     **********************/
    function boot(){
      renderTabs();
      renderProducts();
      renderCart();
    }

    // items.jsê°€ ëŠ¦ê²Œ ì˜¤ëŠ” ê²½ìš° ëŒ€ë¹„
    // 0.3ì´ˆ ê°„ê²©ìœ¼ë¡œ ìµœëŒ€ 3ì´ˆë§Œ ê¸°ë‹¤ë ¸ë‹¤ê°€ ë¶€íŒ…
    (function waitItems(){
      const start = Date.now();
      const timer = setInterval(()=>{
        const items = safeItems();
        if(items.length > 0 || (Date.now() - start) > 3000){
          clearInterval(timer);
          boot();
        }
      }, 300);
    })();

    // ì™¸ë¶€ì—ì„œ ê°•ì œ ìƒˆë¡œê³ ì¹¨(ì‹œíŠ¸ ê°±ì‹ ) í•˜ê³  ì‹¶ìœ¼ë©´ ì½˜ì†”ì—ì„œ:
    // window.reloadItemsFromSheet && window.reloadItemsFromSheet()
  </script>
</body>
</html>
