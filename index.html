<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ì—„ê°€ë„¤ POS</title>

<style>
/* ===== ê¸°ë³¸ ===== */
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:#0b0c10;color:#f5f7ff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
:root{
  --panel:#111319; --panel2:#0f1116; --line:rgba(255,255,255,.08);
  --muted:rgba(245,247,255,.65); --accent:#ff9f00;
  --good:#29d17e; --bad:#ff3b30; --r:16px;
  --shadow:0 12px 40px rgba(0,0,0,.35);
}
button{cursor:pointer;border:0;border-radius:12px}

/* ===== ë ˆì´ì•„ì›ƒ ===== */
.app{display:grid;grid-template-columns:1.25fr .9fr;gap:12px;padding:12px;height:100%}
@media (max-width: 980px){ .app{grid-template-columns:1fr; grid-template-rows:auto auto} }

.panel{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
  border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow);
  overflow:hidden; min-height:0;
}
.left{display:flex;flex-direction:column;min-height:0}
.right{display:flex;flex-direction:column;min-height:0}

/* ===== ìƒë‹¨ íƒ­/ê²€ìƒ‰ ===== */
.topbar{padding:12px;border-bottom:1px solid var(--line);background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,0))}
.tabs{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.tab{
  padding:8px 12px; background:rgba(255,255,255,.05); color:#fff;
  border:1px solid var(--line); border-radius:999px; font-weight:700;
}
.tab.active{border-color:rgba(255,159,0,.65); box-shadow:0 0 0 2px rgba(255,159,0,.15) inset}
.searchRow{margin-top:10px;display:flex;gap:10px;align-items:center}
.search{
  flex:1; display:flex; align-items:center; gap:10px;
  background:rgba(0,0,0,.25); border:1px solid var(--line); border-radius:14px;
  padding:10px 12px;
}
.search input{
  width:100%; background:transparent; border:0; outline:0; color:#fff; font-size:16px;
}
.sortBtn{
  padding:10px 12px; background:rgba(255,255,255,.05); color:#fff; border:1px solid var(--line);
  border-radius:14px; font-weight:700;
}

/* ===== ì´ˆì„± í‚¤íŒ¨ë“œ ===== */
.chosung{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;gap:8px;flex-wrap:wrap}
.ch{
  min-width:34px;height:34px;padding:0 10px;
  background:rgba(255,255,255,.04); color:#fff; border:1px solid var(--line);
  border-radius:999px; font-weight:800;
}
.ch.del{background:rgba(255,59,48,.16);border-color:rgba(255,59,48,.35)}

/* ===== ê³ ì • ì˜ì—­ ===== */
.pinnedWrap{padding:10px 12px;border-bottom:1px solid var(--line)}
.pinnedTitle{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-weight:800;margin-bottom:8px}
.pinnedHint{font-size:12px;color:rgba(245,247,255,.45)}
.pinnedGrid{
  display:grid;
  grid-template-columns:repeat(4, minmax(0, 1fr));
  gap:10px;
}
@media (max-width: 1100px){ .pinnedGrid{grid-template-columns:repeat(3, minmax(0, 1fr));} }
@media (max-width: 780px){ .pinnedGrid{grid-template-columns:repeat(2, minmax(0, 1fr));} }

/* ===== ìƒí’ˆ ê·¸ë¦¬ë“œ ===== */
.listWrap{padding:10px 12px; overflow:auto; min-height:0}
.grid{
  display:grid;
  grid-template-columns:repeat(4, minmax(0, 1fr));
  gap:10px;
}
@media (max-width: 1100px){ .grid{grid-template-columns:repeat(3, minmax(0, 1fr));} }
@media (max-width: 780px){ .grid{grid-template-columns:repeat(2, minmax(0, 1fr));} }

/* ===== ì¹´ë“œ ===== */
.card{
  position:relative;
  background:rgba(255,255,255,.03);
  border:1px solid var(--line);
  border-radius:18px;
  padding:12px 12px 10px;
  min-height:88px;
  display:flex; flex-direction:column; justify-content:space-between;
}
.card .name{font-size:18px;font-weight:900;letter-spacing:-.2px}
.card .price{margin-top:6px;font-size:14px;color:rgba(245,247,255,.65);font-weight:800}
.card .meta{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
.badge{
  font-size:12px;padding:5px 8px;border-radius:999px;
  background:rgba(255,255,255,.06);border:1px solid var(--line);color:rgba(245,247,255,.75);
}
.pinBtn{
  width:34px;height:28px;border-radius:12px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,.25);border:1px solid var(--line);
  user-select:none;
  opacity:.25; filter:grayscale(1);   /* âœ… ê¸°ë³¸ì€ ì•½í•˜ê²Œ */
}
.card.pinned .pinBtn{opacity:1; filter:none;}  /* âœ… pinnedì¼ ë•Œë§Œ ë˜ë · */
.card.pinned{border-color:rgba(255,159,0,.45); box-shadow:0 0 0 2px rgba(255,159,0,.12) inset}

/* ===== ì˜¤ë¥¸ìª½: ì¥ë°”êµ¬ë‹ˆ ===== */
.cartTop{padding:12px;border-bottom:1px solid var(--line)}
.totalLine{
  display:flex;align-items:baseline;justify-content:space-between;
  font-weight:1000;letter-spacing:-.4px;
}
.totalLine .label{color:rgba(245,247,255,.7);font-size:15px}
.totalLine .value{font-size:26px}
.cartCount{margin-top:6px;color:rgba(245,247,255,.55);font-weight:800}

.cartList{padding:10px 12px; overflow:auto; min-height:0}
.cartItem{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 10px;
  border:1px solid var(--line); border-radius:14px;
  background:rgba(255,255,255,.03);
  margin-bottom:8px;
}
.cLeft{display:flex;flex-direction:column;gap:4px;min-width:0}
.cName{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cSub{font-size:12px;color:rgba(245,247,255,.55);font-weight:800}
.cRight{display:flex;align-items:center;gap:8px}
.qtyBtn{
  width:34px;height:34px;border-radius:12px;
  background:rgba(255,255,255,.06); border:1px solid var(--line); color:#fff; font-weight:1000;
}
.delBtn{
  width:36px;height:34px;border-radius:12px;
  background:rgba(255,59,48,.16); border:1px solid rgba(255,59,48,.35); color:#fff; font-weight:1000;
}

/* ===== ë°›ì€ëˆ/ê±°ìŠ¤ë¦„ëˆ ===== */
.payBox{padding:12px;border-top:1px solid var(--line);background:rgba(0,0,0,.15)}
.moneyLine{
  display:flex;justify-content:space-between;align-items:center;
  gap:12px;margin-bottom:10px;
}
.moneyLine .label{font-size:14px;color:rgba(245,247,255,.65);font-weight:900}
.moneyLine .big{font-size:28px;font-weight:1000;letter-spacing:-.4px}
.moneyBtns{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
.mBtn{
  padding:14px 10px;border-radius:16px;
  background:rgba(255,255,255,.06);border:1px solid var(--line);
  color:#fff;font-weight:1000;font-size:16px;
}
.mBtn.reset{background:rgba(255,59,48,.16);border-color:rgba(255,59,48,.35)}

.bottomBar{padding:12px;border-top:1px solid var(--line);display:flex;gap:10px}
.bigBtn{
  flex:1; padding:16px 14px; border-radius:18px;
  background:linear-gradient(180deg, rgba(255,159,0,.95), rgba(255,130,0,.92));
  color:#111; font-size:18px; font-weight:1100;
}
.smallBtn{
  padding:16px 14px; border-radius:18px;
  background:rgba(255,255,255,.06); border:1px solid var(--line);
  color:#fff; font-weight:1000;
}
</style>
</head>

<body>
<div class="app">

  <!-- LEFT -->
  <div class="panel left">
    <div class="topbar">
      <div class="tabs" id="tabs"></div>

      <div class="searchRow">
        <div class="search">
          ğŸ”
          <input id="q" placeholder="ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±ã„´ã„·)" autocomplete="off" />
        </div>
        <button class="sortBtn" id="sortBtn">ì •ë ¬: ê³ ì • + ord</button>
      </div>
    </div>

    <div class="chosung" id="chosung"></div>

    <div class="pinnedWrap">
      <div class="pinnedTitle">
        <div>ê³ ì • - ìƒë‹¨</div>
        <div class="pinnedHint">ê¸¸ê²Œ ëˆŒëŸ¬ ê³ ì •/í•´ì œ (PC: ë”ë¸”í´ë¦­)</div>
      </div>
      <div class="pinnedGrid" id="pinnedGrid"></div>
    </div>

    <div class="listWrap">
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="panel right">
    <div class="cartTop">
      <div class="totalLine">
        <div class="label">ì´í•©ê³„ / ì´ê°¯ìˆ˜</div>
        <div class="value" id="total">0ì›</div>
      </div>
      <div class="cartCount" id="count">0ê°œ</div>
    </div>

    <div class="cartList" id="cart"></div>

    <div class="payBox">
      <div class="moneyLine">
        <div class="label">ë°›ì€ëˆ</div>
        <div class="big" id="received">0ì›</div>
      </div>
      <div class="moneyLine" style="margin-bottom:0">
        <div class="label">ê±°ìŠ¤ë¦„ëˆ</div>
        <div class="big" id="change">0ì›</div>
      </div>

      <div class="moneyBtns">
        <button class="mBtn" data-add="500">+500</button>
        <button class="mBtn" data-add="1000">+1ì²œ</button>
        <button class="mBtn" data-add="5000">+5ì²œ</button>
        <button class="mBtn" data-add="10000">+1ë§Œ</button>
        <button class="mBtn" data-add="50000">+5ë§Œ</button>
        <button class="mBtn reset" id="resetReceived">ì´ˆê¸°í™”</button>
      </div>
    </div>

    <div class="bottomBar">
      <button class="smallBtn" id="clearCart">ì¥ë°”êµ¬ë‹ˆë¹„ì›€</button>
      <button class="bigBtn" id="payDone">ê²°ì œì™„ë£Œ</button>
    </div>
  </div>

</div>

<script>
/* =========================
   âœ… êµ¬ê¸€ì‹œíŠ¸ CSV URL
   (ë¸Œë¼ìš°ì €ë¡œ ì—´ë©´ ë‹¤ìš´ë¼ë„ ì •ìƒ)
========================= */
const CSV_URL = "https://docs.google.com/spreadsheets/d/1MK7TvyILEJ4_YKw1TmY1Au4Z_ZkGbF7LeRMsi89slbw/export?format=csv&gid=0";

/* =========================
   âœ… ë¡œì»¬ì €ì¥ í‚¤ (ë²„ì „)
========================= */
const LS_ITEMS  = "umgane_items_v1";    // ì‹œíŠ¸ë¡œë¶€í„° ë¡œë”©ëœ ì•„ì´í…œ(ìºì‹œ)
const LS_PINS   = "umgane_pins_v1";     // ê³ ì • id ëª©ë¡
const LS_CART   = "umgane_cart_v1";     // ì¥ë°”êµ¬ë‹ˆ {id: qty}
const LS_REC    = "umgane_received_v1"; // ë°›ì€ëˆ

/* =========================
   ìƒíƒœ
========================= */
let ITEMS = [];
let activeCat = "ê³¼ì¼";
let sortMode = "pin+ord"; // ê³ ì • + ord
let qStr = "";

/* =========================
   DOM
========================= */
const tabsEl = document.getElementById("tabs");
const gridEl = document.getElementById("grid");
const pinnedGridEl = document.getElementById("pinnedGrid");
const qEl = document.getElementById("q");
const chosungEl = document.getElementById("chosung");
const sortBtn = document.getElementById("sortBtn");

const cartEl = document.getElementById("cart");
const totalEl = document.getElementById("total");
const countEl = document.getElementById("count");
const receivedEl = document.getElementById("received");
const changeEl = document.getElementById("change");

const clearCartBtn = document.getElementById("clearCart");
const payDoneBtn = document.getElementById("payDone");
const resetReceivedBtn = document.getElementById("resetReceived");

/* =========================
   ìœ í‹¸
========================= */
const fmtWon = (n)=> (Math.round(n)||0).toLocaleString("ko-KR")+"ì›";

function safeJsonParse(s, fallback){
  try{ return JSON.parse(s); }catch(e){ return fallback; }
}

function loadPins(){ return safeJsonParse(localStorage.getItem(LS_PINS) || "[]", []); }
function savePins(arr){ localStorage.setItem(LS_PINS, JSON.stringify(arr)); }

function loadCart(){ return safeJsonParse(localStorage.getItem(LS_CART) || "{}", {}); }
function saveCart(obj){ localStorage.setItem(LS_CART, JSON.stringify(obj)); }

function loadReceived(){ return Number(localStorage.getItem(LS_REC) || "0") || 0; }
function saveReceived(n){ localStorage.setItem(LS_REC, String(n||0)); }

function normalizeCat(c){
  c = (c||"").trim();
  if(!c) return "ê¸°íƒ€";
  return c;
}

function normalizeId(id){
  return (id||"").trim();
}

/* âœ… price: "5,000.00" / "5000" / 5000 ë‹¤ ì²˜ë¦¬ */
function parsePrice(v){
  if(v == null) return 0;
  if(typeof v === "number") return v;
  const s = String(v).trim();
  if(!s) return 0;
  const cleaned = s.replace(/,/g,""); // ì½¤ë§ˆ ì œê±°
  const num = Number(cleaned);
  return isFinite(num) ? num : 0;
}

/* âœ… ord: ë¬¸ìì—´ì´ì–´ë„ ìˆ«ìì²˜ëŸ¼ ì •ë ¬ */
function parseOrd(v){
  const s = String(v ?? "").trim();
  if(!s) return 999999;
  // "01", "0010" ê°™ì€ ê²ƒë„ ìˆ«ìë¡œ ì •ë ¬ë˜ê²Œ
  const n = Number(s);
  if(isFinite(n)) return n;
  // í˜¹ì‹œ ë¬¸ì ì„ì´ë©´ ë’¤ë¡œ
  return 999999;
}

/* =========================
   ì´ˆì„± ê²€ìƒ‰
========================= */
const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
function getChosung(str){
  str = (str||"").trim();
  let out = "";
  for(const ch of str){
    const code = ch.charCodeAt(0);
    if(code >= 0xAC00 && code <= 0xD7A3){
      const idx = Math.floor((code - 0xAC00) / 588);
      out += CHO[idx] || "";
    }else{
      out += ch;
    }
  }
  return out;
}
function matchQuery(p, q){
  if(!q) return true;
  const name = (p.name||"");
  const cat = (p.cat||"");
  const id = (p.id||"");
  const q2 = q.trim();
  const t = (cat+" "+name+" "+id).toLowerCase();
  if(t.includes(q2.toLowerCase())) return true;
  // ì´ˆì„± ë§¤ì¹­
  const cho = getChosung(cat+" "+name+" "+id);
  return cho.includes(q2);
}

/* =========================
   CSV íŒŒì„œ (ì½¤ë§ˆ/ë”°ì˜´í‘œ ì•ˆì „)
========================= */
function parseCSV(text) {
  const rows = [];
  let cur = "", inQ = false;
  let row = [];
  function pushCell(){ row.push(cur); cur=""; }
  function pushRow(){ rows.push(row); row=[]; }

  for (let i=0;i<text.length;i++){
    const ch=text[i];
    if(ch === '"'){
      if(inQ && text[i+1] === '"'){ cur += '"'; i++; }
      else inQ = !inQ;
      continue;
    }
    if(ch === ',' && !inQ){ pushCell(); continue; }
    if((ch === '\n' || ch === '\r') && !inQ){
      if(ch === '\r' && text[i+1] === '\n') i++;
      pushCell(); pushRow(); continue;
    }
    cur += ch;
  }
  pushCell(); pushRow();
  // ë¹ˆ ì¤„ ì œê±°
  return rows.filter(r => r.some(c => String(c||"").trim() !== ""));
}

/* =========================
   CSV ë¡œë“œ
========================= */
async function loadFromSheet(){
  const res = await fetch(CSV_URL, {cache:"no-store"});
  if(!res.ok) throw new Error("CSV ë¡œë“œ ì‹¤íŒ¨: " + res.status);
  const text = await res.text();
  const rows = parseCSV(text);
  if(rows.length < 2) throw new Error("CSV ë°ì´í„°ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.");

  const header = rows[0].map(h => String(h||"").trim().toLowerCase());
  const idx = (k)=> header.indexOf(k);

  const idI = idx("id");
  const catI = idx("cat");
  const nameI = idx("name");
  const priceI = idx("price");
  const activeI = idx("active");
  const ordI = idx("ord");

  // ìµœì†Œ ì»¬ëŸ¼ ì²´í¬
  if([idI,catI,nameI,priceI,activeI].some(v => v < 0)){
    throw new Error("ì‹œíŠ¸ í—¤ë”ê°€ í•„ìš”í•©ë‹ˆë‹¤: id, cat, name, price, active (ì˜µì…˜: ord)");
  }

  const items = [];
  for(let r=1;r<rows.length;r++){
    const row = rows[r];
    const id = normalizeId(row[idI]);
    if(!id) continue;

    const cat = normalizeCat(row[catI]);
    const name = String(row[nameI]||"").trim();
    const price = parsePrice(row[priceI]);
    const active = String(row[activeI]||"").trim() === "1" || String(row[activeI]||"").toLowerCase()==="true";
    const ord = ordI>=0 ? row[ordI] : "";

    items.push({ id, cat, name, price, active, ord });
  }

  // activeë§Œ
  const activeItems = items.filter(x => x.active);

  // ìºì‹œ ì €ì¥
  localStorage.setItem(LS_ITEMS, JSON.stringify(activeItems));
  return activeItems;
}

/* =========================
   ì¹´í…Œê³ ë¦¬/íƒ­
========================= */
function renderTabs(){
  tabsEl.innerHTML = "";

  // âœ… ì›í•˜ëŠ” ê³ ì • ìˆœì„œ
  const pri = ["ê³¼ì¼","ì•¼ì±„","ë´‰ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];

  // í˜„ì¬ ITEMSì—ì„œ ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ì¹´í…Œê³ ë¦¬
  const set = new Set(ITEMS.map(p => normalizeCat(p.cat)));

  // âœ… pri ìˆœì„œëŒ€ë¡œ, ì¡´ì¬í•˜ëŠ” ê²ƒë§Œ ë¨¼ì € / ê¸°íƒ€ëŠ” í•­ìƒ í‘œì‹œ
  const cats = [];
  for(const c of pri){
    if(set.has(c) || c==="ê¸°íƒ€") cats.push(c);
  }

  // âœ… priì— ì—†ëŠ” ì¶”ê°€ ì¹´í…Œê³ ë¦¬(í˜¹ì‹œ ìƒê¸°ë©´) ë’¤ë¡œ
  const extras = Array.from(set).filter(c => !pri.includes(c));
  extras.sort((a,b)=>a.localeCompare(b,"ko"));
  cats.push(...extras);

  // activeCat ë³´ì •
  if(!activeCat || !cats.includes(activeCat)){
    activeCat = cats.includes("ê³¼ì¼") ? "ê³¼ì¼" : (cats[0] || "ê¸°íƒ€");
  }

  cats.forEach(cat=>{
    const b = document.createElement("button");
    b.className = "tab" + (cat===activeCat ? " active" : "");
    b.textContent = cat;
    b.onclick = ()=>{
      activeCat = cat;
      renderTabs();
      renderProducts();
    };
    tabsEl.appendChild(b);
  });
}

/* =========================
   ê³ ì •/ì •ë ¬
========================= */
function isPinned(id){
  const pins = loadPins();
  return pins.includes(id);
}
function togglePin(id){
  const pins = loadPins();
  const i = pins.indexOf(id);
  if(i >= 0) pins.splice(i,1);
  else pins.push(id);
  savePins(pins);
  renderProducts();
}
function sortItems(list){
  const pins = loadPins();
  const pinSet = new Set(pins);

  return list.slice().sort((a,b)=>{
    // 1) pinned ìš°ì„ 
    const ap = pinSet.has(a.id) ? 0 : 1;
    const bp = pinSet.has(b.id) ? 0 : 1;
    if(ap !== bp) return ap - bp;

    // 2) ord (ì—†ìœ¼ë©´ ë’¤)
    const ao = parseOrd(a.ord);
    const bo = parseOrd(b.ord);
    if(ao !== bo) return ao - bo;

    // 3) ì´ë¦„
    return (a.name||"").localeCompare((b.name||""), "ko");
  });
}

/* =========================
   ì¹´ë“œ ë Œë” (ê¸¸ê²Œ ëˆŒëŸ¬ ê³ ì • / PC ë”ë¸”í´ë¦­)
========================= */
function makeCard(p){
  const card = document.createElement("div");
  card.className = "card" + (isPinned(p.id) ? " pinned" : "");

  const name = document.createElement("div");
  name.className = "name";
  name.textContent = p.name || "-";

  const price = document.createElement("div");
  price.className = "price";
  price.textContent = fmtWon(p.price);

  const meta = document.createElement("div");
  meta.className = "meta";

  const badge = document.createElement("div");
  badge.className = "badge";
  badge.textContent = p.cat;

  const pin = document.createElement("div");
  pin.className = "pinBtn";
  pin.textContent = "ğŸ“Œ";
  pin.title = "ê³ ì • í† ê¸€";

  meta.appendChild(badge);
  meta.appendChild(pin);

  card.appendChild(name);
  card.appendChild(price);
  card.appendChild(meta);

  // í´ë¦­ = ë‹´ê¸°
  card.addEventListener("click", (e)=>{
    // í•€ ë²„íŠ¼ ëˆŒë €ì„ ë• ë‹´ê¸° ë§‰ê¸°
    if(e.target === pin) return;
    addToCart(p.id, 1);
  });

  // í•€ ë²„íŠ¼ í´ë¦­
  pin.addEventListener("click", (e)=>{
    e.stopPropagation();
    togglePin(p.id);
  });

  // ê¸¸ê²Œ ëˆŒëŸ¬ ê³ ì •(ëª¨ë°”ì¼)
  let pressTimer = null;
  card.addEventListener("touchstart", ()=>{
    pressTimer = setTimeout(()=>togglePin(p.id), 450);
  }, {passive:true});
  card.addEventListener("touchend", ()=>{ if(pressTimer) clearTimeout(pressTimer); pressTimer=null; });

  // PC ë”ë¸”í´ë¦­ ê³ ì •
  card.addEventListener("dblclick", (e)=>{
    e.preventDefault();
    togglePin(p.id);
  });

  return card;
}

/* =========================
   ìƒí’ˆ ë Œë”
   âœ… ê²€ìƒ‰ì–´ ìˆìœ¼ë©´ ì „ì²´ê²€ìƒ‰
   âœ… ê²€ìƒ‰ì–´ ì—†ìœ¼ë©´ ì¹´í…Œê³ ë¦¬ë§Œ
========================= */
function renderProducts(){
  const q = (qStr || "").trim();

  // pinned ìƒë‹¨
  pinnedGridEl.innerHTML = "";
  const pins = loadPins();
  const pinItems = ITEMS.filter(p => pins.includes(p.id));
  const pinSorted = sortItems(pinItems); // pinned ë‚´ë¶€ë„ ord ë°˜ì˜
  if(pinSorted.length === 0){
    const empty = document.createElement("div");
    empty.style.color="rgba(245,247,255,.45)";
    empty.style.fontWeight="800";
    empty.textContent = "ê³ ì • ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.";
    pinnedGridEl.appendChild(empty);
  }else{
    pinSorted.forEach(p => pinnedGridEl.appendChild(makeCard(p)));
  }

  // ë¦¬ìŠ¤íŠ¸
  gridEl.innerHTML = "";
  let list = (q ? ITEMS.slice() : ITEMS.filter(p => normalizeCat(p.cat) === activeCat));
  list = list.filter(p => matchQuery(p, q));
  list = sortItems(list);

  list.forEach(p => gridEl.appendChild(makeCard(p)));
}

/* =========================
   ì´ˆì„± í‚¤íŒ¨ë“œ
========================= */
function renderChosung(){
  const chars = ["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
  chosungEl.innerHTML = "";
  chars.forEach(c=>{
    const b = document.createElement("button");
    b.className = "ch";
    b.textContent = c;
    b.onclick = ()=>{
      qEl.value = (qEl.value || "") + c;
      qStr = qEl.value;
      renderProducts();
    };
    chosungEl.appendChild(b);
  });
  const del = document.createElement("button");
  del.className = "ch del";
  del.textContent = "X";
  del.onclick = ()=>{
    qEl.value = "";
    qStr = "";
    renderProducts();
  };
  chosungEl.appendChild(del);
}

/* =========================
   ì¥ë°”êµ¬ë‹ˆ
========================= */
function getItemById(id){
  return ITEMS.find(x => x.id === id);
}
function addToCart(id, delta){
  const cart = loadCart();
  cart[id] = (cart[id] || 0) + delta;
  if(cart[id] <= 0) delete cart[id];
  saveCart(cart);
  renderCart();
}
function clearCart(){
  saveCart({});
  renderCart();
}
function cartSummary(){
  const cart = loadCart();
  let sum = 0;
  let cnt = 0;
  for(const [id, qty] of Object.entries(cart)){
    const it = getItemById(id);
    if(!it) continue;
    cnt += qty;
    sum += (it.price || 0) * qty;
  }
  return {sum, cnt};
}
function renderCart(){
  cartEl.innerHTML = "";
  const cart = loadCart();
  const ids = Object.keys(cart);

  // ë¦¬ìŠ¤íŠ¸: ord ê¸°ì¤€(ì—†ìœ¼ë©´ ì´ë¦„)
  const items = ids.map(id=>{
    const it = getItemById(id);
    return it ? {it, qty: cart[id]} : null;
  }).filter(Boolean);

  items.sort((a,b)=>{
    const ao = parseOrd(a.it.ord), bo = parseOrd(b.it.ord);
    if(ao !== bo) return ao - bo;
    return (a.it.name||"").localeCompare((b.it.name||""),"ko");
  });

  items.forEach(({it, qty})=>{
    const row = document.createElement("div");
    row.className = "cartItem";

    const left = document.createElement("div");
    left.className = "cLeft";
    const n = document.createElement("div");
    n.className = "cName";
    n.textContent = `${it.name} x${qty}`;
    const sub = document.createElement("div");
    sub.className = "cSub";
    sub.textContent = `${fmtWon(it.price)} Â· ${fmtWon(it.price * qty)}`;
    left.appendChild(n); left.appendChild(sub);

    const right = document.createElement("div");
    right.className = "cRight";
    const minus = document.createElement("button");
    minus.className = "qtyBtn";
    minus.textContent = "â€“";
    minus.onclick = ()=>addToCart(it.id, -1);

    const plus = document.createElement("button");
    plus.className = "qtyBtn";
    plus.textContent = "+";
    plus.onclick = ()=>addToCart(it.id, +1);

    const del = document.createElement("button");
    del.className = "delBtn";
    del.textContent = "Ã—";
    del.onclick = ()=>{
      const c = loadCart();
      delete c[it.id];
      saveCart(c);
      renderCart();
    };

    right.appendChild(minus);
    right.appendChild(plus);
    right.appendChild(del);

    row.appendChild(left);
    row.appendChild(right);
    cartEl.appendChild(row);
  });

  const {sum, cnt} = cartSummary();
  totalEl.textContent = fmtWon(sum);
  countEl.textContent = cnt + "ê°œ";

  // ë°›ì€ëˆ/ê±°ìŠ¤ë¦„ëˆ
  const r = loadReceived();
  receivedEl.textContent = fmtWon(r);
  changeEl.textContent = fmtWon(Math.max(0, r - sum));
}

/* =========================
   ë°›ì€ëˆ ë²„íŠ¼
========================= */
document.querySelectorAll(".mBtn[data-add]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const add = Number(btn.getAttribute("data-add") || "0");
    const r = loadReceived() + add;
    saveReceived(r);
    renderCart();
  });
});
resetReceivedBtn.addEventListener("click", ()=>{
  saveReceived(0);          // âœ… ì´ˆê¸°í™”ëŠ” ë°›ì€ëˆë§Œ
  renderCart();
});

/* =========================
   ê²°ì œì™„ë£Œ/ì¥ë°”êµ¬ë‹ˆë¹„ì›€
========================= */
clearCartBtn.addEventListener("click", ()=>{
  clearCart();
});
payDoneBtn.addEventListener("click", ()=>{
  // ê²°ì œì™„ë£Œ: ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê³  ë°›ì€ëˆë„ 0ìœ¼ë¡œ ë¦¬ì…‹
  clearCart();
  saveReceived(0);
  renderCart();
});

/* =========================
   ì •ë ¬ ë²„íŠ¼
========================= */
sortBtn.addEventListener("click", ()=>{
  // ì§€ê¸ˆì€ ê³ ì •+ordë§Œ ì‚¬ìš© (ì¶”í›„ ì˜µì…˜ ì¶”ê°€ ê°€ëŠ¥)
  sortMode = "pin+ord";
  sortBtn.textContent = "ì •ë ¬: ê³ ì • + ord";
  renderProducts();
});

/* =========================
   ê²€ìƒ‰
========================= */
qEl.addEventListener("input", ()=>{
  qStr = qEl.value || "";
  renderProducts();
});

/* =========================
   ì´ˆê¸°í™”
========================= */
async function boot(){
  renderChosung();

  // 1) ìºì‹œ ë¨¼ì €
  const cached = safeJsonParse(localStorage.getItem(LS_ITEMS) || "[]", []);
  if(Array.isArray(cached) && cached.length){
    ITEMS = cached.map(x=>({
      id: normalizeId(x.id),
      cat: normalizeCat(x.cat),
      name: String(x.name||"").trim(),
      price: parsePrice(x.price),
      active: true,
      ord: x.ord ?? ""
    }));
  }

  // 2) ê·¸ ë‹¤ìŒ ì‹œíŠ¸ ìµœì‹ 
  try{
    const fresh = await loadFromSheet();
    ITEMS = fresh.map(x=>({
      id: normalizeId(x.id),
      cat: normalizeCat(x.cat),
      name: String(x.name||"").trim(),
      price: parsePrice(x.price),
      active: true,
      ord: x.ord ?? ""
    }));
  }catch(e){
    console.warn(e);
    // ì‹œíŠ¸ ì‹¤íŒ¨í•´ë„ ìºì‹œë¡œ ë™ì‘
  }

  // activeCat ë³´ì •
  const cats = new Set(ITEMS.map(p=>normalizeCat(p.cat)));
  if(!cats.has("ê³¼ì¼") && cats.size){
    activeCat = Array.from(cats)[0];
  }else{
    activeCat = "ê³¼ì¼";
  }

  renderTabs();
  renderProducts();
  renderCart();
}

boot();
</script>
</body>
</html>
